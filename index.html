<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0d47a1" />
  <title>CBC Report Form – Polished UI (Marks Editor • One‑Page Print • Save to Excel)</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js" defer></script>

  <style>
    :root {
      --accent:#0d47a1;
      --accent-hover:#1559c2;
      --muted-text:#52525b;
      --border-color:#e2e8f0;
      --bg:#f8fafc;
      --card-bg:#ffffff;
      --success:#16a34a;
      --warn:#f59e0b;
      --danger:#dc2626;
      --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      --page-w:210mm;
      --page-h:297mm;
    }

    /* Keyframe animations for a fluid feel */
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideUpIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes toastIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes toastOut { to { opacity: 0; transform: translateY(15px); } }

    /* --- Base & Reset --- */
    html, body {
      height: 100%; margin: 0; background-color: var(--bg);
      font-family: var(--font-sans); color: #1e293b; font-size: 14px; line-height: 1.4;
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
    }
    .app { max-width: 1280px; margin: 24px auto; padding: 0 24px; animation: fadeIn 0.5s ease-out; }
    * { box-sizing: border-box; }

    /* --- Toolbar & Controls --- */
    .bar {
      display: flex; flex-wrap: wrap; gap: 12px; align-items: center;
      background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(8px);
      padding: 12px 16px; border-radius: 12px;
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05), 0 2px 4px -2px rgba(0,0,0,0.05);
      border: 1px solid var(--border-color);
      position: sticky; top: 16px; z-index: 100;
    }
    .group { display: flex; gap: 10px; align-items: center; }
    .group label { font-size: 13px; color: var(--muted-text); font-weight: 500; }
    select, input[type=text], input[type=number] {
      padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 8px;
      min-width: 160px; background: var(--card-bg); font-family: var(--font-sans);
      font-size: 14px; transition: border-color 0.2s, box-shadow 0.2s;
    }
    select:focus, input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(13, 71, 161, 0.1); }
    button, a.btn {
      padding: 9px 16px; background-color: var(--accent); color: white;
      border: none; border-radius: 8px; cursor: pointer; text-decoration: none;
      display: inline-flex; align-items: center; gap: 6px; font-weight: 600; font-size: 13px;
      transition: background-color 0.2s, box-shadow 0.2s, transform 0.1s;
    }
    button:hover, a.btn:hover { background-color: var(--accent-hover); box-shadow: 0 4px 12px rgba(13, 71, 161, 0.15); }
    button:active, a.btn:active { transform: translateY(1px); }
    button.secondary, a.btn.secondary { background-color: #f1f5f9; color: #334155; border: 1px solid var(--border-color); }
    button.secondary:hover, a.btn.secondary:hover { background-color: #e2e8f0; }
    button.ghost { background: transparent; color: var(--accent); border: 1px solid #cddaf7; }
    button.ghost:hover { background: #eef4ff; }
    button:disabled, a.btn[aria-disabled="true"] { background-color: #e2e8f0; color: #94a3b8; cursor: not-allowed; box-shadow: none; transform: none; }
    button .spinner { width: 14px; height: 14px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .chip { display: inline-flex; align-items: center; gap: 6px; background: #eef4ff; color: var(--accent); border-radius: 999px; padding: 4px 10px; font-size: 12px; font-weight: 600; border: 1px solid rgba(13, 71, 161, 0.1); }

    /* File Drop Zone */
    #drop_zone { border: 2px dashed var(--border-color); border-radius: 12px; padding: 20px; text-align: center; cursor: pointer; transition: background-color 0.2s, border-color 0.2s; }
    #drop_zone.dragover { background-color: #eef4ff; border-color: var(--accent); }
    #drop_zone p { margin: 0; color: var(--muted-text); font-weight: 500; }
    #drop_zone p small { display: block; font-size: 12px; margin-top: 4px; }
    #filename { font-weight: 600; color: var(--accent); margin-top: 8px; font-size: 13px; }

    /* --- Panels & Layout --- */
    .panel {
      background: var(--card-bg); border-radius: 12px; padding: 20px; margin-top: 20px;
      border: 1px solid var(--border-color);
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.03), 0 2px 4px -2px rgba(0,0,0,0.03);
      animation: slideUpIn 0.5s ease-out forwards;
    }
    .panel h3 { margin: 0 0 16px 0; font-size: 16px; color: #0f172a; }
    .two-col { display: grid; grid-template-columns: 1fr 380px; gap: 20px; }
    .editor-grid { width: 100%; border-collapse: collapse; font-size: 14px; border-radius: 8px; overflow: hidden; border: 1px solid #eef2f7; }
    .editor-grid th, .editor-grid td { border-bottom: 1px solid #eef2f7; padding: 10px 12px; text-align: left; }
    .editor-grid th { background: #f8fafc; font-weight: 600; color: #334155; }
    .editor-grid tr:hover td { background-color: #f8fafc; }

    /* --- Status Bar --- */
    .statusbar {
      position: sticky; top: 92px; z-index: 50; background: var(--card-bg); border-radius: 10px;
      padding: 8px 16px; border: 1px solid var(--border-color); font-size: 13px; margin: 16px 0;
      display: flex; justify-content: space-between; align-items: center; animation: slideUpIn 0.4s ease-out forwards;
    }
    .statusbar .left { color: var(--accent); font-weight: 600; }
    .statusbar.ok { background: #f0fdf4; border-color: #bbf7d0; color: #166534; }
    .statusbar.warn { background: #fffbeb; border-color: #fde68a; color: #854d0e; }
    .statusbar.err { background: #fef2f2; border-color: #fecaca; color: #991b1b; }

    /* --- Improved Sheet Preview --- */
    #singleView .sheet {
      width: 100%; min-height: 420px; background: #fff; padding: 20px; border-radius: 10px;
      border: 1px solid var(--border-color);
      box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05), 0 4px 6px -4px rgba(0,0,0,0.05);
      overflow: hidden;
    }
    .school-head { text-align: center; line-height: 1.1; margin-bottom: 8px; }
    .school-head h1 { margin: 0; font-size: 20px; font-weight: 700; letter-spacing: .5px; }
    .school-head .addr { font-size: 12px; color: #475569; }
    .school-head .motto { margin-top: 4px; font-weight: 700; color: var(--accent); font-size: 13px; }
    .key { font-size: 11px; color: #475569; text-align: center; margin: 8px 0; }
    .title { text-align: center; font-weight: 700; margin: 8px 0 14px; font-size: 14px; text-transform: uppercase; }
    .meta { display: grid; grid-template-columns: 1fr 1fr; gap: 8px 14px; border: 1px solid var(--border-color); padding: 10px; border-radius: 8px; font-size: 12px; margin-bottom: 12px; }
    .meta div { display: flex; gap: 8px; align-items: center; }
    .meta label { font-weight: 700; min-width: 110px; color: #1e293b; }

    /* --- Report Table (Compact & Print-Friendly) --- */
    table.report { width: 100%; border-collapse: collapse; font-size: 11px; table-layout: fixed; }
    table.report th, table.report td { border: 1px solid #333; padding: 6px; text-align: center; word-break: break-word; }
    table.report th { background-color: #f1f5f9; font-weight: 700; }
    table.report td.label { text-align: left; padding-left: 8px; font-weight: 600; color: #0f172a; }
    table.report tfoot th { background-color: #f8fafc; }

    /* --- Mini Chart --- */
    .mini-chart-wrap { margin: 12px 0 0; }
    .mini-chart { height: 50px; display: flex; gap: 8px; align-items: flex-end; justify-content: center; }
    .chart-bar { width: 12px; border-radius: 4px; display: inline-block; transition: height 0.3s ease-out; }
    .chart-bar.opener { background: linear-gradient(to top, #4285f4, #6aa2f8); border: 1px solid #4285f4; }
    .chart-bar.mid { background: linear-gradient(to top, #0f9d58, #34a853); border: 1px solid #0f9d58; }
    .chart-bar.end { background: linear-gradient(to top, #db4437, #ea6a5f); border: 1px solid #db4437; }
    .chart-labels { display: flex; gap: 8px; justify-content: center; margin-top: 6px; font-size: 11px; color: var(--muted-text); }

    /* --- Comments & Footer --- */
    .comments { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; font-size: 12px; }
    .comments .block { border: 1px solid var(--border-color); padding: 8px; border-radius: 8px; min-height: 64px; background: #fff; }
    .sign-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 8px; }
    .sign { border: 1px solid var(--border-color); padding: 8px; border-radius: 8px; min-height: 40px; background: #fff; }
    .foot-dates { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; font-size: 12px; }
    .small { color: var(--muted-text); font-size: 11px; margin-top: 8px; }

    /* --- Toasts & Dialogs --- */
    .toasts { position: fixed; right: 20px; bottom: 20px; display: flex; flex-direction: column; gap: 12px; z-index: 9999; }
    .toast {
      background: #27272a; color: white; padding: 12px 16px; border-radius: 8px;
      box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.1);
      font-size: 14px; display: flex; align-items: center; gap: 8px; font-weight: 500;
      animation: toastIn 0.4s ease-out;
    }
    .toast.exiting { animation: toastOut 0.4s ease-in forwards; }
    .toast.success { background-color: var(--success); }
    .toast.error { background-color: var(--danger); }
    .toast.warn { background-color: var(--warn); color: #1e293b; }

    dialog { border-radius: 12px; padding: 0; border: 1px solid var(--border-color); box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); max-width: 740px; width: 90%; }
    dialog::backdrop { background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); }
    dialog[open] { animation: slideUpIn 0.4s ease-out; }
    .dlg-hd { padding: 16px 20px; font-weight: 700; font-size: 16px; border-bottom: 1px solid var(--border-color); }
    .dlg-bd { padding: 20px; line-height: 1.6; }
    .dlg-ft { padding: 12px 20px; display: flex; gap: 10px; justify-content: flex-end; border-top: 1px solid var(--border-color); background: #f8fafc; }
    #errorDlg .dlg-hd { background: #fef2f2; color: var(--danger); }
    #confirmDlg .dlg-hd { background: #fffbeb; color: #854d0e; }
    pre.err { background: #f8fafc; border: 1px solid var(--border-color); padding: 12px; max-height: 240px; overflow: auto; border-radius: 6px; font-size: 13px; }

    /* --- Responsive & Print --- */
    @media (max-width: 960px) {
      .app { padding: 0 16px; margin: 16px auto; }
      .two-col { grid-template-columns: 1fr; }
      .bar { flex-direction: column; align-items: stretch; top: 0; border-radius: 0; }
      .statusbar { top: 180px; }
      #singleView .sheet { padding: 12px; }
    }
    @media print {
      @page { size: A4 portrait; margin: 10mm; }
      html, body { height: auto !important; background: #fff; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      .bar, .panel, .statusbar, .toasts, #singleView { display: none !important; }
      #batchContainer { display: block !important; }
      .sheet {
        width: 100%; margin: 0; padding: 8mm; border: none; border-radius: 0; box-shadow: none;
        page-break-after: always; box-sizing: border-box; overflow: visible;
      }
      .school-head h1 { font-size: 18px; }
      .title { font-size: 13px; }
      table.report { font-size: 10px; }
      table.report th, table.report td { padding: 4px; border-color: #000; }
      .meta { font-size: 11px; padding: 6px; }
      .comments .block { min-height: 48px; padding: 6px; }
      .mini-chart { height: 40px; }
      .small { font-size: 10px; }
      .report { table-layout: fixed; word-wrap: break-word; }
    }
  </style>
</head>
<body>
<div class="app">
  <div class="bar" role="toolbar" aria-label="Main toolbar">
    <div class="group" style="flex: 1;">
      <div id="drop_zone">
        <input type="file" id="file" accept=".xlsx,.xls" hidden />
        <p>Drag & Drop Workbook (.xlsx) here, or click to select</p>
        <p><small>All processing is done locally in your browser. No data is uploaded.</small></p>
        <div id="filename"></div>
      </div>
    </div>
    <div class="group">
      <button id="printSelectedBtn" disabled class="ghost">Print Selected</button>
      <button id="printFilteredBtn" disabled class="ghost">Batch Print</button>
    </div>
    <div class="group">
      <a id="downloadExcelLink" class="btn secondary" aria-disabled="true">Download Updated Excel</a>
      <span class="chip" id="unsavedChip" style="display:none">Unsaved</span>
    </div>
  </div>

  <div id="statusBar" class="statusbar" aria-live="polite" style="display:none;">
    <div class="left">Ready</div>
    <div class="right muted" id="statusDetails">Load a workbook to begin.</div>
  </div>

  <div id="mainContent" style="display:none;">
    <div class="panel" id="filtersPanel">
      <h3>Filters</h3>
      <div style="display:flex; gap:16px; flex-wrap:wrap; align-items:center;">
        <div class="group"><label for="learnerSel">Learner:</label><select id="learnerSel"></select></div>
        <div class="group"><label for="fGender">Gender:</label><select id="fGender"><option value="">All</option><option>M</option><option>F</option></select></div>
        <div class="group"><label for="fGrade">Grade:</label><select id="fGrade"><option value="">All</option></select></div>
        <div class="group">
          <button id="applyFiltersBtn" class="secondary">Apply</button>
          <button id="clearFiltersBtn" class="secondary">Clear</button>
          <span class="muted" id="matchCountChip">0 selected</span>
        </div>
      </div>
    </div>

    <div class="panel" id="editorPanel">
      <h3>Edit Marks <small class="muted">(writes back to Learners sheet)</small></h3>
      <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:16px;">
        <div class="group"><label for="phaseSel">Phase:</label>
          <select id="phaseSel"><option value="Opener">Opener</option><option value="Mid">Midterm</option><option value="End">End term</option></select>
        </div>
        <div class="group">
          <button id="savePhaseBtn">Save to Learner</button>
          <button id="applyOutOfAllBtn" class="secondary">Apply 'Out Of' to ALL</button>
        </div>
      </div>

      <div class="two-col">
        <div>
          <table class="editor-grid" id="marksGrid" aria-label="Marks editor">
            <thead><tr><th>Learning Area</th><th style="width:140px">Score</th><th style="width:140px">Out Of</th></tr></thead>
            <tbody id="marksBody"></tbody>
          </table>
        </div>
        <div>
          <h4 style="margin:0 0 8px; font-size:15px;">Live Preview</h4>
          <div id="singleView"><div class="sheet" id="singleSheet" aria-label="Report Form Preview"></div></div>
        </div>
      </div>
    </div>
  </div>

  <div id="batchContainer" aria-hidden="true" style="display:none"></div>
</div>

<div class="toasts" id="toasts" aria-live="polite" aria-atomic="true"></div>

<dialog id="errorDlg">
  <div class="dlg-hd">An Error Occurred</div>
  <div class="dlg-bd">
    <p>We encountered a problem while processing your request. Please see the details below.</p>
    <pre class="err" id="errDetails"></pre>
  </div>
  <div class="dlg-ft">
    <button id="copyErrBtn" class="secondary">Copy Details</button>
    <button id="closeErrBtn">Close</button>
  </div>
</dialog>

<dialog id="confirmDlg">
  <div class="dlg-hd">Confirm Action</div>
  <div class="dlg-bd" id="confirmMsg"></div>
  <div class="dlg-ft">
    <button id="confirmCancelBtn" class="secondary">Cancel</button>
    <button id="confirmOkBtn" class="warn">Confirm</button>
  </div>
</dialog>

<script>
(function() {
  "use strict";

  // --- Configuration ---
  const SUBJECTS = [
    { key:'ENG',     label:'ENGLISH' },
    { key:'COMP',    label:'COMPOSITION' },
    { key:'KISW',    label:'KISWAHILI' },
    { key:'INSHA',   label:'INSHA' },
    { key:'MATH',    label:'MATHEMATICS' },
    { key:'SCIE',    label:'INTER/SCIE' },
    { key:'SST',     label:'S/S' },
    { key:'CRE',     label:'CRE' },
    { key:'AGRI',    label:'AGRI/NUT' },
    { key:'CA',      label:'C/ART' },
    { key:'PRETECH', label:'PRE-TECH' },
  ];
  const MARK_KEYS = SUBJECTS.flatMap(s => [
    `${s.key}_Opener`, `${s.key}_Opener_OutOf`,
    `${s.key}_Mid`,    `${s.key}_Mid_OutOf`,
    `${s.key}_End`,    `${s.key}_End_OutOf`
  ]);
  const DEFAULT_THRESHOLDS = [{min:81,grade:'EE'},{min:50,grade:'ME'},{min:26,grade:'AE'},{min:0,grade:'BE'}];

  // --- DOM References ---
  const $ = sel => document.querySelector(sel);
  const $$ = sel => document.querySelectorAll(sel);
  
  // Toolbar & File
  const $dropZone = $('#drop_zone');
  const $fileInput = $('#file');
  const $filename = $('#filename');
  const $printSelectedBtn = $('#printSelectedBtn');
  const $printFilteredBtn = $('#printFilteredBtn');
  const $downloadExcelLink = $('#downloadExcelLink');
  const $unsavedChip = $('#unsavedChip');

  // Main UI
  const $statusBar = $('#statusBar');
  const $statusLeft = $('#statusBar .left');
  const $statusDetails = $('#statusBar .right');
  const $mainContent = $('#mainContent');

  // Filters
  const $learnerSel = $('#learnerSel');
  const $fGender = $('#fGender');
  const $fGrade = $('#fGrade');
  const $applyFiltersBtn = $('#applyFiltersBtn');
  const $clearFiltersBtn = $('#clearFiltersBtn');
  const $matchCountChip = $('#matchCountChip');

  // Editor
  const $phaseSel = $('#phaseSel');
  const $marksBody = $('#marksBody');
  const $savePhaseBtn = $('#savePhaseBtn');
  const $applyOutOfAllBtn = $('#applyOutOfAllBtn');
  const $singleSheet = $('#singleSheet');
  const $batchContainer = $('#batchContainer');

  // Dialogs & Toasts
  const $toasts = $('#toasts');
  const $errorDlg = $('#errorDlg');
  const $errDetails = $('#errDetails');
  const $confirmDlg = $('#confirmDlg');
  const $confirmMsg = $('#confirmMsg');

  // --- Application State ---
  let learners = [];
  let originalLearnersSnapshot = [];
  let thresholds = DEFAULT_THRESHOLDS;
  let filteredLearners = [];
  let originalWb = null;
  let headerIndexMap = {};
  let unsavedChanges = false;

  // Persisted sheet visual properties for high-fidelity saving
  let learnersSheetName = null;
  let learnersSheetCols = null;
  let learnersSheetRows = null;
  let learnersSheetMerges = null;
  let originalWorkbookViews = null;
  let originalWorkbookProps = null;
  let sheetSavedViews = null;

  // --- UI & Utility Helpers ---
  
  /** Shows a status message in the status bar */
  function setStatus(msg, type = 'ok', details = '') {
    $statusBar.style.display = 'flex';
    $statusBar.className = `statusbar ${type}`;
    $statusLeft.textContent = msg;
    $statusDetails.textContent = details;
  }
  
  /** Displays a toast notification */
  function toast(msg, type = 'success', timeout = 2500) {
    const el = document.createElement('div');
    el.className = `toast ${type}`;
    el.textContent = msg;
    $toasts.appendChild(el);
    setTimeout(() => {
      el.classList.add('exiting');
      el.addEventListener('animationend', () => el.remove());
    }, timeout);
  }

  /** Wraps a function in robust error handling UI */
  function withErrorUI(fn) {
    return async (...args) => {
      try {
        return await fn(...args);
      } catch (err) {
        console.error(err);
        const details = `Message: ${err?.message || err}\n\nStack:\n${err?.stack || '(no stack)'}`;
        $errDetails.textContent = details;
        $errorDlg.showModal();
        setStatus('Action failed', 'err', err.message);
        toast('Something went wrong', 'error');
      }
    };
  }
  
  /** Shows a confirmation dialog */
  function confirmAction(message) {
    return new Promise(resolve => {
      $confirmMsg.textContent = message;
      $confirmDlg.showModal();
      const onConfirm = () => { cleanup(); resolve(true); };
      const onCancel = () => { cleanup(); resolve(false); };
      const cleanup = () => {
        $('#confirmOkBtn').removeEventListener('click', onConfirm);
        $('#confirmCancelBtn').removeEventListener('click', onCancel);
        $confirmDlg.close();
      };
      $('#confirmOkBtn').addEventListener('click', onConfirm, { once: true });
      $('#confirmCancelBtn').addEventListener('click', onCancel, { once: true });
    });
  }

  /** Toggles the loading state of a button */
  function setButtonLoading(button, isLoading) {
    if (isLoading) {
      button.disabled = true;
      button.dataset.originalText = button.innerHTML;
      button.innerHTML = `<span class="spinner"></span> Loading...`;
    } else {
      button.disabled = false;
      button.innerHTML = button.dataset.originalText || 'Action';
    }
  }

  /** Updates the unsaved changes indicator */
  function showUnsaved(flag) {
    unsavedChanges = flag;
    $unsavedChip.style.display = flag ? 'inline-flex' : 'none';
    $downloadExcelLink.setAttribute('aria-disabled', !flag);
  }
  
  // --- Core Logic Helpers ---
  const getIndex = (row) => Number(row.Index ?? row.index ?? row.INDEX);
  const pctGrade = (score, outOf) => {
    if (outOf <= 0 || score === null || score === '') return { pct: 0, grade: 'BE' };
    const pct = Math.max(0, Math.round((Number(score) / Number(outOf)) * 100));
    const t = thresholds.find(t => pct >= t.min) || { grade: 'BE' };
    return { pct, grade: t.grade };
  };
  const escapeHTML = (s) => String(s ?? '').replace(/[&<>"']/g, (c) => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" }[c]));
  const termWord = (n) => ({ 1: 'ONE', 2: 'TWO', 3: 'THREE' }[n] || String(n));

  // --- HTML Generation ---

  /** Generates the performance bar chart HTML */
  function htmlChartTotals(oSc, mSc, eSc) {
    const maxVal = Math.max(oSc, mSc, eSc, 1);
    const h = (v) => Math.max(6, Math.round((v / maxVal) * 48)); // height in px
    return `<div class="mini-chart-wrap" aria-hidden="true">
      <div class="mini-chart" role="img" aria-label="Performance overview chart">
        <span class="chart-bar opener" style="height:${h(oSc)}px" title="Opener Total: ${oSc}"></span>
        <span class="chart-bar mid" style="height:${h(mSc)}px" title="Midterm Total: ${mSc}"></span>
        <span class="chart-bar end" style="height:${h(eSc)}px" title="End term Total: ${eSc}"></span>
      </div>
      <div class="chart-labels"><span>Opener</span><span>Mid</span><span>End</span></div>
    </div>`;
  }

  /** Generates the full HTML for a single report form */
  function htmlReport(row) {
    const school = { name: 'ITIATI JUNIOR SCHOOL', address1: 'P.O. BOX 160-10101', town: 'KARATINA', motto: 'HARDWORK FOR EXCELLENCE' };
    const pupilName = row["Pupil's Name"] || row["Pupil Name"] || ''; const grade = row["Grade"] ?? ''; const term = row["Term"] ?? ''; const year = row["Year"] ?? '';
    const ctComment = row["Class_Teacher_Comment"] || ''; const ctName = row["Class_Teacher_Name"] || ''; const ctDate = row["CT_Date"] || '';
    const htComment = row["Head_Teacher_Comment"] || ''; const htSign = row["Head_Teacher_Signature"] || row["Head_Teacher_Sign"] || ''; const htDate = row["HT_Date"] || '';
    const closingDate = row["Closing_Date"] || row["Closing Date"] || ''; const openingDate = row["Opening_Date"] || row["Opening Date"] || '';
    
    const subRows = SUBJECTS.map(s => {
      const oSc = Number(row[`${s.key}_Opener`]) || 0, oMax = Number(row[`${s.key}_Opener_OutOf`]) || 0;
      const mSc = Number(row[`${s.key}_Mid`]) || 0, mMax = Number(row[`${s.key}_Mid_OutOf`]) || 0;
      const eSc = Number(row[`${s.key}_End`]) || 0, eMax = Number(row[`${s.key}_End_OutOf`]) || 0;
      const oG = pctGrade(oSc, oMax).grade, mG = pctGrade(mSc, mMax).grade, eG = pctGrade(eSc, eMax).grade;
      return { label: s.label, oSc, oMax, oG, mSc, mMax, mG, eSc, eMax, eG };
    });
    const total = subRows.reduce((a, r) => { a.oSc += r.oSc; a.oMax += r.oMax; a.mSc += r.mSc; a.mMax += r.mMax; a.eSc += r.eSc; a.eMax += r.eMax; return a; }, { oSc: 0, oMax: 0, mSc: 0, mMax: 0, eSc: 0, eMax: 0 });
    const oG = pctGrade(total.oSc, total.oMax).grade, mG = pctGrade(total.mSc, total.mMax).grade, eG = pctGrade(total.eSc, total.eMax).grade;
    const title = `END TERM ${termWord(Number(term))} ASSESSMENT - YEAR ${year}`;

    return `<div class="school-head">
        <h1>${escapeHTML(school.name)}</h1>
        <div class="addr">${escapeHTML(school.address1)} • ${escapeHTML(school.town)}</div>
        <div class="motto">${escapeHTML(school.motto)}</div>
      </div>
      <div class="key">KEY: <b>EE</b>–Exceed, <b>ME</b>–Meet, <b>AE</b>–Approach, <b>BE</b>–Below Expectation</div>
      <div class="title">${escapeHTML(title)}</div>
      <div class="meta">
        <div><label>PUPIL'S NAME:</label><div>${escapeHTML(pupilName)}</div></div>
        <div><label>GRADE:</label><div>${escapeHTML(String(grade))}</div></div>
      </div>
      <table class="report" role="table" aria-label="Learner report">
        <thead>
          <tr><th rowspan="2">LEARNING AREA</th><th colspan="3">OPENER</th><th colspan="3">MIDTERM</th><th colspan="3">END TERM</th></tr>
          <tr><th>OUT</th><th>SCORE</th><th>GRADE</th><th>OUT</th><th>SCORE</th><th>GRADE</th><th>OUT</th><th>SCORE</th><th>GRADE</th></tr>
        </thead>
        <tbody>${subRows.map(r => `<tr><td class="label">${r.label}</td><td>${r.oMax}</td><td>${r.oSc}</td><td>${r.oG}</td><td>${r.mMax}</td><td>${r.mSc}</td><td>${r.mG}</td><td>${r.eMax}</td><td>${r.eSc}</td><td>${r.eG}</td></tr>`).join('')}</tbody>
        <tfoot><tr><th class="label">TOTAL MARK</th><th>${total.oMax}</th><th>${total.oSc}</th><th>${oG}</th><th>${total.mMax}</th><th>${total.mSc}</th><th>${mG}</th><th>${total.eMax}</th><th>${total.eSc}</th><th>${eG}</th></tr></tfoot>
      </table>
      ${htmlChartTotals(total.oSc, total.mSc, total.eSc)}
      <div class="comments">
        <div class="block"><div style="font-weight:700;margin-bottom:6px">CLASS TEACHER</div><div>${escapeHTML(ctComment) || '&nbsp;'}</div><div class="sign-row"><div class="sign"><b>Name:</b> ${escapeHTML(ctName) || '&nbsp;'}</div><div class="sign"><b>Date:</b> ${escapeHTML(ctDate) || '&nbsp;'}</div></div></div>
        <div class="block"><div style="font-weight:700;margin-bottom:6px">HEAD TEACHER</div><div>${escapeHTML(htComment) || '&nbsp;'}</div><div class="sign-row"><div class="sign"><b>Signature:</b> ${escapeHTML(htSign) || '&nbsp;'}</div><div class="sign"><b>Date:</b> ${escapeHTML(htDate) || '&nbsp;'}</div></div></div>
      </div>
      <div class="foot-dates"><div class="sign"><b>CLOSING DATE:</b> ${escapeHTML(closingDate) || '&nbsp;'}</div><div class="sign"><b>OPENING DATE:</b> ${escapeHTML(openingDate) || '&nbsp;'}</div></div>
      <div class="small">This report is designed to fit on a single A4 page when printed at 100% scale.</div>`;
  }

  // --- UI Update Functions ---
  
  function resetUI() {
    $mainContent.style.display = 'none';
    $statusBar.style.display = 'none';
    $filename.textContent = '';
    learners = [];
    originalLearnersSnapshot = [];
    filteredLearners = [];
    originalWb = null;
    showUnsaved(false);
    $$('button, a.btn, select').forEach(el => el.disabled = true);
    $dropZone.querySelector('p').style.display = 'block';
    $fileInput.value = '';
  }

  function hydrateGrades() {
    const grades = [...new Set(learners.map(r => String(r.Grade || '').trim()).filter(Boolean))].sort();
    $fGrade.innerHTML = '<option value="">All</option>' + grades.map(g => `<option>${g}</option>`).join('');
  }
  
  function applyFilters() {
    const gender = ($fGender.value || '').trim().toUpperCase();
    const grade = ($fGrade.value || '').trim();
    filteredLearners = learners.filter(r => {
      if (gender && String(r.Gender || '').trim().toUpperCase() !== gender) return false;
      if (grade && String(r.Grade || '').trim() !== grade) return false;
      return true;
    }).sort((a, b) => getIndex(a) - getIndex(b));
    hydrateLearnerDropdown();
    if (filteredLearners.length) {
      $learnerSel.selectedIndex = 1; // Select first learner
      renderSelected(0);
    } else {
      $singleSheet.innerHTML = '<p style="text-align:center;padding:2rem;">No learners match the selected filters.</p>';
      $marksBody.innerHTML = '';
    }
  }

  function clearFilters() {
    $fGender.value = '';
    $fGrade.value = '';
    applyFilters();
  }
  
  function hydrateLearnerDropdown() {
    $learnerSel.innerHTML = '<option value="">— Select a learner to view or edit —</option>' + filteredLearners.map((r, i) => {
      const idx = getIndex(r);
      const labelIdx = Number.isNaN(idx) ? `(${i + 1})` : idx;
      const name = r["Pupil's Name"] || `Learner ${i + 1}`;
      return `<option value="${i}">${labelIdx}. ${escapeHTML(name)}</option>`;
    }).join('');
    const hasLearners = learners.length > 0;
    $$('button, a.btn, select').forEach(el => { if(el.id !== 'file') el.disabled = !hasLearners });
    showUnsaved(unsavedChanges); // Re-apply disabled state to download link
    $matchCountChip.textContent = `${filteredLearners.length} selected`;
  }

  function renderSelected(index) {
    const row = filteredLearners[index];
    if (!row) return;
    $singleSheet.innerHTML = `<div class="sheet">${htmlReport(row)}</div>`;
    buildMarksGrid(row);
  }

  function buildMarksGrid(row) {
    const phase = $phaseSel.value;
    $marksBody.innerHTML = SUBJECTS.map(s => {
      const score = row[`${s.key}_${phase}`] ?? '';
      const outOf = row[`${s.key}_${phase}_OutOf`] ?? '';
      return `<tr data-key="${s.key}"><td>${s.label}</td><td><input type="number" step="0.01" class="score" value="${score}"></td><td><input type="number" step="0.01" class="outof" value="${outOf}"></td></tr>`;
    }).join('');
  }
  
  const currentSelectedRow = () => {
    const idx = Number($learnerSel.value);
    return (Number.isInteger(idx) && idx >= 0) ? filteredLearners[idx] : null;
  }
  
  // --- Data Manipulation & Actions ---

  function savePhaseToLearner() {
    const row = currentSelectedRow();
    if (!row) return;
    const phase = $phaseSel.value;
    $marksBody.querySelectorAll('tr').forEach(tr => {
      const key = tr.dataset.key;
      row[`${key}_${phase}`] = Number(tr.querySelector('input.score').value || 0);
      row[`${key}_${phase}_OutOf`] = Number(tr.querySelector('input.outof').value || 0);
    });
    showUnsaved(true);
    renderSelected(Number($learnerSel.value));
    toast(`Saved marks for ${phase} phase ✓`, 'success');
    setStatus('Marks saved', 'ok');
  }

  async function applyOutOfToAllLearners() {
      const confirmed = await confirmAction("This will apply the 'Out Of' values from the currently displayed learner to ALL learners in the workbook for this phase. This action cannot be undone. Are you sure you want to proceed?");
      if (!confirmed) return;

      const phase = $phaseSel.value;
      const template = {};
      $marksBody.querySelectorAll('tr').forEach(tr => {
        const key = tr.dataset.key;
        const outOf = tr.querySelector('input.outof').value;
        if (outOf !== '' && !Number.isNaN(Number(outOf))) template[key] = Number(outOf);
      });
      if (!Object.keys(template).length) return;
      learners.forEach(r => {
        for (const k in template) { r[`${k}_${phase}_OutOf`] = template[k]; }
      });
      showUnsaved(true);
      if (currentSelectedRow()) renderSelected(Number($learnerSel.value));
      toast("'Out Of' values applied to ALL learners ✓", 'success');
      setStatus("Applied 'Out Of' to all", 'ok');
  }

  // --- Printing ---
  function printRows(rows) {
    if (!rows || !rows.length) return;
    $batchContainer.innerHTML = rows.map(r => `<div class='sheet'>${htmlReport(r)}</div>`).join('');
    // Use requestAnimationFrame to ensure the DOM is updated before printing
    requestAnimationFrame(() => {
      window.print();
    });
    toast('Opening print dialog…', 'warn', 1800);
    setStatus('Printing…', 'warn');
  }
  
  // --- Excel File Handling (High Fidelity) ---

  /**
   * Updates the in-memory workbook object with changes from the `learners` array.
   * This function is carefully designed to preserve the original cell styles and formatting.
   */
  function updateMarksInPlace() {
    const ws = originalWb.Sheets[learnersSheetName];
    if (!ws) throw new Error(`Could not find the worksheet named '${learnersSheetName}'.`);
    
    // Find the original row number for a given learner index.
    // This is crucial if the sheet is not sorted by index.
    const getRowNumByIndex = (index) => {
        const learner = originalLearnersSnapshot.find(l => getIndex(l) == index);
        return learner ? learner._rowNumber : -1;
    }

    learners.forEach(currentLearner => {
      const learnerIndex = getIndex(currentLearner);
      const rowNum = getRowNumByIndex(learnerIndex);
      if (rowNum === -1) return; // Skip if we can't find the original row

      MARK_KEYS.forEach(key => {
        const c = headerIndexMap[key];
        if (c === undefined) return;

        const originalValue = originalLearnersSnapshot.find(l => getIndex(l) === learnerIndex)?.[key];
        const currentValue = currentLearner[key];

        // Only update if the value has actually changed
        if (currentValue === originalValue) return;

        const addr = XLSX.utils.encode_cell({ r: rowNum, c });
        const val = currentValue ?? '';

        if (ws[addr]) {
            // Cell exists, just update its value and type
            ws[addr].v = val;
            ws[addr].t = (typeof val === 'number') ? 'n' : 's';
        } else {
            // Cell does not exist, create it.
            // We clone the style from the header cell in the same column to maintain formatting.
            const headerAddr = XLSX.utils.encode_cell({r: 0, c});
            const headerCell = ws[headerAddr];
            ws[addr] = { v: val, t: (typeof val === 'number') ? 'n' : 's' };
            if(headerCell && headerCell.s) {
                ws[addr].s = JSON.parse(JSON.stringify(headerCell.s));
            }
        }
      });
    });
  }

  /**
   * Generates and triggers the download of the updated .xlsx file.
   * Re-applies all captured visual properties to ensure the output file
   * is identical to the input file, apart from the data changes.
   */
  function downloadUpdatedWorkbook() {
    if (!originalWb) return;
    setStatus('Generating Excel file...', 'warn');

    updateMarksInPlace();

    const ws = originalWb.Sheets[learnersSheetName];
    if (!ws) throw new Error('Learners worksheet missing at write time.');

    // --- FIDELITY PRESERVATION ---
    // Re-apply all visual sheet properties we captured at load time.
    // This is the key to maintaining the original look and feel of the sheet.
    if (learnersSheetCols) ws['!cols'] = JSON.parse(JSON.stringify(learnersSheetCols));
    if (learnersSheetRows) ws['!rows'] = JSON.parse(JSON.stringify(learnersSheetRows));
    if (learnersSheetMerges) ws['!merges'] = JSON.parse(JSON.stringify(learnersSheetMerges));
    if (sheetSavedViews) ws['!views'] = JSON.parse(JSON.stringify(sheetSavedViews));

    // Re-apply workbook-level properties like active sheet view.
    if (originalWorkbookViews) {
      originalWb.Workbook = originalWb.Workbook || {};
      originalWb.Workbook.Views = JSON.parse(JSON.stringify(originalWorkbookViews));
    }
    if (originalWorkbookProps) {
      originalWb.Props = JSON.parse(JSON.stringify(originalWorkbookProps));
    }
    // --- END FIDELITY PRESERVATION ---

    const writeOpts = { bookType: 'xlsx', type: 'array', bookSST: true, cellStyles: true };
    const wbout = XLSX.write(originalWb, writeOpts);
    const blob = new Blob([wbout], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
    const filename = `REPORT_FORM_updated_${new Date().toISOString().slice(0, 10)}.xlsx`;
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = filename;
    document.body.appendChild(a); a.click();
    setTimeout(() => { URL.revokeObjectURL(url); a.remove(); }, 500);

    showUnsaved(false);
    toast('Downloaded updated Excel file', 'success');
    setStatus('Download complete ✓', 'ok');
  }
  
  // --- File Loading & Initialization ---
  const processFile = withErrorUI(async (file) => {
    if (!file) return;
    resetUI();
    setStatus('Reading file...', 'warn', file.name);

    const data = await file.arrayBuffer();

    // Read the workbook, preserving styles, shared strings, and other metadata
    const wb = XLSX.read(data, { type: 'array', cellStyles: true, bookSST: true });
    originalWb = wb;

    // --- CAPTURE VISUAL METADATA FOR FIDELITY ---
    originalWorkbookViews = wb.Workbook?.Views ? JSON.parse(JSON.stringify(wb.Workbook.Views)) : null;
    originalWorkbookProps = wb.Props ? JSON.parse(JSON.stringify(wb.Props)) : null;

    learnersSheetName = wb.SheetNames.find(n => n.toLowerCase() === 'learners') || wb.SheetNames[0];
    const wsLearners = wb.Sheets[learnersSheetName];
    if (!wsLearners) throw new Error("A worksheet named 'Learners' was not found.");

    learnersSheetCols = wsLearners['!cols'] ? JSON.parse(JSON.stringify(wsLearners['!cols'])) : null;
    learnersSheetRows = wsLearners['!rows'] ? JSON.parse(JSON.stringify(wsLearners['!rows'])) : null;
    learnersSheetMerges = wsLearners['!merges'] ? JSON.parse(JSON.stringify(wsLearners['!merges'])) : null;
    sheetSavedViews = wsLearners['!views'] ? JSON.parse(JSON.stringify(wsLearners['!views'])) : null;
    // --- END METADATA CAPTURE ---

    const headerRows = XLSX.utils.sheet_to_json(wsLearners, { header: 1, defval: '' });
    const learnerHeaders = headerRows?.[0] || [];
    headerIndexMap = {};
    learnerHeaders.forEach((h, i) => { headerIndexMap[String(h)] = i; });

    learners = XLSX.utils.sheet_to_json(wsLearners, { defval: '' });
    
    // Store the original row number with each learner object for accurate write-back
    learners.forEach((learner, index) => {
        learner._rowNumber = index + 1; // +1 because sheet_to_json skips header
    });
    originalLearnersSnapshot = learners.map(o => ({...o}));

    const wsGrading = wb.Sheets['Grading'] || wb.Sheets['grading'];
    if (wsGrading) {
        try {
            const gradingRows = XLSX.utils.sheet_to_json(wsGrading, { defval: '' });
            const mappedThresholds = gradingRows
                .map(r => ({ min: Number(r.Score), grade: String(r.Grade || r.grade || '').trim() }))
                .filter(r => !Number.isNaN(r.min) && r.grade);
            if (mappedThresholds.length >= 2) {
                thresholds = mappedThresholds.sort((a, b) => b.min - a.min);
            }
        } catch (e) {
            console.warn("Could not parse 'Grading' sheet, using defaults.", e);
            thresholds = DEFAULT_THRESHOLDS;
        }
    } else {
        thresholds = DEFAULT_THRESHOLDS;
    }

    $mainContent.style.display = 'block';
    $dropZone.querySelector('p').style.display = 'none';
    $filename.textContent = file.name;

    hydrateGrades();
    clearFilters(); // This also populates the learner dropdown and renders the first one
    showUnsaved(false);

    toast('Workbook loaded successfully', 'success');
    setStatus(`Loaded ${learners.length} learners ✓`, 'Ready to edit or print.');
  });
  
  // --- Event Wiring ---
  function setupEventListeners() {
    // File Drop Zone
    $dropZone.addEventListener('click', () => $fileInput.click());
    $fileInput.addEventListener('change', (e) => processFile(e.target.files?.[0]));
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      $dropZone.addEventListener(eventName, e => { e.preventDefault(); e.stopPropagation(); });
    });
    $dropZone.addEventListener('dragenter', () => $dropZone.classList.add('dragover'));
    $dropZone.addEventListener('dragover', () => $dropZone.classList.add('dragover'));
    $dropZone.addEventListener('dragleave', () => $dropZone.classList.remove('dragover'));
    $dropZone.addEventListener('drop', (e) => {
      $dropZone.classList.remove('dragover');
      processFile(e.dataTransfer.files?.[0]);
    });

    // Main Actions
    $learnerSel.addEventListener('change', e => renderSelected(Number(e.target.value)));
    $phaseSel.addEventListener('change', () => { if (currentSelectedRow()) buildMarksGrid(currentSelectedRow()); });
    $savePhaseBtn.addEventListener('click', savePhaseToLearner);
    $applyOutOfAllBtn.addEventListener('click', applyOutOfToAllLearners);
    
    // Printing & Downloading
    $printSelectedBtn.addEventListener('click', () => { const row = currentSelectedRow(); if (row) printRows([row]); });
    $printFilteredBtn.addEventListener('click', () => printRows(filteredLearners));
    $downloadExcelLink.addEventListener('click', e => {
      if ($downloadExcelLink.getAttribute('aria-disabled') === 'true') {
        e.preventDefault();
        toast('No unsaved changes to download', 'warn');
      } else {
        downloadUpdatedWorkbook();
      }
    });

    // Filters
    $applyFiltersBtn.addEventListener('click', applyFilters);
    $clearFiltersBtn.addEventListener('click', clearFilters);
    
    // Dialogs
    $('#copyErrBtn').addEventListener('click', async () => {
      try { await navigator.clipboard.writeText($errDetails.textContent || ''); toast('Copied!', 'success', 1000); } catch (e) { alert('Copy failed.'); }
    });
    $('#closeErrBtn').addEventListener('click', () => $errorDlg.close());

    // Window Listeners
    window.addEventListener('afterprint', () => { $batchContainer.innerHTML = ''; setStatus('Ready', 'Idle.'); });
    window.addEventListener('error', (e) => withErrorUI(() => { throw e.error; })());
    window.addEventListener('unhandledrejection', (e) => withErrorUI(() => { throw e.reason; })());
  }

  // Initialize the application
  setupEventListeners();
})();
</script>
</body>
</html>
