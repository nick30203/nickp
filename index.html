<!DOCTYPE html>
<html lang="en">
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1, viewport-fit=cover" name="viewport"/>
  <meta content="#1e40af" name="theme-color"/>
  <title>
   CBC Report Form v2 &ndash; Professional UI (Marks Editor &bull; Oneâ€‘Page Print &bull; Save to Excel)
  </title>
  <link href="https://fonts.googleapis.com" rel="preconnect"/>
  <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&amp;display=swap" rel="stylesheet"/>
  <script defer="" src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js">
  </script>
  <style>
   :root {
            /* Professional Color Palette */
            --accent: #1e40af;
            /* Deep Blue (for highlights) */
            --accent-hover: #1d4ed8;
            --primary-text: #1f2937;
            /* Dark Slate/Charcoal */
            --muted-text: #6b7280;
            /* Gray for subtle text */
            --border-color: #d1d5db;
            /* Light subtle border */
            --bg: #f3f4f6;
            /* Lighter gray background for more contrast */
            --card-bg: #ffffff;
            --success: #059669;
            --warn: #f59e0b;
            --danger: #dc2626;
            --header-bg: #eff6ff;
            /* Very light blue for table headers */
            --font-sans: 'Inter', 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            --page-w: 210mm;
            --page-h: 297mm;
        }

        /* Keyframe animations for a fluid feel */
        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideUpIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes toastIn {
            from {
                opacity: 0;
                transform: translateY(15px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes toastOut {
            to {
                opacity: 0;
                transform: translateY(15px);
            }
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* --- Base & Reset --- */
        html {
            scroll-behavior: smooth;
        }

        body {
            margin: 0;
            background-color: var(--bg);
            font-family: var(--font-sans);
            color: var(--primary-text);
            font-size: 14px;
            line-height: 1.4;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        * {
            box-sizing: border-box;
        }

        /* --- [V2] NEW: Semantic Layout Containers --- */
        .page-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 24px;
            animation: fadeIn 0.5s ease-out;
        }

        .page-header {
            position: sticky;
            top: 16px;
            z-index: 100;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            padding: 12px 16px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border-color);
            display: flex;
            gap: 16px;
            align-items: center;
            flex-wrap: wrap;
        }

        main {
            padding-top: 16px;
        }

        /* --- [V2] REFACTORED: Toolbar & Controls --- */
        .toolbar-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .toolbar-group.main-actions {
            flex: 1 1 auto;
        }

        .toolbar-group.secondary-actions {
            flex-shrink: 0;
        }

        .group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        /* Legacy for JS */
        .group label {
            font-size: 13px;
            color: var(--muted-text);
            font-weight: 500;
        }

        select,
        input[type=text],
        input[type=number] {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            min-width: 160px;
            background: var(--card-bg);
            font-family: var(--font-sans);
            font-size: 14px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        select:focus,
        input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
        }

        button,
        a.btn {
            padding: 9px 16px;
            background-color: var(--accent);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-weight: 600;
            font-size: 13px;
            transition: background-color 0.2s, box-shadow 0.2s, transform 0.1s;
        }

        button:hover,
        a.btn:hover {
            background-color: var(--accent-hover);
            box-shadow: 0 4px 12px rgba(30, 64, 175, 0.15);
        }

        button:active,
        a.btn:active {
            transform: translateY(1px);
        }

        button.secondary,
        a.btn.secondary {
            background-color: #f3f4f6;
            color: #374151;
            border: 1px solid var(--border-color);
        }

        button.secondary:hover,
        a.btn.secondary:hover {
            background-color: #e5e7eb;
        }

        button.ghost {
            background: transparent;
            color: var(--accent);
            border: 1px solid #bfd5ff;
        }

        button.ghost:hover {
            background: #e0f2fe;
        }

        button:disabled,
        a.btn[aria-disabled="true"] {
            background-color: #e5e7eb;
            color: #9ca3af;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        button .spinner {
            width: 14px;
            height: 14px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: #e0f2fe;
            color: var(--accent);
            border-radius: 999px;
            padding: 4px 10px;
            font-size: 12px;
            font-weight: 600;
            border: 1px solid rgba(30, 64, 175, 0.1);
        }

        /* --- [V2] REFACTORED: Hamburger & Navigation Drawer --- */
        .hamburger-btn {
            background: transparent;
            border: none;
            padding: 8px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: background-color 0.2s;
        }

        .hamburger-btn:hover {
            background-color: #f3f4f6;
        }

        /* --- NEW CSS FOR HAMBURGER ICON COLOR --- */
        /* Targets the SVG path element within the hamburger button */
        .hamburger-btn svg path {
            stroke: #FF0000; /* Example: Red color. Change this to your desired color. */
        }
        /* --- END NEW CSS --- */

        .hamburger-btn .icon {
            width: 24px;
            height: 24px;
            color: var(--primary-text);
        }

        .nav-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .nav-backdrop.open {
            opacity: 1;
            visibility: visible;
        }

        .nav-drawer {
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            width: 280px;
            background: var(--card-bg);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            z-index: 1001;
            display: flex;
            flex-direction: column;
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
        }

        .nav-drawer.open {
            transform: translateX(0);
        }

        .nav-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-header h3 {
            margin: 0;
            font-size: 18px;
            color: var(--accent);
        }

        .nav-links {
            list-style: none;
            padding: 16px 0;
            margin: 0;
            flex-grow: 1;
            overflow-y: auto;
        }

        .nav-links li a {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            text-decoration: none;
            color: var(--primary-text);
            font-weight: 600;
            font-size: 14px;
            border-left: 3px solid transparent;
            transition: background-color 0.2s, border-color 0.2s;
        }

        .nav-links li a:hover {
            background-color: #f9fafb;
            border-left-color: var(--accent);
        }

        .nav-links li a .icon {
            width: 24px;
            height: 24px;
        }

        .nav-links li a.danger-link {
            color: var(--danger);
        }

        .nav-links li a.danger-link:hover {
            background-color: #fef2f2;
            border-left-color: var(--danger);
        }

        .nav-links .separator {
            height: 1px;
            background-color: var(--border-color);
            margin: 12px 20px;
        }

        /* --- File Drop Zone --- */
        #drop_zone {
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
            flex-grow: 1;
        }

        #drop_zone.dragover {
            background-color: #e0f2fe;
            border-color: var(--accent);
        }

        #drop_zone p {
            margin: 0;
            color: var(--muted-text);
            font-weight: 500;
        }

        #drop_zone p small {
            display: block;
            font-size: 12px;
            margin-top: 4px;
        }

        #filename {
            font-weight: 600;
            color: var(--accent);
            margin-top: 8px;
            font-size: 13px;
        }

        /* --- [V2] REFACTORED: Panels & Layout --- */
        .panel {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 24px;
            border: 1px solid var(--border-color);
            margin-bottom: 20px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.03), 0 2px 4px -2px rgba(0, 0, 0, 0.03);
            animation: slideUpIn 0.5s ease-out forwards;
        }

        .panel h3 {
            margin: 0 0 16px 0;
            font-size: 18px;
            color: var(--primary-text);
        }

        .two-col {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 24px;
        }

        .editor-grid {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e5e7eb;
        }

        .editor-grid th,
        .editor-grid td {
            border-bottom: 1px solid #e5e7eb;
            padding: 10px 12px;
            text-align: left;
        }

        .editor-grid th {
            background: #f9fafb;
            font-weight: 600;
            color: var(--primary-text);
        }

        .editor-grid tr:hover td {
            background-color: #f9fafb;
        }

        /* --- [V2] REFACTORED: Status Bar --- */
        #statusBar {
            position: sticky;
            top: calc(16px + 65px + 12px);
            /* Header height + gaps */
            z-index: 50;
            background: var(--card-bg);
            border-radius: 10px;
            padding: 8px 16px;
            border: 1px solid var(--border-color);
            font-size: 13px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            animation: slideUpIn 0.4s ease-out forwards;
            margin-bottom: 16px;
        }

        #statusBar .left {
            font-weight: 600;
        }

        #statusBar.ok {
            background: #ecfdf5;
            border-color: #a7f3d0;
            color: #065f46;
        }

        #statusBar.warn {
            background: #fffbeb;
            border-color: #fde68a;
            color: #854d0e;
        }

        #statusBar.err {
            background: #fef2f2;
            border-color: #fecaca;
            color: #991b1b;
        }

        /* --- Report Form Preview (THE CORE - UNTOUCHED) --- */
        #singleView .sheet {
            width: 100%;
            min-height: 420px;
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -4px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        .school-head {
            text-align: center;
            line-height: 1;
            margin-bottom: 10px;
            padding: 10px 0;
            border-bottom: 2px solid #e5e7eb;
        }

        .school-head h1 {
            margin: 0;
            font-size: 24px;
            font-weight: 800;
            color: var(--primary-text);
            letter-spacing: -0.5px;
        }

        .school-head .addr {
            font-size: 12px;
            color: var(--muted-text);
            margin-top: 2px;
        }

        .school-head .motto {
            margin-top: 4px;
            font-weight: 700;
            color: var(--accent);
            font-size: 14px;
        }

        .key {
            font-size: 11px;
            color: var(--muted-text);
            text-align: center;
            margin: 8px 0;
            padding: 4px 8px;
            background: #f9fafb;
            border-radius: 4px;
        }

        .title {
            text-align: center;
            font-weight: 700;
            margin: 10px 0 16px;
            font-size: 16px;
            text-transform: uppercase;
            color: var(--primary-text);
        }

        .meta {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px 16px;
            border: 1px solid var(--border-color);
            padding: 12px;
            border-radius: 8px;
            font-size: 13px;
            margin-bottom: 16px;
            background: #fcfcfc;
        }

        .meta div {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .meta label {
            font-weight: 700;
            min-width: 110px;
            color: var(--primary-text);
        }

        table.report {
            width: 100%;
            border-collapse: collapse;
            font-size: 11.5px;
            table-layout: fixed;
            margin-bottom: 12px;
        }

        table.report th,
        table.report td {
            border: 1px solid #d1d5db;
            padding: 7px 4px;
            text-align: center;
            word-break: break-word;
        }

        table.report th {
            background-color: var(--header-bg);
            font-weight: 700;
            color: var(--primary-text);
        }

        table.report thead th:first-child {
            width: 18%;
            min-width: 18%;
        }

        table.report tbody td {
            padding: 9px 4px;
        }

        table.report tbody tr:nth-child(even) {
            background-color: #f9fafb;
        }

        table.report td.label {
            text-align: left;
            padding-left: 10px;
            font-weight: 600;
            color: #374151;
        }

        .performance-section {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            margin: 15px 0;
        }

        .performance-label {
            font-weight: 800;
            color: var(--primary-text);
            font-size: 12px;
            flex-shrink: 0;
            width: 35%;
            line-height: 1.3;
            padding-top: 5px;
        }

        .label-style-1 {
            color: #8433FF;
        }

        .label-style-2 {
            color: #007bff;
        }

        .label-style-3 {
            color: #28a745;
        }

        .mini-chart-wrap {
            margin: 0;
            flex-grow: 1;
            border-left: 1px solid var(--border-color);
            padding-left: 15px;
            position: relative;
            height: 90px;
        }

        .mini-chart {
            display: flex;
            justify-content: space-around;
            align-items: flex-end;
            position: relative;
            height: 65px;
            width: 100%;
            border-bottom: 1px solid #ccc;
            margin-top: 5px;
            padding-bottom: 10px;
            box-sizing: content-box;
        }

        .bar-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            position: relative;
            height: 100%;
            width: 25%;
            margin: 0 5%;
            text-align: center;
        }

        .chart-bar {
            height: var(--bar-height);
            width: 100%;
            min-height: 3px;
            border-radius: 4px 4px 0 0;
            transition: height 0.5s ease-out;
        }

        .bar-opener {
            background: linear-gradient(to top, #007bff, #5aa5ff);
            box-shadow: 0 -2px 4px rgba(0, 123, 255, 0.3);
        }

        .bar-mid {
            background: linear-gradient(to top, #28a745, #5cb85c);
            box-shadow: 0 -2px 4px rgba(40, 167, 69, 0.3);
        }

        .bar-end {
            background: linear-gradient(to top, #dc3545, #e06e78);
            box-shadow: 0 -2px 4px rgba(220, 53, 69, 0.3);
        }

        .bar-value {
            font-size: 10px;
            font-weight: 700;
            color: var(--primary-text);
            margin-bottom: 2px;
            white-space: nowrap;
            text-shadow: 0 0 2px white;
        }

        .chart-labels {
            display: flex;
            justify-content: space-around;
            width: 100%;
            position: absolute;
            bottom: 0;
            left: 0;
            padding-left: 15px;
        }

        .chart-label {
            width: 30%;
            text-align: center;
            font-weight: 600;
            line-height: 1.1;
            font-size: 10px;
            white-space: nowrap;
        }

        .chart-label.opener {
            color: #007bff;
        }

        .chart-label.mid {
            color: #28a745;
        }

        .chart-label.end {
            color: #dc3545;
        }

        .comments-row,
        .sign-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
            font-size: 12px;
        }

        .comments-block {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .comments-block>div:first-child {
            font-weight: 700;
            margin-bottom: 0px;
            color: var(--accent);
            border-bottom: 1px dashed #e5e7eb;
            padding-bottom: 4px;
            font-size: 13px;
        }

        .comments-block>div:nth-child(2) {
            min-height: 30px;
            line-height: 1.3;
            color: var(--primary-text);
        }

        .sign-row {
            margin-top: 10px;
            padding: 5px 0;
            border-top: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
        }

        .sign-row.foot-dates {
            margin-top: 10px;
            padding: 5px 0;
            border: none;
            border-bottom: 1px solid var(--border-color);
        }

        .sign {
            border: none;
            border-bottom: 1px solid #9ca3af;
            padding: 0;
            border-radius: 0;
            min-height: 20px;
            background: transparent;
            line-height: 1.2;
            font-size: 11px;
            display: flex;
            align-items: flex-end;
            padding-bottom: 2px;
        }

        .sign b {
            color: #374151;
            font-weight: 600;
            margin-right: 4px;
            white-space: nowrap;
        }

        .sign-row .right-col {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .sign-row .right-col .sign:last-child {
            margin-top: auto;
        }

        .small {
            color: var(--muted-text);
            font-size: 10px;
            text-align: center;
            margin-top: 10px;
        }

        /* --- Toasts & Dialogs --- */
        .toasts {
            position: fixed;
            right: 20px;
            bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 9999;
        }

        .toast {
            background: #27272a;
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            animation: toastIn 0.4s ease-out;
        }

        .toast.exiting {
            animation: toastOut 0.4s ease-in forwards;
        }

        .toast.success {
            background-color: var(--success);
        }

        .toast.error {
            background-color: var(--danger);
        }

        .toast.warn {
            background-color: var(--warn);
            color: #1e293b;
        }

        dialog {
            border-radius: 12px;
            padding: 0;
            border: 1px solid var(--border-color);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            max-width: 740px;
            width: 90%;
        }

        dialog::backdrop {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        dialog[open] {
            animation: slideUpIn 0.4s ease-out;
        }

        .dlg-hd {
            padding: 16px 20px;
            font-weight: 700;
            font-size: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .dlg-bd {
            padding: 20px;
            line-height: 1.6;
        }

        .dlg-ft {
            padding: 12px 20px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            border-top: 1px solid #f9fafb;
            background: #f9fafb;
        }

        #errorDlg .dlg-hd {
            background: #fef2f2;
            color: var(--danger);
        }

        #confirmDlg .dlg-hd {
            background: #fffbeb;
            color: #854d0e;
        }

        pre.err {
            background: #f9fafb;
            border: 1px solid var(--border-color);
            padding: 12px;
            max-height: 240px;
            overflow: auto;
            border-radius: 6px;
            font-size: 13px;
        }

        /* --- Details Dialog --- */
        .details-form {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
        }

        .details-form .input-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .details-form label {
            font-weight: 600;
            font-size: 13px;
            color: var(--primary-text);
        }

        .details-form input {
            width: 100%;
        }

        /* --- Responsive & Print --- */
        @media (max-width: 960px) {
            .page-container {
                padding: 0 16px;
                margin: 0 auto;
            }

            .page-header {
                flex-direction: column;
                align-items: stretch;
                top: 0;
                border-radius: 0;
            }

            #statusBar {
                top: 150px;
            }

            /* Adjust sticky top for mobile */
            .two-col {
                grid-template-columns: 1fr;
            }

            .panel {
                padding: 16px;
            }
        }

        @media (max-width: 768px) {
            #statusBar {
                top: 200px;
            }

            /* Further adjust for smaller screens */
            .toolbar-group {
                flex-wrap: wrap;
            }
        }

        @media print {
            @page {
                size: A4 portrait;
                margin: 8mm;
            }

            html,
            body {
                background: #fff;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .page-header,
            .panel,
            #statusBar,
            .toasts,
            #singleView,
            .nav-drawer,
            .nav-backdrop {
                display: none !important;
            }

            #batchContainer {
                display: block !important;
            }

            /* Core styles to ensure content fits on one page */
            #singleView .sheet {
                page-break-inside: avoid;  /* Try to keep the entire sheet on one page */
                break-inside: avoid;       /* Modern equivalent */
                width: 100%;
                margin: 0;
                padding: 6mm; /* Consistent with other print styles */
                border: none;
                border-radius: 0;
                box-shadow: none;
                box-sizing: border-box;
            }

            /* Prevent breaks within table cells and rows */
            table.report td,
            table.report th {
                page-break-inside: avoid;
                break-inside: avoid;
            }

            /* Prevent breaks within other key report sections */
            .school-head, .title, .meta, .performance-section, .comments-row, .sign-row {
                page-break-inside: avoid;
                break-inside: avoid;
            }

            /* Ensure the last line doesn't get isolated */
            .small {
                page-break-before: avoid;
                break-before: avoid;
                page-break-after: avoid;
                break-after: avoid;
            }

            /* Re-apply existing print specific styles to maintain layout */
            .sheet {
                width: 100%;
                margin: 0;
                padding: 6mm;
                border: none;
                border-radius: 0;
                box-shadow: none;
                page-break-after: always; /* This might be contributing to the issue if it forces a break even if content fits */
                box-sizing: border-box;
                overflow: visible;
            }
            
            /* Adjusting page-break-after as it could force a break */
            /* If the last line *must* be on the same page, removing this might help */
            /* .sheet:last-child { */
            /*     page-break-after: auto; */
            /* } */


            .school-head h1 { font-size: 20px; }
            .title { font-size: 14px; }
            table.report { font-size: 10.5px; }
            table.report th, table.report td { padding: 5px 2px; border-color: #000; }
            .meta { font-size: 11px; padding: 6px; }
            .comments-block>div:nth-child(2) { min-height: 20px; }
            .mini-chart-wrap { height: 75px; }
            .mini-chart { height: 50px; padding-bottom: 8px; }
            .chart-bar { min-height: 2px; }
            .bar-value { font-size: 9px; margin-bottom: 1px; }
            .chart-labels, .chart-label { font-size: 9px; }
            .small { font-size: 9px; margin-top: 10px; }
            .comments-row, .sign-row { margin-top: 8px; gap: 10px; }
            .sign { min-height: 15px; }
            .sign-row.foot-dates { margin-top: 8px; }
        }
  </style>
 </head>
 <body>
  <div aria-hidden="true" class="nav-backdrop" id="navBackdrop">
  </div>
  <aside aria-hidden="true" class="nav-drawer" id="navDrawer">
   <div class="nav-header">
    <h3>
     CBC Report Form
    </h3>
   </div>
   <nav aria-label="Main Navigation">
    <ul class="nav-links">
     <li>
      <a href="#" id="navLoadWorkbook">
       <svg class="icon" fill="none" stroke="currentColor" stroke-width="1.5" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 16.5V9.75m0 0l-3 3m3-3l3 3M6.75 19.5a4.5 4.5 0 01-1.41-8.775 5.25 5.25 0 0110.233-2.33 3 3 0 013.758 3.848A3.752 3.752 0 0118 19.5H6.75z" stroke-linecap="round" stroke-linejoin="round">
        </path>
       </svg>
       Load New Workbook
      </a>
     </li>
     <li>
      <a href="#" id="navDetails">
       <svg class="icon" fill="none" stroke="currentColor" stroke-width="1.5" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 21v-8.25M15.75 21v-8.25M8.25 21v-8.25M3 9l9-6 9 6m-1.5 12V10.332A48.36 48.36 0 0012 9.75c-2.551 0-5.056.2-7.5.582V21M3 21h18M12 6.75h.008v.008H12V6.75z" stroke-linecap="round" stroke-linejoin="round">
        </path>
       </svg>
       Report &amp; School Details
      </a>
     </li>
     <li class="separator">
     </li>
     <li>
      <a href="#" id="navEditLearnerDetails">
       <svg class="icon" fill="none" stroke="currentColor" stroke-width="1.5" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" stroke-linecap="round" stroke-linejoin="round">
        </path>
       </svg>
       Edit Learner Details
      </a>
     </li>
     <li>
      <a href="#" id="navAddLearner">
       <svg class="icon" fill="none" stroke="currentColor" stroke-width="1.5" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 4.5v15m7.5-7.5h-15" stroke-linecap="round" stroke-linejoin="round">
        </path>
       </svg>
       Add New Learner
      </a>
     </li>
     <li>
      <a href="#filtersPanel" id="navFilter">
       <svg class="icon" fill="none" stroke="currentColor" stroke-width="1.5" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 3c2.755 0 5.455.232 8.083.678.533.09.917.556.917 1.096v1.044a2.25 2.25 0 01-.659 1.591l-5.432 5.432a2.25 2.25 0 00-.659 1.591v2.927a2.25 2.25 0 01-1.244 2.013L9.75 21v-6.572a2.25 2.25 0 00-.659-1.591L3.659 7.409A2.25 2.25 0 013 5.818V4.774c0-.54.384-1.006.917-1.096A48.32 48.32 0 0112 3z" stroke-linecap="round" stroke-linejoin="round">
        </path>
       </svg>
       Filter &amp; Select Learner
      </a>
     </li>
     <li>
      <a href="#editorPanel" id="navEdit">
       <svg class="icon" fill="none" stroke="currentColor" stroke-width="1.5" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" stroke-linecap="round" stroke-linejoin="round">
        </path>
       </svg>
       Edit Marks
      </a>
     </li>
     <li class="separator">
     </li>
     <li>
      <a href="#" id="navSwitchJunior">
       <svg class="icon" fill="none" stroke="currentColor" stroke-width="1.5" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path d="M11.42 15.17L17.25 21A2.652 2.652 0 0021 18.75V16.875M11.42 15.17L4.75 21A2.652 2.652 0 011 18.75V16.875m10.42-1.7V6.75L4.75 3A2.652 2.652 0 011 5.25v1.5c0 .324.088.64.25.92L4.75 12l.001.002.002.002.002.002.003.002.005.003.007.003.01.004.012.004.015.004.017.004.02.004.022.004.025.004.028.004.03.003.034.003.036.003.04.002.043.002.046.002.05.002.053.001.056.001.06.001.063.001.067.001h.07Z" stroke-linecap="round" stroke-linejoin="round">
        </path>
       </svg>
       Use Both Junior-Primary School Form
      </a>
     </li>
     <li>
      <a href="#" id="navSwitchPrimary">
       <svg class="icon" fill="none" stroke="currentColor" stroke-width="1.5" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path d="M4.26 10.147a60.436 60.436 0 00-.491 6.347A48.627 48.627 0 0112 20.904a48.627 48.627 0 018.232-4.41 60.46 60.46 0 00-.491-6.347m-15.482 0a50.57 50.57 0 00-2.258-.813A59.905 59.905 0 0112 3.493a59.902 59.902 0 0110.399 5.84c-.896.248-1.783.52-2.658.814m-15.482 0l-1.07-1.07a9 9 0 01-1.28-5.672c.218-.964.46-1.908.732-2.828a9.003 9.003 0 018.05-6.108h.203a9.003 9.003 0 018.05 6.108c.27.92.514 1.864.732 2.828a9 9 0 01-1.28 5.672l-1.07 1.07m-15.482 0A50.697 50.697 0 0112 13.489a50.697 50.697 0 017.74-3.342M6.75 15a.75.75 0 100-1.5.75.75 0 000 1.5z" stroke-linecap="round" stroke-linejoin="round">
        </path>
       </svg>
       Use Lower Primary School Form
      </a>
     </li>
     <li class="separator">
     </li>
     <li>
      <a download="" href="primary-junior-template.xlsx" id="navDownloadTemplate">
       <svg class="icon" fill="none" stroke="currentColor" stroke-width="1.5" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path d="M9 13.5l3 3m0 0l3-3m-3 3v-6m1.06-4.19l-2.12-2.12a1.5 1.5 0 00-1.061-.44H4.5A2.25 2.25 0 002.25 6v12a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9a2.25 2.25 0 00-2.25-2.25h-5.379a1.5 1.5 0 01-1.06-.44z" stroke-linecap="round" stroke-linejoin="round">
        </path>
       </svg>
       Both Junior and Primary School Excel Template
      </a>
     </li>
     <li>
      <a download="" href="lower-primary-template.xlsx" id="navDownloadPrimaryTemplate">
       <svg class="icon" fill="none" stroke="currentColor" stroke-width="1.5" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path d="M9 13.5l3 3m0 0l3-3m-3 3v-6m1.06-4.19l-2.12-2.12a1.5 1.5 0 00-1.061-.44H4.5A2.25 2.25 0 002.25 6v12a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9a2.25 2.25 0 00-2.25-2.25h-5.379a1.5 1.5 0 01-1.06-.44z" stroke-linecap="round" stroke-linejoin="round">
        </path>
       </svg>
       Lower Primary School Excel Template
      </a>
     </li>
     <li>
      <a href="#" id="navDownload">
       <svg class="icon" fill="none" stroke="currentColor" stroke-width="1.5" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" stroke-linecap="round" stroke-linejoin="round">
        </path>
       </svg>
       Download Updated Excel
      </a>
     </li>
     <li>
      <a href="#" id="navBatchPrint">
       <svg class="icon" fill="none" stroke="currentColor" stroke-width="1.5" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path d="M6.72 13.829c-.24.03-.48.062-.72.096m.72-.096a42.415 42.415 0 0110.56 0m-10.56 0L6 3.75m10.56 0L18 3.75m0 0a45.093 45.093 0 00-3.72-.321M3 3h18M3 7.5h18M3 12h18m-9 3.75h.008v.008H12v-.008z" stroke-linecap="round" stroke-linejoin="round">
        </path>
       </svg>
       Batch Print (Filtered)
      </a>
     </li>
     <li>
      <a href="#" id="navPrintCurrent">
       <svg class="icon" fill="none" stroke="currentColor" stroke-width="1.5" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path d="M6.72 13.829c-.24.03-.48.062-.72.096m.72-.096a42.415 42.415 0 0110.56 0m-10.56 0L6 3.75m10.56 0L18 3.75m0 0a45.093 45.093 0 00-3.72-.321M3 3h18M3 7.5h18M3 12h18m-9 3.75h.008v.008H12v-.008z" stroke-linecap="round" stroke-linejoin="round">
        </path>
       </svg>
       Print Current Report
      </a>
     </li>
     <li class="separator">
     </li>
     <li>
      <a class="danger-link" href="#" id="navClearSession">
       <svg class="icon" fill="none" stroke="currentColor" stroke-width="1.5" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 9.75L14.25 12m0 0l2.25 2.25M14.25 12L12 14.25m-2.58 4.92l-6.375-6.375a1.125 1.125 0 010-1.59L9 4.5l4.5 4.5L18 4.5l2.25 2.25l-6.375 6.375a1.125 1.125 0 01-1.59 0z" stroke-linecap="round" stroke-linejoin="round">
        </path>
       </svg>
       Clear &amp; Reset Session
      </a>
     </li>
    </ul>
   </nav>
  </aside>
  <div class="page-container">
   <header aria-label="Main toolbar" class="page-header" role="toolbar">
    <div class="toolbar-group">
     <button aria-controls="navDrawer" aria-expanded="false" aria-label="Open menu" class="hamburger-btn" id="hamburgerBtn">
      <svg class="icon" fill="none" stroke="currentColor" stroke-width="1.5" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
       <path d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" stroke-linecap="round" stroke-linejoin="round">
       </path>
      </svg>
     </button>
    </div>
    <div class="toolbar-group main-actions">
     <div class="group" id="drop_zone">
      <input accept=".xlsx,.xls" hidden="" id="file" type="file"/>
      <p>
       Drag &amp; Drop Workbook (.xlsx) here, or click to select
      </p>
      <p>
       <small>
        All processing is done locally in your browser. No data is uploaded.
       </small>
      </p>
      <div id="filename">
      </div>
     </div>
    </div>
    <div class="toolbar-group secondary-actions">
     <button class="ghost" disabled="" id="printSelectedBtn">
      Print Selected
     </button>
     <button class="ghost" disabled="" id="printFilteredBtn">
      Batch Print
     </button>
     <a aria-disabled="true" class="btn secondary" id="downloadExcelLink">
      Download Updated Excel
     </a>
     <span class="chip" id="unsavedChip" style="display:none">
      Unsaved
     </span>
    </div>
   </header>
   <main>
    <div aria-live="polite" class="statusbar" id="statusBar" style="display:none;">
     <div class="left">
      Ready
     </div>
     <div class="right muted" id="statusDetails">
      Load a workbook to begin.
     </div>
    </div>
    <div id="mainContent" style="display:none;">
     <section aria-labelledby="filters-heading" class="panel" id="filtersPanel">
      <h3 id="filters-heading">
       Filters
      </h3>
      <div style="display:flex; gap:16px; flex-wrap:wrap; align-items:center;">
       <div class="group">
        <label for="learnerSel">
         Learner:
        </label>
        <select id="learnerSel">
        </select>
       </div>
       <div class="group">
        <label for="fGender">
         Gender:
        </label>
        <select id="fGender">
         <option value="">
          All
         </option>
         <option>
          M
         </option>
         <option>
          F
         </option>
        </select>
       </div>
       <div class="group">
        <label for="fGrade">
         Grade:
        </label>
        <select id="fGrade">
         <option value="">
          All
         </option>
        </select>
       </div>
       <div class="group">
        <button class="secondary" id="applyFiltersBtn">
         Apply
        </button>
        <button class="secondary" id="clearFiltersBtn">
         Clear
        </button>
        <span class="muted" id="matchCountChip">
         0 selected
        </span>
       </div>
      </div>
     </section>
     <section aria-labelledby="editor-heading" class="panel" id="editorPanel">
      <h3 id="editor-heading">
       Edit Marks
       <small class="muted" style="font-weight:400;">
        (writes back to Learners sheet)
       </small>
      </h3>
      <div class="two-col">
       <div>
        <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:16px;">
         <div class="group">
          <label for="phaseSel">
           Phase:
          </label>
          <select id="phaseSel">
           <option value="Opener">
            Opener
           </option>
           <option value="Mid">
            Midterm
           </option>
           <option value="End">
            End term
           </option>
          </select>
         </div>
         <div class="group">
          <button id="savePhaseBtn">
           Save to Learner
          </button>
          <button class="secondary" id="applyOutOfAllBtn">
           Apply 'Out Of' to ALL
          </button>
         </div>
        </div>
        <table aria-label="Marks editor" class="editor-grid" id="marksGrid">
         <thead>
          <tr>
           <th>
            Learning Area
           </th>
           <th style="width:140px">
            Score
           </th>
           <th style="width:140px">
            Out Of
           </th>
          </tr>
         </thead>
         <tbody id="marksBody">
         </tbody>
        </table>
       </div>
       <div>
        <h4 style="margin:0 0 8px; font-size:15px;">
         Live Preview
        </h4>
        <div id="singleView">
         <div aria-label="Report Form Preview" class="sheet" id="singleSheet">
         </div>
        </div>
       </div>
      </div>
     </section>
    </div>
    <div aria-hidden="true" id="batchContainer" style="display:none">
    </div>
   </main>
  </div>
  <div aria-atomic="true" aria-live="polite" class="toasts" id="toasts">
  </div>
  <dialog id="errorDlg">
   <div class="dlg-hd">
    An Error Occurred
   </div>
   <div class="dlg-bd">
    <p>
     We encountered a problem while processing your request. Please see the details below.
    </p>
    <pre class="err" id="errDetails"></pre>
   </div>
   <div class="dlg-ft">
    <button class="secondary" id="copyErrBtn">
     Copy Details
    </button>
    <button id="closeErrBtn">
     Close
    </button>
   </div>
  </dialog>
  <dialog id="confirmDlg">
   <div class="dlg-hd">
    Confirm Action
   </div>
   <div class="dlg-bd" id="confirmMsg">
   </div>
   <div class="dlg-ft">
    <button class="secondary" id="confirmCancelBtn">
     Cancel
    </button>
    <button class="warn" id="confirmOkBtn">
     Confirm
    </button>
   </div>
  </dialog>
  <dialog id="detailsDlg">
   <div class="dlg-hd">
    Report &amp; School Details
   </div>
   <div class="dlg-bd">
    <form class="details-form" id="detailsForm" onsubmit="return false;">
     <div class="input-group">
      <label for="schoolNameInp">
       School Name
      </label>
      <input id="schoolNameInp" type="text" value="ITIATI JUNIOR SCHOOL"/>
     </div>
     <div class="input-group">
      <label for="assessmentTitleInp">
       Assessment Title
      </label>
      <input id="assessmentTitleInp" type="text" value="END TERM {term} ASSESSMENT - YEAR {year}"/>
     </div>
     <div class="input-group">
      <label for="headteacherNameInp">
       Headteacher's Name
      </label>
      <input id="headteacherNameInp" placeholder="Enter Headteacher's Name" type="text"/>
     </div>
     <p class="muted" style="font-size:12px; margin-top:10px;">
      Note: These values will be used on the printed reports. Use placeholders like {term} and {year} for dynamic data.
     </p>
    </form>
   </div>
   <div class="dlg-ft">
    <button class="secondary" id="detailsCancelBtn">
     Cancel
    </button>
    <button id="detailsSaveBtn">
     Save &amp; Apply
    </button>
   </div>
  </dialog>
  <script>
   // The original JavaScript is unchanged as per the requirements.
        (function() {
            "use strict";
            // --- Configuration ---
            const JUNIOR_SUBJECTS = [{
                key: 'ENG',
                label: 'ENGLISH'
            }, {
                key: 'COMP',
                label: 'COMPOSITION'
            }, {
                key: 'KISW',
                label: 'KISWAHILI'
            }, {
                key: 'INSHA',
                label: 'INSHA'
            }, {
                key: 'MATH',
                label: 'MATHEMATICS'
            }, {
                key: 'SCIE',
                label: 'INTER/SCIE'
            }, {
                key: 'SST',
                label: 'S/S'
            }, {
                key: 'CRE',
                label: 'CRE'
            }, {
                key: 'AGRI',
                label: 'AGRI/NUT'
            }, {
                key: 'CA',
                label: 'C/ART'
            }, {
                key: 'PRETECH',
                label: 'PRE-TECH'
            }, ];
            const PRIMARY_SUBJECTS = [{
                key: 'ENG',
                label: 'ENGLISH'
            }, {
                key: 'KISW',
                label: 'KISWAHILI'
            }, {
                key: 'MATH',
                label: 'MATHEMATICS'
            }, {
                key: 'ENVIRONMENTAL',
                label: 'ENVIRONMENTAL ACTIVITIES'
            }, {
                key: 'C/ARTS',
                label: 'CREATIVE ARTS'
            }, {
                key: 'CRE',
                label: 'C.R.E'
            }, ];
            let MARK_KEYS = [];
            const DEFAULT_THRESHOLDS = [{
                min: 76,
                grade: 'EE'
            }, {
                min: 49,
                grade: 'ME'
            }, {
                min: 25,
                grade: 'AE'
            }, {
                min: 0,
                grade: 'BE'
            }];
            const STORAGE_KEY = 'cbcReportFormData_v2';

            // --- DOM References ---
            const $ = sel => document.querySelector(sel);
            const $hamburgerBtn = $('#hamburgerBtn');
            const $navDrawer = $('#navDrawer');
            const $navBackdrop = $('#navBackdrop');
            const $dropZone = $('#drop_zone');
            const $fileInput = $('#file');
            const $filename = $('#filename');
            const $printSelectedBtn = $('#printSelectedBtn');
            const $printFilteredBtn = $('#printFilteredBtn');
            const $downloadExcelLink = $('#downloadExcelLink');
            const $unsavedChip = $('#unsavedChip');
            const $statusBar = $('#statusBar');
            const $statusLeft = $('#statusBar .left');
            const $statusDetails = $('#statusBar .right');
            const $mainContent = $('#mainContent');
            const $filtersPanel = $('#filtersPanel');
            const $learnerSel = $('#learnerSel');
            const $fGender = $('#fGender');
            const $fGrade = $('#fGrade');
            const $applyFiltersBtn = $('#applyFiltersBtn');
            const $clearFiltersBtn = $('#clearFiltersBtn');
            const $matchCountChip = $('#matchCountChip');
            const $editorPanel = $('#editorPanel');
            const $phaseSel = $('#phaseSel');
            const $marksBody = $('#marksBody');
            const $savePhaseBtn = $('#savePhaseBtn');
            const $applyOutOfAllBtn = $('#applyOutOfAllBtn');
            const $singleSheet = $('#singleSheet');
            const $batchContainer = $('#batchContainer');
            const $toasts = $('#toasts');
            const $errorDlg = $('#errorDlg');
            const $errDetails = $('#errDetails');
            const $confirmDlg = $('#confirmDlg');
            const $confirmMsg = $('#confirmMsg');
            const $detailsDlg = $('#detailsDlg');

            // --- Application State ---
            let learners = [];
            let originalLearnersSnapshot = [];
            let thresholds = DEFAULT_THRESHOLDS;
            let filteredLearners = [];
            let originalWb = null;
            let headerIndexMap = {};
            let unsavedChanges = false;
            let reportDetails = {
                schoolName: 'ITIATI JUNIOR SCHOOL',
                address1: 'P.O. BOX 160-10101',
                town: 'KARATINA',
                motto: 'HARDWORK FOR EXCELLENCE',
                titleTemplate: 'END TERM {term} ASSESSMENT - YEAR {year}',
                headteacherName: ''
            };
            let learnersSheetName = null;
            let learnersSheetCols = null;
            let learnersSheetRows = null;
            let learnersSheetMerges = null;
            let originalWorkbookViews = null;
            let originalWorkbookProps = null;
            let sheetSavedViews = null;
            let activeSubjects = JUNIOR_SUBJECTS;
            let currentMode = 'Junior';
            let hamburgerClickHandler = () => toggleNavDrawer(true);

            // --- App Mode & Configuration ---
            function updateActiveConfig(mode) {
                if (currentMode === mode) return; // No change
                currentMode = mode;
                activeSubjects = (mode === 'Primary') ? PRIMARY_SUBJECTS : JUNIOR_SUBJECTS;
                MARK_KEYS = activeSubjects.flatMap(s => [`${s.key}_Opener`, `${s.key}_Opener_OutOf`, `${s.key}_Mid`, `${s.key}_Mid_OutOf`, `${s.key}_End`, `${s.key}_End_OutOf`]);
                document.dispatchEvent(new Event('modeChange'));
                // Re-render UI if a learner is currently selected
                const selectedLearner = currentSelectedRow();
                if (selectedLearner) {
                    buildMarksGrid(selectedLearner);
                    renderSelected(Number($learnerSel.value));
                }
                toast(`Switched to ${mode} School Mode`, 'success');
                saveStateToLocalStorage();
            }

            // --- Persistence Logic ---
            function saveStateToLocalStorage() {
                if (!learners || learners.length === 0) return;
                const stateToSave = {
                    learners,
                    originalLearnersSnapshot,
                    reportDetails,
                    thresholds,
                    learnersSheetName,
                    headerIndexMap,
                    fileName: $filename.textContent,
                    currentMode // V2 addition
                };
                try {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(stateToSave));
                } catch (e) {
                    console.error("Failed to save state to localStorage:", e);
                    toast("Could not save session data. Storage might be full.", "error");
                }
            }

            function loadStateFromLocalStorage() {
                try {
                    const savedStateJSON = localStorage.getItem(STORAGE_KEY);
                    if (!savedStateJSON) {
                        updateActiveConfig('Junior'); // Set default on first load
                        return;
                    }
                    const savedState = JSON.parse(savedStateJSON);
                    // Set mode first to ensure correct subject configuration is used
                    updateActiveConfig(savedState.currentMode || 'Junior');
                    learners = savedState.learners;
                    originalLearnersSnapshot = savedState.originalLearnersSnapshot;
                    reportDetails = savedState.reportDetails;
                    thresholds = savedState.thresholds;
                    learnersSheetName = savedState.learnersSheetName;
                    headerIndexMap = savedState.headerIndexMap;

                    $mainContent.style.display = 'block';
                    $dropZone.querySelector('p').style.display = 'none';
                    $filename.textContent = savedState.fileName;
                    hydrateGrades();
                    clearFilters();
                    showUnsaved(true);
                    setStatus('Session Restored', 'warn', `Re-upload '${savedState.fileName}' to enable Excel download.`);
                    attachHamburgerListener();
                    toast(`Restored your previous session in ${currentMode} School Mode.`, 'success');
                } catch (e) {
                    console.error("Failed to load state from localStorage:", e);
                    toast("Could not restore session data. It may be corrupt.", "error");
                    localStorage.removeItem(STORAGE_KEY);
                }
            }

            // --- UI & Utility Helpers ---
            function setStatus(msg, type = 'ok', details = '') {
                $statusBar.style.display = 'flex';
                $statusBar.className = `statusbar ${type}`;
                $statusLeft.textContent = msg;
                $statusDetails.textContent = details;
            }

            function toast(msg, type = 'success', timeout = 2500) {
                const el = document.createElement('div');
                el.className = `toast ${type}`;
                el.textContent = msg;
                $toasts.appendChild(el);
                setTimeout(() => {
                    el.classList.add('exiting');
                    el.addEventListener('animationend', () => el.remove());
                }, timeout);
            }

            function withErrorUI(fn) {
                return async (...args) => {
                    try {
                        return await fn(...args);
                    } catch (err) {
                        console.error(err);
                        const details = `Message: ${err?.message || err}\n\nStack:\n${err?.stack || '(no stack)'}`;
                        $errDetails.textContent = details;
                        $errorDlg.showModal();
                        setStatus('Action failed', 'err', err.message);
                        toast('Something went wrong', 'error');
                    }
                };
            }

            function confirmAction(message) {
                return new Promise(resolve => {
                    $confirmMsg.textContent = message;
                    $confirmDlg.showModal();
                    const onConfirm = () => {
                        cleanup();
                        resolve(true);
                    };
                    const onCancel = () => {
                        cleanup();
                        resolve(false);
                    };
                    const cleanup = () => {
                        $('#confirmOkBtn').removeEventListener('click', onConfirm);
                        $('#confirmCancelBtn').removeEventListener('click', onCancel);
                        $confirmDlg.close();
                    };
                    $('#confirmOkBtn').addEventListener('click', onConfirm, {
                        once: true
                    });
                    $('#confirmCancelBtn').addEventListener('click', onCancel, {
                        once: true
                    });
                    $confirmDlg.onclose = onCancel;
                });
            }

            function showUnsaved(flag) {
                unsavedChanges = flag;
                $unsavedChip.style.display = flag ? 'inline-flex' : 'none';
                $downloadExcelLink.setAttribute('aria-disabled', !flag || !originalWb);
            }

            // --- Core Logic Helpers ---
            const getIndex = (row) => Number(row.Index ?? row.index ?? row.INDEX);
            const pctGrade = (score, outOf) => {
                if (outOf <= 0 || score === null || score === '') return {
                    pct: 0,
                    grade: 'BE'
                };
                const pct = Math.max(0, Math.round((Number(score) / Number(outOf)) * 100));
                const t = thresholds.find(t => pct >= t.min) || {
                    grade: 'BE'
                };
                return {
                    pct,
                    grade: t.grade
                };
            };
            const escapeHTML = (s) => String(s ?? '').replace(/[&<>"']/g, (c) => ({
                "&": "&amp;",
                "<": "&lt;",
                ">": "&gt;",
                '"': "&quot;",
                "'": "&#39;"
            } [c]));
            const termWord = (n) => ({
                1: 'ONE',
                2: 'TWO',
                3: 'THREE'
            } [n] || String(n));

            function calcGraphHeight(score, maxVal) {
                if (maxVal === 0 || score === 0) return 0;
                const percent = Math.min(100, (score / maxVal) * 100);
                return percent;
            }

            function htmlChartTotals(oSc, mSc, eSc) {
                const totalMax = Math.max(oSc, mSc, eSc, 10);
                const hOpener = calcGraphHeight(oSc, totalMax);
                const hMid = calcGraphHeight(mSc, totalMax);
                const hEnd = calcGraphHeight(eSc, totalMax);
                return `<div class="mini-chart-wrap" aria-hidden="true"><div class="mini-chart" role="img" aria-label="Performance bar chart"><div class="bar-item"><span class="bar-value">${oSc}</span><div class="chart-bar bar-opener" style="--bar-height: ${hOpener}%" title="Opener Total: ${oSc}"></div></div><div class="bar-item"><span class="bar-value">${mSc}</span><div class="chart-bar bar-mid" style="--bar-height: ${hMid}%" title="Midterm Total: ${mSc}"></div></div><div class="bar-item"><span class="bar-value">${eSc}</span><div class="chart-bar bar-end" style="--bar-height: ${hEnd}%" title="End term Total: ${eSc}"></div></div></div><div class="chart-labels"><span class="chart-label opener">Opener</span><span class="chart-label mid">Midterm</span><span class="chart-label end">Endterm</span></div></div>`;
            }

            // UPDATED: htmlReport now appends a TOTAL row in the table body
            function htmlReport(row) {
                const pupilName = row["Pupil's Name"] || row["Pupil Name"] || '';
                const grade = row["Grade"] ?? '';
                const term = row["Term"] ?? '';
                const year = row["Year"] ?? '';
                const ctComment = row["Class_Teacher_Comment"] || '';
                const ctName = row["Class_Teacher_Name"] || '';
                const ctSign = row["Class_Teacher_Signature"] || row["Class_Teacher_Sign"] || '';
                const htComment = row["Head_Teacher_Comment"] || '';
                const htName = row["Head_Teacher_Name"] || reportDetails.headteacherName || '';
                const htSign = row["Head_Teacher_Signature"] || row["Head_Teacher_Sign"] || '';
                const parentComment = row["Parent_Comment"] || '';
                const parentName = row["Parent_Name"] || '';
                const parentSign = row["Parent_Signature"] || row["Parent_Sign"] || '';
                const closingDate = row["Closing_Date"] || row["Closing Date"] || '';
                const openingDate = row["Opening_Date"] || row["Opening Date"] || '';

                const subRows = activeSubjects.map(s => {
                    const oSc = Number(row[`${s.key}_Opener`]) || 0,
                        oMax = Number(row[`${s.key}_Opener_OutOf`]) || 0;
                    const mSc = Number(row[`${s.key}_Mid`]) || 0,
                        mMax = Number(row[`${s.key}_Mid_OutOf`]) || 0;
                    const eSc = Number(row[`${s.key}_End`]) || 0,
                        eMax = Number(row[`${s.key}_End_OutOf`]) || 0;
                    const oG = pctGrade(oSc, oMax).grade,
                        mG = pctGrade(mSc, mMax).grade,
                        eG = pctGrade(eSc, eMax).grade;
                    return {
                        label: s.label,
                        oSc,
                        oMax,
                        oG,
                        mSc,
                        mMax,
                        mG,
                        eSc,
                        eMax,
                        eG
                    };
                });

                const total = subRows.reduce((a, r) => {
                    a.oSc += r.oSc;
                    a.oMax += r.oMax;
                    a.mSc += r.mSc;
                    a.mMax += r.mMax;
                    a.eSc += r.eSc;
                    a.eMax += r.eMax;
                    return a;
                }, {
                    oSc: 0,
                    oMax: 0,
                    mSc: 0,
                    mMax: 0,
                    eSc: 0,
                    eMax: 0
                });

                // NEW: Compute total grades for each phase
                const tOG = pctGrade(total.oSc, total.oMax).grade;
                const tMG = pctGrade(total.mSc, total.mMax).grade;
                const tEG = pctGrade(total.eSc, total.eMax).grade;

                // NEW: TOTAL row markup
                const totalsRowHtml =
                    `<tr class="total-row">\n`+
                    `  <td class="label" style="font-weight:800">TOTAL</td>\n`+
                    `  <td>${total.oSc}</td><td>${total.oMax}</td><td>${tOG}</td>\n`+
                    `  <td>${total.mSc}</td><td>${total.mMax}</td><td>${tMG}</td>\n`+
                    `  <td>${total.eSc}</td><td>${total.eMax}</td><td>${tEG}</td>\n`+
                    `</tr>`;

                const title = reportDetails.titleTemplate.replace('{term}', termWord(Number(term))).replace('{year}', year);
                return `<div class="school-head"><h1 id="repSchoolName">${escapeHTML(reportDetails.schoolName)}</h1><div class="addr">${escapeHTML(reportDetails.address1)} â€¢ ${escapeHTML(reportDetails.town)}</div><div class="motto">${escapeHTML(reportDetails.motto)}</div></div><div class="key">KEY: <b>EE</b>â€“Exceeding Expectations, <b>ME</b>â€“Meeting Expectations, <b>AE</b>â€“Approaching Expectations, <b>BE</b>â€“Below Expectations</div><div class="title" id="repTitle">${escapeHTML(title)}</div><div class="meta"><div><label>PUPIL'S NAME:</label><div>${escapeHTML(pupilName)}</div></div><div><label>GRADE:</label><div>${escapeHTML(String(grade))}</div></div></div><table class="report" role="table" aria-label="Learner report"><thead><tr><th rowspan="2">LEARNING AREA</th><th colspan="3">OPENER</th><th colspan="3">MIDTERM</th><th colspan="3">END TERM</th></tr><tr><th>SCORE</th><th>OUTOF</th><th>GRADE</th><th>SCORE</th><th>OUTOF</th><th>GRADE</th><th>SCORE</th><th>OUTOF</th><th>GRADE</th></tr></thead><tbody>${subRows.map(r => `<tr><td class="label">${r.label}</td><td>${r.oSc}</td><td>${r.oMax}</td><td>${r.oG}</td><td>${r.mSc}</td><td>${r.mMax}</td><td>${r.mG}</td><td>${r.eSc}</td><td>${r.eMax}</td><td>${r.eG}</td></tr>`).join('')}${totalsRowHtml}</tbody></table><div class="performance-section"><div class="performance-label"><span class="label-style-1">Graphical</span> <span class="label-style-2">representation</span> of <span class="label-style-3">learner performance</span> this term</div>${htmlChartTotals(total.oSc, total.mSc, total.eSc)}</div><div class="comments-row"><div class="comments-block"><div>CLASS TEACHER'S COMMENT</div><div>${escapeHTML(ctComment) || 'Comment...'}</div></div><div class="comments-block"><div>HEAD TEACHER'S COMMENT</div><div>${escapeHTML(htComment) || 'Comment...'}</div></div></div><div class="sign-row"><div class="sign"><b>Class Teacher Name:</b> ${escapeHTML(ctName)}</div><div class="sign" id="repHeadteacherName"><b>Head Teacher Name:</b> ${escapeHTML(htName)}</div></div><div class="sign-row"><div class="sign"><b>CT Signature:</b> ${escapeHTML(ctSign)}</div><div class="sign"><b>HT Signature:</b> ${escapeHTML(htSign)}</div></div><div class="comments-row" style="margin-top: 20px;"><div class="comments-block"><div>PARENT/GUARDIAN'S FEEDBACK</div><div>${escapeHTML(parentComment) || 'Comment...'}</div></div><div class="comments-block"><div style="border-bottom: none; padding-bottom: 0; font-size: 12px; color: var(--primary-text);"><div class="sign" style="min-height: 20px;"><b>Parent Name:</b> ${escapeHTML(parentName)}</div><div class="sign" style="min-height: 20px; margin-top: 10px;"><b>Parent Signature:</b> ${escapeHTML(parentSign)}</div></div></div></div><div class="sign-row foot-dates"><div class="sign"><b>Closing Date:</b> ${escapeHTML(closingDate)}</div><div class="sign"><b>Opening Date:</b> ${escapeHTML(openingDate)}</div></div><div class="small">This report is designed to fit on a single A4 page when printed at 100% scale.</div>`;
            }

            // --- Data Manipulation & Actions ---
            function resetUI() {
                $mainContent.style.display = 'none';
                $statusBar.style.display = 'none';
                $filename.textContent = '';
                learners = [];
                originalLearnersSnapshot = [];
                filteredLearners = [];
                originalWb = null;
                showUnsaved(false);
                document.querySelectorAll('button:not(.hamburger-btn), a.btn, select').forEach(el => el.disabled = true);
                $dropZone.querySelector('p').style.display = 'block';
                $fileInput.value = '';
            }

            function hydrateGrades() {
                const grades = [...new Set(learners.map(r => String(r.Grade || '').trim()).filter(Boolean))].sort();
                $fGrade.innerHTML = '<option value="">All</option>' + grades.map(g => `<option>${g}</option>`).join('');
            }

            function applyFilters() {
                const gender = ($fGender.value || '').trim().toUpperCase();
                const grade = ($fGrade.value || '').trim();
                filteredLearners = learners.filter(r => {
                    if (gender && String(r.Gender || '').trim().toUpperCase() !== gender) return false;
                    if (grade && String(r.Grade || '').trim() !== grade) return false;
                    return true;
                }).sort((a, b) => getIndex(a) - getIndex(b));
                hydrateLearnerDropdown();
                if (filteredLearners.length) {
                    $learnerSel.selectedIndex = 1;
                    renderSelected(0);
                } else {
                    $singleSheet.innerHTML = '<p style="text-align:center;padding:2rem;">No learners match the selected filters.</p>';
                    $marksBody.innerHTML = '';
                }
            }

            function clearFilters() {
                $fGender.value = '';
                $fGrade.value = '';
                applyFilters();
            }

            function hydrateLearnerDropdown() {
                $learnerSel.innerHTML = '<option value="">â€” Select a learner to view or edit â€”</option>' + filteredLearners.map((r, i) => {
                    const idx = getIndex(r);
                    const labelIdx = Number.isNaN(idx) ? `(${i + 1})` : idx;
                    const name = r["Pupil's Name"] || `Learner ${i + 1}`;
                    return `<option value="${i}">${labelIdx}. ${escapeHTML(name)}</option>`;
                }).join('');
                const hasLearners = learners.length > 0;
                document.querySelectorAll('button:not(.hamburger-btn), a.btn, select').forEach(el => {
                    if (!el.closest('.nav-drawer')) el.disabled = !hasLearners
                });
                showUnsaved(unsavedChanges);
                $matchCountChip.textContent = `${filteredLearners.length} selected`;
            }

            function renderSelected(index) {
                const row = filteredLearners[index];
                if (!row) return;
                $singleSheet.innerHTML = `<div class="sheet">${htmlReport(row)}</div>`;
                buildMarksGrid(row);
            }

            function buildMarksGrid(row) {
                const phase = $phaseSel.value;
                $marksBody.innerHTML = activeSubjects.map(s => {
                    const score = row[`${s.key}_${phase}`] ?? '';
                    const outOf = row[`${s.key}_${phase}_OutOf`] ?? '';
                    return `<tr data-key="${s.key}"><td>${s.label}</td><td><input type="number" step="0.01" class="score" value="${score}"></td><td><input type="number" step="0.01" class="outof" value="${outOf}"></td></tr>`;
                }).join('');
            }

            const currentSelectedRow = () => {
                const idx = Number($learnerSel.value);
                return (Number.isInteger(idx) && idx >= 0) ? filteredLearners[idx] : null;
            }

            function savePhaseToLearner() {
                const row = currentSelectedRow();
                if (!row) return;
                const phase = $phaseSel.value;
                $marksBody.querySelectorAll('tr').forEach(tr => {
                    const key = tr.dataset.key;
                    row[`${key}_${phase}`] = Number(tr.querySelector('input.score').value || 0);
                    row[`${key}_${phase}_OutOf`] = Number(tr.querySelector('input.outof').value || 0);
                });
                showUnsaved(true);
                renderSelected(Number($learnerSel.value));
                toast(`Saved marks for ${phase} phase âœ“`, 'success');
                setStatus('Marks saved', 'ok');
                saveStateToLocalStorage();
            }

            async function applyOutOfToAllLearners() {
                const confirmed = await confirmAction("This will apply the 'Out Of' values from the currently displayed learner to ALL learners in the workbook for this phase. This action cannot be undone. Are you sure you want to proceed?");
                if (!confirmed) return;
                const phase = $phaseSel.value;
                const template = {};
                $marksBody.querySelectorAll('tr').forEach(tr => {
                    const key = tr.dataset.key;
                    const outOf = tr.querySelector('input.outof').value;
                    if (outOf !== '' && !Number.isNaN(Number(outOf))) template[key] = Number(outOf);
                });
                if (!Object.keys(template).length) return;
                learners.forEach(r => {
                    for (const k in template) {
                        r[`${k}_${phase}_OutOf`] = template[k];
                    }
                });
                showUnsaved(true);
                if (currentSelectedRow()) renderSelected(Number($learnerSel.value));
                toast("'Out Of' values applied to ALL learners âœ“", 'success');
                setStatus("Applied 'Out Of' to all", 'ok');
                saveStateToLocalStorage();
            }

            function printRows(rows) {
                if (!rows || !rows.length) return;
                $batchContainer.innerHTML = rows.map(r => `<div class='sheet'>${htmlReport(r)}</div>`).join('');
                requestAnimationFrame(() => {
                    window.print();
                });
                toast('Opening print dialogâ€¦', 'warn', 1800);
                setStatus('Printingâ€¦', 'warn');
            }

            function updateMarksInPlace() {
                const ws = originalWb.Sheets[learnersSheetName];
                if (!ws) throw new Error(`Could not find the worksheet named '${learnersSheetName}'.`);
                const getRowNumByIndex = (index) => {
                    const learner = originalLearnersSnapshot.find(l => getIndex(l) == index);
                    return learner ? learner._rowNumber : -1;
                }
                learners.forEach(currentLearner => {
                    const learnerIndex = getIndex(currentLearner);
                    const rowNum = getRowNumByIndex(learnerIndex);
                    if (rowNum === -1) return;
                    MARK_KEYS.forEach(key => {
                        const c = headerIndexMap[key];
                        if (c === undefined) return;
                        const originalValue = originalLearnersSnapshot.find(l => getIndex(l) === learnerIndex) ?.[key];
                        const currentValue = currentLearner[key];
                        if (currentValue === originalValue) return;
                        const addr = XLSX.utils.encode_cell({
                            r: rowNum,
                            c
                        });
                        const val = currentValue ?? '';
                        if (ws[addr]) {
                            ws[addr].v = val;
                            ws[addr].t = (typeof val === 'number') ? 'n' : 's';
                        } else {
                            const headerAddr = XLSX.utils.encode_cell({
                                r: 0,
                                c
                            });
                            const headerCell = ws[headerAddr];
                            ws[addr] = {
                                v: val,
                                t: (typeof val === 'number') ? 'n' : 's'
                            };
                            if (headerCell && headerCell.s) {
                                ws[addr].s = JSON.parse(JSON.stringify(headerCell.s));
                            }
                        }
                    });
                });
            }

            function downloadUpdatedWorkbook() {
                if (!originalWb) {
                    toast('Please re-upload the original Excel file to download updates.', 'warn');
                    setStatus('Download failed', 'err', 'Original workbook not in memory.');
                    return;
                }
                setStatus('Generating Excel file...', 'warn');
                updateMarksInPlace();
                const ws = originalWb.Sheets[learnersSheetName];
                if (!ws) throw new Error('Learners worksheet missing at write time.');
                if (learnersSheetCols) ws['!cols'] = JSON.parse(JSON.stringify(learnersSheetCols));
                if (learnersSheetRows) ws['!rows'] = JSON.parse(JSON.stringify(learnersSheetRows));
                if (learnersSheetMerges) ws['!merges'] = JSON.parse(JSON.stringify(learnersSheetMerges));
                if (sheetSavedViews) ws['!views'] = JSON.parse(JSON.stringify(sheetSavedViews));
                if (originalWorkbookViews) {
                    originalWb.Workbook = originalWb.Workbook || {};
                    originalWb.Workbook.Views = JSON.parse(JSON.stringify(originalWorkbookViews));
                }
                if (originalWorkbookProps) {
                    originalWb.Props = JSON.parse(JSON.stringify(originalWorkbookProps));
                }
                const writeOpts = {
                    bookType: 'xlsx',
                    type: 'array',
                    bookSST: true,
                    cellStyles: true
                };
                const wbout = XLSX.write(originalWb, writeOpts);
                const blob = new Blob([wbout], {
                    type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
                });
                const filename = `EXCEL_updated_${new Date().toISOString().slice(0, 10)}.xlsx`;
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                setTimeout(() => {
                    URL.revokeObjectURL(url);
                    a.remove();
                }, 500);
                showUnsaved(false);
                toast('Downloaded updated Excel file', 'success');
                setStatus('Download complete âœ“', 'ok');
            }

            const processFile = withErrorUI(async (file) => {
                if (!file) return;
                resetUI();
                setStatus('Reading file...', 'warn', file.name);
                const data = await file.arrayBuffer();
                const wb = XLSX.read(data, {
                    type: 'array',
                    cellStyles: true,
                    bookSST: true
                });
                originalWb = wb;
                originalWorkbookViews = wb.Workbook?.Views ? JSON.parse(JSON.stringify(wb.Workbook.Views)) : null;
                originalWorkbookProps = wb.Props ? JSON.parse(JSON.stringify(wb.Props)) : null;
                learnersSheetName = wb.SheetNames.find(n => n.toLowerCase() === 'learners') || wb.SheetNames[0];
                const wsLearners = wb.Sheets[learnersSheetName];
                if (!wsLearners) throw new Error("A worksheet named 'Learners' was not found.");
                learnersSheetCols = wsLearners['!cols'] ? JSON.parse(JSON.stringify(wsLearners['!cols'])) : null;
                learnersSheetRows = wsLearners['!rows'] ? JSON.parse(JSON.stringify(wsLearners['!rows'])) : null;
                learnersSheetMerges = wsLearners['!merges'] ? JSON.parse(JSON.stringify(wsLearners['!merges'])) : null;
                sheetSavedViews = wsLearners['!views'] ? JSON.parse(JSON.stringify(wsLearners['!views'])) : null;
                const headerRows = XLSX.utils.sheet_to_json(wsLearners, {
                    header: 1,
                    defval: ''
                });
                const learnerHeaders = headerRows ?.[0] || [];
                headerIndexMap = {};
                learnerHeaders.forEach((h, i) => {
                    headerIndexMap[String(h)] = i;
                });
                learners = XLSX.utils.sheet_to_json(wsLearners, {
                    defval: ''
                });
                learners.forEach((learner, index) => {
                    learner._rowNumber = index + 1;
                });
                originalLearnersSnapshot = learners.map(o => ({ ...o }));
                const wsGrading = wb.Sheets['Grading'] || wb.Sheets['grading'];
                if (wsGrading) {
                    try {
                        const gradingRows = XLSX.utils.sheet_to_json(wsGrading, {
                            defval: ''
                        });
                        const mappedThresholds = gradingRows.map(r => ({
                            min: Number(r.Score),
                            grade: String(r.Grade || r.grade || '').trim()
                        })).filter(r => !Number.isNaN(r.min) && r.grade);
                        if (mappedThresholds.length >= 2) {
                            thresholds = mappedThresholds.sort((a, b) => b.min - a.min);
                        }
                    } catch (e) {
                        console.warn("Could not parse 'Grading' sheet, using defaults.", e);
                        thresholds = DEFAULT_THRESHOLDS;
                    }
                } else {
                    thresholds = DEFAULT_THRESHOLDS;
                }
                $mainContent.style.display = 'block';
                $dropZone.querySelector('p').style.display = 'none';
                $filename.textContent = file.name;
                hydrateGrades();
                clearFilters();
                showUnsaved(false);
                toast('Workbook loaded successfully', 'success');
                setStatus(`Loaded ${learners.length} learners âœ“`, 'Ready to edit or print.');
                attachHamburgerListener();
                document.dispatchEvent(new Event('fileUploadComplete'));
                saveStateToLocalStorage();
            });

            // --- Navigation Drawer Logic ---
            function toggleNavDrawer(open) {
                const isOpen = $navDrawer.classList.contains('open');
                if (open === isOpen) return; // Prevent redundant operations
                if (open) {
                    $navDrawer.classList.add('open');
                    $navBackdrop.classList.add('open');
                    $navDrawer.setAttribute('aria-hidden', 'false');
                    $hamburgerBtn.setAttribute('aria-expanded', 'true');
                } else {
                    $navDrawer.classList.remove('open');
                    $navBackdrop.classList.remove('open');
                    $navDrawer.setAttribute('aria-hidden', 'true');
                    $hamburgerBtn.setAttribute('aria-expanded', 'false');
                }
            }

            function handleNavLink(e, targetEl, options = {
                focus: false,
                click: false
            }) {
                e.preventDefault();
                if (targetEl) {
                    if (options.click) {
                        targetEl.click();
                    } else {
                        targetEl.scrollIntoView({
                            behavior: 'smooth',
                            block: 'start'
                        });
                        if (options.focus) targetEl.focus();
                    }
                }
                toggleNavDrawer(false);
            }

            // --- [FIX] Hamburger Stability ---
            function attachHamburgerListener() {
                // Remove the old one if it exists to prevent duplicates, then add it again.
                $hamburgerBtn.removeEventListener('click', hamburgerClickHandler);
                $hamburgerBtn.addEventListener('click', hamburgerClickHandler);
                $hamburgerBtn.disabled = false; // Also ensure it's not disabled
            }

            // --- [NEW] Lower Primary Edit Marks Functionality ---
            function enablePrimaryEditMarks() {
                if (currentMode === 'Primary' && learners.length > 0) {
                    const selectedLearner = currentSelectedRow();
                    if (selectedLearner) {
                        buildMarksGrid(selectedLearner);
                        renderSelected(Number(document.getElementById('learnerSel').value));
                        setStatus('Lower Primary marks editor ready', 'ok', 'You can now edit marks just like Junior School.');
                    }
                }
            }


            // --- Event Wiring ---
            function setupEventListeners() {
                attachHamburgerListener();
                $navBackdrop.addEventListener('click', () => toggleNavDrawer(false));
                $('#navLoadWorkbook').addEventListener('click', e => handleNavLink(e, $dropZone, {
                    click: true
                }));
                $('#navDetails').addEventListener('click', e => {
                    e.preventDefault();
                    $('#schoolNameInp').value = reportDetails.schoolName;
                    $('#assessmentTitleInp').value = reportDetails.titleTemplate;
                    $('#headteacherNameInp').value = reportDetails.headteacherName;
                    $detailsDlg.showModal();
                    toggleNavDrawer(false);
                });
                $('#navFilter').addEventListener('click', e => handleNavLink(e, $filtersPanel));
                $('#navEdit').addEventListener('click', e => handleNavLink(e, $editorPanel));

                // --- V2 Event Listeners ---
                $('#navSwitchPrimary').addEventListener('click', e => {
                    e.preventDefault();
                    updateActiveConfig('Primary');
                    toggleNavDrawer(false);
                });
                $('#navSwitchJunior').addEventListener('click', e => {
                    e.preventDefault();
                    updateActiveConfig('Junior');
                    toggleNavDrawer(false);
                });
                $('#navDownloadTemplate').addEventListener('click', () => toggleNavDrawer(false)); // Allow default link behavior
                $('#navDownloadPrimaryTemplate').addEventListener('click', () => toggleNavDrawer(false)); // Allow default link behavior for new link

                $('#navDownload').addEventListener('click', e => handleNavLink(e, $downloadExcelLink, {
                    click: true
                }));
                $('#navBatchPrint').addEventListener('click', e => handleNavLink(e, $printFilteredBtn, {
                    click: true
                }));
                $('#navPrintCurrent').addEventListener('click', e => {
                    e.preventDefault();
                    const row = currentSelectedRow();
                    if (row) {
                        printRows([row]);
                    } else {
                        toast('Please select a learner first', 'warn');
                    }
                    toggleNavDrawer(false);
                });
                $('#navClearSession').addEventListener('click', async (e) => {
                    e.preventDefault();
                    toggleNavDrawer(false);
                    const confirmed = await confirmAction("Are you sure you want to clear all saved data and reset the application? This cannot be undone.");
                    if (confirmed) {
                        localStorage.removeItem(STORAGE_KEY);
                        toast('Session cleared. The application will now reload.', 'success');
                        setTimeout(() => location.reload(), 1500);
                    }
                });

                // --- ADDED EVENT LISTENERS FOR NEW MENU ITEMS ---
                const $navEditLearnerDetails = $('#navEditLearnerDetails');
                const $navAddLearner = $('#navAddLearner');

                $navEditLearnerDetails.addEventListener('click', (e) => {
                    e.preventDefault();
                    console.log('Edit Learner Details clicked. Implement functionality.');
                    toast('Feature not yet implemented: Edit Learner Details', 'warn');
                    toggleNavDrawer(false); // Close menu after click
                });

                $navAddLearner.addEventListener('click', (e) => {
                    e.preventDefault();
                    console.log('Add New Learner clicked. Implement functionality.');
                    toast('Feature not yet implemented: Add New Learner', 'warn');
                    toggleNavDrawer(false); // Close menu after click
                });
                // --- END OF NEW EVENT LISTENERS ---

                $dropZone.addEventListener('click', () => $fileInput.click());
                $fileInput.addEventListener('change', (e) => processFile(e.target.files ?.[0]));
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    $dropZone.addEventListener(eventName, e => {
                        e.preventDefault();
                        e.stopPropagation();
                    });
                });
                $dropZone.addEventListener('dragenter', () => $dropZone.classList.add('dragover'));
                $dropZone.addEventListener('dragover', () => $dropZone.classList.add('dragover'));
                $dropZone.addEventListener('dragleave', () => $dropZone.classList.remove('dragover'));
                $dropZone.addEventListener('drop', (e) => {
                    $dropZone.classList.remove('dragover');
                    processFile(e.dataTransfer.files ?.[0]);
                });

                $learnerSel.addEventListener('change', e => renderSelected(Number(e.target.value)));
                $phaseSel.addEventListener('change', () => {
                    if (currentSelectedRow()) buildMarksGrid(currentSelectedRow());
                });
                $savePhaseBtn.addEventListener('click', withErrorUI(savePhaseToLearner));
                $applyOutOfAllBtn.addEventListener('click', withErrorUI(applyOutOfToAllLearners));
                $printSelectedBtn.addEventListener('click', () => {
                    const row = currentSelectedRow();
                    if (row) printRows([row]);
                });
                $printFilteredBtn.addEventListener('click', () => printRows(filteredLearners));
                $downloadExcelLink.addEventListener('click', e => {
                    if ($downloadExcelLink.getAttribute('aria-disabled') === 'true') {
                        e.preventDefault();
                        toast('No unsaved changes to download', 'warn');
                    } else {
                        withErrorUI(downloadUpdatedWorkbook)();
                    }
                });
                $applyFiltersBtn.addEventListener('click', withErrorUI(applyFilters));
                $clearFiltersBtn.addEventListener('click', withErrorUI(clearFilters));
                $('#copyErrBtn').addEventListener('click', async () => {
                    try {
                        await navigator.clipboard.writeText($errDetails.textContent || '');
                        toast('Copied!', 'success', 1000);
                    } catch (e) {
                        alert('Copy failed.');
                    }
                });
                $('#closeErrBtn').addEventListener('click', () => $errorDlg.close());
                $('#detailsCancelBtn').addEventListener('click', () => $detailsDlg.close());
                $('#detailsSaveBtn').addEventListener('click', () => {
                    reportDetails.schoolName = $('#schoolNameInp').value;
                    reportDetails.titleTemplate = $('#assessmentTitleInp').value;
                    reportDetails.headteacherName = $('#headteacherNameInp').value;
                    toast('Details saved. The current report preview is updated.', 'success');
                    $detailsDlg.close();
                    if (currentSelectedRow()) {
                        renderSelected(Number($learnerSel.value));
                    }
                    saveStateToLocalStorage();
                });

                window.addEventListener('afterprint', () => {
                    $batchContainer.innerHTML = '';
                    setStatus('Ready', '', 'Idle.');
                });
                window.addEventListener('error', (e) => withErrorUI(() => {
                    throw e.error;
                })());
                window.addEventListener('unhandledrejection', (e) => withErrorUI(() => {
                    throw e.reason;
                })());
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && $navDrawer.classList.contains('open')) {
                        toggleNavDrawer(false);
                    }
                });

                // Listen for custom events to enable primary marks editing
                document.addEventListener('modeChange', enablePrimaryEditMarks);
                document.addEventListener('fileUploadComplete', enablePrimaryEditMarks);
            }
            // --- Initialize the application ---
            setupEventListeners();
            loadStateFromLocalStorage();
        })();
  </script>
 </body>
</html>
