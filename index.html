<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CBC Report Form – Pro + Editor (Marks & Comments • Save to Excel)</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js" defer></script>
<style>
  :root{
    --page-w: 210mm; --page-h: 297mm; --margin: 10mm; --content-w: calc(var(--page-w) - 2*var(--margin));
    --accent:#0b3d91; --border:#333; --bg:#f4f6f8; --font:"Segoe UI", Roboto, Arial, sans-serif;
  }
  html,body{height:100%;margin:0;background:var(--bg);font-family:var(--font);color:#111}
  .app{max-width:1280px;margin:16px auto;padding:16px}
  .bar{display:flex;flex-wrap:wrap;gap:12px;align-items:center;background:#fff;padding:12px;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,.06)}
  .group{display:flex;gap:8px;align-items:center}
  .group label{font-size:.95rem;color:#333;white-space:nowrap}
  select,input[type=text],input[type=number],textarea{padding:8px 10px;border:1px solid #ccc;border-radius:6px;min-width:120px;font-family:var(--font)}
  input[type=file]{border:1px dashed #aaa;padding:8px;border-radius:6px;background:#fafafa}
  button{padding:10px 12px;background:var(--accent);color:#fff;border:none;border-radius:6px;cursor:pointer}
  button.secondary{background:#5b6f94}button.danger{background:#b9372b}button:disabled{background:#9bb1e1;cursor:not-allowed}
  .panel{background:#fff;border:1px solid #e6e6e6;border-radius:8px;padding:12px;margin-top:12px}
  .panel h3{margin:0 0 8px 0;font-size:1.05rem}
  .two-col{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .editor-grid{width:100%;border-collapse:collapse;font-size:13px}
  .editor-grid th,.editor-grid td{border:1px solid #ddd;padding:6px}
  .editor-grid th{background:#f0f4ff;text-align:left}
  .muted{color:#666;font-size:.9rem}
  .chip{display:inline-flex;align-items:center;gap:6px;background:#eef2ff;color:#0b3d91;border:1px solid #ccd6ff;border-radius:999px;padding:2px 8px;font-size:12px}
  #singleView .sheet{width:var(--content-w);min-height:calc(var(--page-h) - 2*var(--margin));background:#fff;margin:16px auto;padding:16mm 14mm;box-sizing:border-box;border:1px solid #ddd;border-radius:8px}
  .school-head{text-align:center;line-height:1.15;margin-bottom:8px}
  .school-head h1{margin:0;font-size:22px;letter-spacing:.5px}
  .school-head .addr{font-size:12px;color:#333}.school-head .motto{margin-top:2px;font-weight:600;color:#0b3d91;font-size:12px}
  .key{font-size:11px;color:#333;text-align:center;margin:6px 0 4px}.title{text-align:center;font-weight:700;margin:6px 0 12px;font-size:14px}
  .meta{display:grid;grid-template-columns:1fr 1fr;gap:6px 16px;border:1px solid var(--border);padding:6px 10px;font-size:12px;margin-bottom:10px}
  .meta div{display:flex;gap:6px}.meta label{font-weight:600;min-width:120px}
  table.report{width:100%;border-collapse:collapse;font-size:12px;margin-top:6px}
  table.report th,table.report td{border:1px solid #000;padding:5px 6px;text-align:center}
  table.report th{background:#eef2ff;font-weight:700}table.report td.label{text-align:left;font-weight:600}
  .comments{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;font-size:12px}
  .comments .block{border:1px solid var(--border);padding:8px;min-height:56px}
  .sign-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:6px}
  .sign{border:1px solid var(--border);padding:6px;min-height:40px;font-size:12px}
  .foot-dates{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px;font-size:12px}
  .small{color:#555;font-size:11px}.consent{margin-top:6px;font-size:10.5px;color:#444}
  #batchContainer{display:none}#batchContainer .sheet{width:auto;min-height:auto;padding:0;margin:0}
  @media print{@page{size:A4 portrait;margin:10mm}body{background:#fff}.bar,.panel{display:none!important}#singleView{display:none!important}#batchContainer{display:block!important}.sheet{width:auto;min-height:auto;margin:0;border:none;border-radius:0;padding:0;page-break-after:always}.sheet:last-child{page-break-after:auto}}
  dialog#errorDlg{border:1px solid #c00;border-radius:8px;padding:0;max-width:760px;width:90%}.dlg-hd{background:#ffecec;color:#a00;padding:10px 12px;font-weight:700;border-bottom:1px solid #f6caca}.dlg-bd{padding:12px}.dlg-ft{padding:10px 12px;display:flex;gap:8px;justify-content:flex-end;border-top:1px solid #eee}pre.err{background:#fafafa;border:1px solid #eee;padding:8px;max-height:240px;overflow:auto}
</style>
</head>
<body>
<div class="app">
  <!-- Top bar -->
  <div class="bar">
    <div class="group"><label>Workbook (.xlsx):</label><input id="file" type="file" accept=".xlsx,.xls" /></div>
    <div class="group"><label>Learner:</label><select id="learnerSel" disabled></select></div>
    <div class="group"><button id="printSelectedBtn" disabled>Print selected</button><button id="printFilteredBtn" disabled>Batch Print (filtered)</button></div>
    <div class="group"><button id="saveToExcelBtn" class="secondary" disabled>Save changes to Excel</button><span class="chip" id="unsavedChip" style="display:none">Unsaved changes</span></div>
    <div class="group"><span class="muted">All processing is local in your browser.</span></div>
  </div>

  <!-- Filters (kept minimal here for brevity) -->
  <div class="panel" id="filtersPanel">
    <h3>Filters</h3>
    <div class="bar" style="gap:16px;box-shadow:none;padding:8px;">
      <div class="group"><label>Gender:</label><select id="fGender"><option value="">All</option><option>M</option><option>F</option></select></div>
      <div class="group"><label>Grade:</label><select id="fGrade"><option value="">All</option></select></div>
      <div class="group"><button id="applyFiltersBtn" class="secondary" disabled>Apply</button><button id="clearFiltersBtn" class="secondary" disabled>Clear</button><span class="chip" id="matchCountChip">0 selected</span></div>
    </div>
  </div>

  <!-- EDITOR -->
  <div class="panel" id="editorPanel">
    <h3>Edit marks & comments (writes back to Learners sheet)</h3>
    <div class="bar" style="gap:16px;box-shadow:none;padding:8px;">
      <div class="group"><label>Phase:</label>
        <select id="phaseSel"><option value="Opener">Opener</option><option value="Mid">Midterm</option><option value="End">End term</option></select>
      </div>
      <div class="group"><button id="savePhaseBtn" disabled>Save phase to learner</button><button id="applyOutOfAllBtn" class="secondary" disabled>Apply Out Of (this phase) to ALL learners</button></div>
    </div>

    <div class="two-col">
      <div>
        <table class="editor-grid" id="marksGrid" aria-label="Marks editor">
          <thead><tr><th>Learning Area</th><th>Score</th><th>Out Of</th></tr></thead>
          <tbody id="marksBody"></tbody>
        </table>
      </div>
      <div>
        <table class="editor-grid" aria-label="Comments editor">
          <thead><tr><th colspan="2">Comments & Dates</th></tr></thead>
          <tbody>
            <tr><td>Class Teacher Comment</td><td><textarea id="ctComment" rows="2"></textarea></td></tr>
            <tr><td>Class Teacher Name</td><td><input id="ctName" type="text"/></td></tr>
            <tr><td>CT Date</td><td><input id="ctDate" type="text" placeholder="YYYY-MM-DD"/></td></tr>
            <tr><td>Head Teacher Comment</td><td><textarea id="htComment" rows="2"></textarea></td></tr>
            <tr><td>Head Teacher Signature</td><td><input id="htSign" type="text"/></td></tr>
            <tr><td>HT Date</td><td><input id="htDate" type="text" placeholder="YYYY-MM-DD"/></td></tr>
            <tr><td>Parent Comment</td><td><textarea id="pComment" rows="2"></textarea></td></tr>
            <tr><td>Parent Name</td><td><input id="pName" type="text"/></td></tr>
            <tr><td>Parent Signature</td><td><input id="pSign" type="text"/></td></tr>
            <tr><td>Parent Date</td><td><input id="pDate" type="text" placeholder="YYYY-MM-DD"/></td></tr>
            <tr><td>Closing Date</td><td><input id="closingDate" type="text" placeholder="YYYY-MM-DD"/></td></tr>
            <tr><td>Opening Date</td><td><input id="openingDate" type="text" placeholder="YYYY-MM-DD"/></td></tr>
          </tbody>
        </table>
        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap"><button id="saveCommentsBtn" disabled>Save comments to learner</button></div>
      </div>
    </div>
  </div>

  <!-- Preview -->
  <div id="singleView"><div class="sheet" id="singleSheet" aria-label="Report Form"></div></div>
  <div id="batchContainer" aria-hidden="true"></div>
</div>

<!-- Error UI -->
<dialog id="errorDlg"><div class="dlg-hd">Something went wrong</div><div class="dlg-bd"><p>We hit a problem while processing your data.</p><pre class="err" id="errDetails"></pre></div><div class="dlg-ft"><button id="copyErrBtn" class="secondary">Copy error details</button><button id="closeErrBtn">Close</button></div></dialog>

<script>
(function(){
  const SUBJECTS = [
    { key:'ENG',    label:'ENGLISH' },
    { key:'COMP',   label:'COMPOSITION' },
    { key:'KISW',   label:'KISWAHILI' },
    { key:'INSHA',  label:'INSHA' },
    { key:'MATH',   label:'MATHEMATICS' },
    { key:'SCIE',   label:'INTER/SCIE' },
    { key:'SST',    label:'S/S' },
    { key:'CRE',    label:'CRE' },
    { key:'AGRI',   label:'AGRI/NUT' },
    { key:'CA',     label:'C/ART' },
    { key:'PRETECH',label:'PRE-TECH' },
  ];
  const DEFAULT_THRESHOLDS = [{min:81,grade:'EE'},{min:50,grade:'ME'},{min:26,grade:'AE'},{min:0,grade:'BE'}];

  // DOM
  const $ = sel => document.querySelector(sel);
  const $file = $('#file');
  const $learnerSel = $('#learnerSel');
  const $printSelectedBtn = $('#printSelectedBtn');
  const $printFilteredBtn = $('#printFilteredBtn');
  const $saveToExcelBtn = $('#saveToExcelBtn');
  const $unsavedChip = $('#unsavedChip');

  const $fGender = $('#fGender');
  const $fGrade = $('#fGrade');
  const $applyFiltersBtn = $('#applyFiltersBtn');
  const $clearFiltersBtn = $('#clearFiltersBtn');
  const $matchCountChip = $('#matchCountChip');

  const $phaseSel = $('#phaseSel');
  const $marksBody = $('#marksBody');
  const $savePhaseBtn = $('#savePhaseBtn');
  const $applyOutOfAllBtn = $('#applyOutOfAllBtn');

  const $ctComment = $('#ctComment');
  const $ctName = $('#ctName');
  const $ctDate = $('#ctDate');
  const $htComment = $('#htComment');
  const $htSign = $('#htSign');
  const $htDate = $('#htDate');
  const $pComment = $('#pComment');
  const $pName = $('#pName');
  const $pSign = $('#pSign');
  const $pDate = $('#pDate');
  const $closingDate = $('#closingDate');
  const $openingDate = $('#openingDate');
  const $saveCommentsBtn = $('#saveCommentsBtn');

  const $singleSheet = $('#singleSheet');
  const $batchContainer = $('#batchContainer');

  const $errDlg = $('#errorDlg');
  const $errDetails = $('#errDetails');
  const $copyErrBtn = $('#copyErrBtn');
  const $closeErrBtn = $('#closeErrBtn');

  // State
  let learners = [];
  let thresholds = DEFAULT_THRESHOLDS;
  let filtered = [];
  let originalWb = null; // original workbook object (for saving back)
  let learnerHeaders = null; // to preserve column order when rewriting
  let unsaved = false;

  function showUnsaved(flag){ unsaved = flag; $unsavedChip.style.display = flag ? 'inline-flex':'none'; $saveToExcelBtn.disabled = !flag; }

  function withErrorUI(fn){ return async (...args)=>{ try{ return await fn(...args); } catch(err){ console.error(err); const details = `Message: ${err?.message||err}\n\nStack:\n${err?.stack||'(no stack)'}\n`; $errDetails.textContent = details; $errDlg.showModal(); } } }

  function getIndex(row){ const v = row.Index ?? row.index ?? row.INDEX; const n = Number(v); return Number.isNaN(n)?NaN:(Number.isInteger(n)?n:Math.round(n)); }

  function pctGrade(score, outOf){ if(outOf<=0||score==null||score==='') return{pct:0,grade:'BE'}; const pct=Math.max(0,Math.round((Number(score)/Number(outOf))*100)); const t=thresholds.find(t=>pct>=t.min)||{grade:'BE'}; return{pct,grade:t.grade}; }

  function escapeHTML(s){ return String(s).replace(/[&<>"']/g, (c)=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

  function termWord(n){ const names={1:'ONE',2:'TWO',3:'THREE'}; return names[n]||String(n); }

  function htmlReport(row){
    const school = {name:'ITIATI JUNIOR SCHOOL', address1:'P.O. BOX 160-10101', town:'KARATINA', motto:'SCHOOL MOTTO: HARDWORK FOR EXCELLENCE'};
    const pupilName = row["Pupil's Name"]||row["Pupil Name"]||''; const grade=row["Grade"]??''; const term=row["Term"]??''; const year=row["Year"]??'';
    const ctComment=row["Class_Teacher_Comment"]||''; const ctName=row["Class_Teacher_Name"]||''; const ctDate=row["CT_Date"]||'';
    const htComment=row["Head_Teacher_Comment"]||''; const htSign=row["Head_Teacher_Signature"]||row["Head_Teacher_Sign"]||''; const htDate=row["HT_Date"]||'';
    const closingDate=row["Closing_Date"]||row["Closing Date"]||''; const openingDate=row["Opening_Date"]||row["Opening Date"]||'';

    const subRows = SUBJECTS.map(s=>{
      const oSc=Number(row[`${s.key}_Opener`])||0, oMax=Number(row[`${s.key}_Opener_OutOf`])||0;
      const mSc=Number(row[`${s.key}_Mid`])||0,    mMax=Number(row[`${s.key}_Mid_OutOf`])||0;
      const eSc=Number(row[`${s.key}_End`])||0,    eMax=Number(row[`${s.key}_End_OutOf`])||0;
      const oG=pctGrade(oSc,oMax).grade, mG=pctGrade(mSc,mMax).grade, eG=pctGrade(eSc,eMax).grade;
      return {label:s.label,oSc,oMax,oG,mSc,mMax,mG,eSc,eMax,eG};
    });
    const total=subRows.reduce((a,r)=>{a.oSc+=r.oSc;a.oMax+=r.oMax;a.mSc+=r.mSc;a.mMax+=r.mMax;a.eSc+=r.eSc;a.eMax+=r.eMax;return a;},{oSc:0,oMax:0,mSc:0,mMax:0,eSc:0,eMax:0});
    const oG=pctGrade(total.oSc,total.oMax).grade, mG=pctGrade(total.mSc,total.mMax).grade, eG=pctGrade(total.eSc,total.eMax).grade;

    const title=`END TERM ${termWord(Number(term))} ASSESSMENT - YEAR ${year}`;
    return `
    <div class="school-head"><h1>${school.name}</h1><div class="addr">${school.address1}</div><div class="addr">${school.town}</div><div class="motto">${school.motto}</div></div>
    <div class="key">KEY: <b>EE</b> – Exceed Expectations, <b>ME</b> – Meet Expectations, <b>AE</b> – Approach Expectation, <b>BE</b> – Below Expectation</div>
    <div class="title">${title}</div>
    <div class="meta"><div><label>PUPIL'S NAME:</label><div>${escapeHTML(pupilName)}</div></div><div><label>GRADE:</label><div>${escapeHTML(String(grade))}</div></div></div>
    <table class="report"><thead><tr><th rowspan="2">LEARNING AREA</th><th colspan="3">OPENER</th><th colspan="3">MIDTERM</th><th colspan="3">END TERM</th></tr><tr><th>OUT OF</th><th>SCORE</th><th>GRADE</th><th>OUT OF</th><th>SCORE</th><th>GRADE</th><th>OUT OF</th><th>SCORE</th><th>GRADE</th></tr></thead>
    <tbody>${subRows.map(r=>`<tr><td class="label">${r.label}</td><td>${r.oMax}</td><td>${r.oSc}</td><td>${r.oG}</td><td>${r.mMax}</td><td>${r.mSc}</td><td>${r.mG}</td><td>${r.eMax}</td><td>${r.eSc}</td><td>${r.eG}</td></tr>`).join('')}</tbody>
    <tfoot><tr class="totals"><th class="label">TOTAL MARK</th><th>${total.oMax}</th><th>${total.oSc}</th><th>${oG}</th><th>${total.mMax}</th><th>${total.mSc}</th><th>${mG}</th><th>${total.eMax}</th><th>${total.eSc}</th><th>${eG}</th></tr></tfoot></table>
    <div class="comments"><div class="block"><label>CLASS TEACHER COMMENT:</label><div>${escapeHTML(ctComment)||'&nbsp;'}</div><div class="sign-row"><div class="sign"><b>CLASS TEACHER NAME:</b> ${escapeHTML(ctName)||'&nbsp;'}</div><div class="sign"><b>DATE:</b> ${escapeHTML(ctDate)||'&nbsp;'}</div></div></div>
    <div class="block"><label>HEAD TEACHER COMMENT:</label><div>${escapeHTML(htComment)||'&nbsp;'}</div><div class="sign-row"><div class="sign"><b>Signature:</b> ${escapeHTML(htSign)||'&nbsp;'}</div><div class="sign"><b>Date:</b> ${escapeHTML(htDate)||'&nbsp;'}</div></div></div></div>
    <div class="foot-dates"><div class="sign"><b>CLOSING DATE:</b> ${escapeHTML(closingDate)||'&nbsp;'}</div><div class="sign"><b>OPENING DATE:</b> ${escapeHTML(openingDate)||'&nbsp;'}</div></div>
    <div class="small" style="margin-top:8px;">Note: Use the browser’s Print dialog to save as PDF (A4 portrait, 100% scale).</div>`;
  }

  function hydrateGrades(){ const grades = Array.from(new Set(learners.map(r=>String(r.Grade||'').trim()).filter(Boolean))).sort(); $('#fGrade').innerHTML = '<option value="">All</option>'+grades.map(g=>`<option>${g}</option>`).join(''); }

  function applyFilters(){ const g=($fGender.value||'').trim().toUpperCase(); const grade=($fGrade.value||'').trim(); filtered = learners.filter(r=>{ if(g&&String(r.Gender||'').trim().toUpperCase()!==g) return false; if(grade&&String(r.Grade||'').trim()!==grade) return false; return true; }).sort((a,b)=>getIndex(a)-getIndex(b)); hydrateLearnerDropdown(); if(filtered.length){ $learnerSel.selectedIndex=1; renderSelected(0);} else { $singleSheet.innerHTML='<p>No learners match filters.</p>'; } }
  function clearFilters(){ $fGender.value=''; $fGrade.value=''; filtered=[...learners].sort((a,b)=>getIndex(a)-getIndex(b)); hydrateLearnerDropdown(); if(filtered.length){ $learnerSel.selectedIndex=1; renderSelected(0);} }

  function hydrateLearnerDropdown(){ $learnerSel.innerHTML = '<option value="">— Select learner —</option>'+ filtered.map((r,i)=>{ const idx=getIndex(r); const labelIdx=Number.isNaN(idx)?(i+1):idx; const name=r["Pupil's Name"]||`Learner ${i+1}`; return `<option value="${i}">${labelIdx}. ${escapeHTML(name)}</option>`; }).join(''); const has=filtered.length>0; [$learnerSel,$printSelectedBtn,$printFilteredBtn,$applyFiltersBtn,$clearFiltersBtn].forEach(el=>el.disabled=!learners.length); $matchCountChip.textContent=`${filtered.length} selected`; $savePhaseBtn.disabled=!has; $applyOutOfAllBtn.disabled=!has; $saveCommentsBtn.disabled=!has; $saveToExcelBtn.disabled=!unsaved; }

  function renderSelected(i){ const row=filtered[i]; if(!row) return; // preview
    $singleSheet.innerHTML = htmlReport(row);
    // build edit grid
    buildMarksGrid(row);
    // load comments
    $ctComment.value=row["Class_Teacher_Comment"]||''; $ctName.value=row["Class_Teacher_Name"]||''; $ctDate.value=row["CT_Date"]||'';
    $htComment.value=row["Head_Teacher_Comment"]||''; $htSign.value=row["Head_Teacher_Signature"]||row["Head_Teacher_Sign"]||''; $htDate.value=row["HT_Date"]||'';
    $pComment.value=row["Parent_Comment"]||''; $pName.value=row["Parent_Name"]||''; $pSign.value=row["Parent_Signature"]||''; $pDate.value=row["Parent_Date"]||'';
    $closingDate.value=row["Closing_Date"]||row["Closing Date"]||''; $openingDate.value=row["Opening_Date"]||row["Opening Date"]||'';
  }

  function buildMarksGrid(row){ const phase=$phaseSel.value; const rows = SUBJECTS.map(s=>{ const score = row[`${s.key}_${phase}`] ?? ''; const outOf = row[`${s.key}_${phase}_OutOf`] ?? ''; return `<tr data-key="${s.key}"><td>${s.label}</td><td><input type="number" step="0.01" class="score" value="${score}"></td><td><input type="number" step="0.01" class="outof" value="${outOf}"></td></tr>`; }).join(''); $marksBody.innerHTML=rows; }

  function currentSelectedRow(){ const idx = Number($learnerSel.value); return Number.isInteger(idx)&&idx>=0? filtered[idx] : null; }

  function savePhaseToLearner(){ const row=currentSelectedRow(); if(!row) return; const phase=$phaseSel.value; // read grid
    $marksBody.querySelectorAll('tr').forEach(tr=>{ const key=tr.getAttribute('data-key'); const score=Number(tr.querySelector('input.score').value||0); const outOf=Number(tr.querySelector('input.outof').value||0); row[`${key}_${phase}`]=score; row[`${key}_${phase}_OutOf`]=outOf; });
    showUnsaved(true); // refresh preview
    $singleSheet.innerHTML = htmlReport(row);
  }

  function applyOutOfToAllLearners(){ const phase=$phaseSel.value; // build template from grid
    const template={}; $marksBody.querySelectorAll('tr').forEach(tr=>{ const key=tr.getAttribute('data-key'); const outOf=tr.querySelector('input.outof').value; if(outOf!=='' && !Number.isNaN(Number(outOf))) template[key]=Number(outOf); });
    if(Object.keys(template).length===0) return;
    learners.forEach(r=>{ for(const k in template){ r[`${k}_${phase}_OutOf`]=template[k]; } });
    showUnsaved(true);
    // also refresh current preview totals/grades
    const row=currentSelectedRow(); if(row){ $singleSheet.innerHTML=htmlReport(row); }
  }

  function saveCommentsToLearner(){ const row=currentSelectedRow(); if(!row) return; row["Class_Teacher_Comment"]=$ctComment.value; row["Class_Teacher_Name"]=$ctName.value; row["CT_Date"]=$ctDate.value; row["Head_Teacher_Comment"]=$htComment.value; row["Head_Teacher_Signature"]=$htSign.value; row["HT_Date"]=$htDate.value; row["Parent_Comment"]=$pComment.value; row["Parent_Name"]=$pName.value; row["Parent_Signature"]=$pSign.value; row["Parent_Date"]=$pDate.value; row["Closing_Date"]=$closingDate.value; row["Opening_Date"]=$openingDate.value; showUnsaved(true); $singleSheet.innerHTML = htmlReport(row); }

  function printRows(rows){ if(!rows.length) return; $batchContainer.innerHTML = rows.map(htmlReport).join(''); requestAnimationFrame(()=>{ window.print(); setTimeout(()=>{ $batchContainer.innerHTML=''; }, 600); }); }

  function updateWorkbookAndDownload(){ if(!originalWb) return; // Preserve other sheets; replace Learners with updated data keeping header order
    const wb = originalWb; // mutate in place
    const headers = learnerHeaders || Array.from(new Set(learners.reduce((a,r)=>{ Object.keys(r).forEach(k=>{ if(!a.includes(k)) a.push(k); }); return a; }, [])));
    const data = [headers].concat(learners.map(r=> headers.map(h=> r[h]!==undefined?r[h]:'')));
    const ws = XLSX.utils.aoa_to_sheet(data);
    wb.Sheets['Learners'] = ws;
    // Ensure sheet order: keep original names
    const filename = (wb.Props && wb.Props.Title ? wb.Props.Title : 'REPORT_FORM_G7') + '_updated.xlsx';
    XLSX.writeFile(wb, filename);
    showUnsaved(false);
  }

  // Events
  $learnerSel.addEventListener('change', e=>{ const i=Number(e.target.value); if(Number.isInteger(i)&&i>=0) renderSelected(i); });
  $phaseSel.addEventListener('change', ()=>{ const i=Number($learnerSel.value); if(Number.isInteger(i)&&i>=0) buildMarksGrid(filtered[i]); });
  $savePhaseBtn.addEventListener('click', savePhaseToLearner);
  $applyOutOfAllBtn.addEventListener('click', applyOutOfToAllLearners);
  $saveCommentsBtn.addEventListener('click', saveCommentsToLearner);
  $printSelectedBtn.addEventListener('click', ()=>{ const idx=Number($learnerSel.value); const chosen=(Number.isInteger(idx)&&idx>=0)?[filtered[idx]]:(filtered.length?[filtered[0]]:[]); printRows(chosen); });
  $printFilteredBtn.addEventListener('click', ()=> printRows(filtered));
  $applyFiltersBtn.addEventListener('click', applyFilters);
  $clearFiltersBtn.addEventListener('click', clearFilters);
  $saveToExcelBtn.addEventListener('click', updateWorkbookAndDownload);

  $copyErrBtn.addEventListener('click', async()=>{ try{ await navigator.clipboard.writeText($errDetails.textContent||''); $copyErrBtn.textContent='Copied!'; setTimeout(()=>{$copyErrBtn.textContent='Copy error details';},1200);}catch(e){ alert('Copy failed. Select and copy manually.'); } });
  $closeErrBtn.addEventListener('click', ()=> $errDlg.close());

  window.addEventListener('error', (e)=>{ $errDetails.textContent = e.error?.stack || e.message || 'Unknown error'; $errDlg.showModal(); });
  window.addEventListener('unhandledrejection', (e)=>{ $errDetails.textContent = (e.reason&&e.reason.stack)||String(e.reason)||'Unhandled rejection'; $errDlg.showModal(); });

  $file.addEventListener('change', withErrorUI(async(ev)=>{
    const f=ev.target.files?.[0]; if(!f) return; const data=await f.arrayBuffer(); const wb=XLSX.read(data,{type:'array'}); originalWb=wb;
    // Extract headers for Learners
    const wsLearners = wb.Sheets['Learners'] || wb.Sheets['LEARNERS'] || wb.Sheets[wb.SheetNames[0]];
    const headerRows = XLSX.utils.sheet_to_json(wsLearners, {header:1}); learnerHeaders = headerRows && headerRows[0] ? headerRows[0] : null;
    learners = XLSX.utils.sheet_to_json(wsLearners, {defval:''});
    const wsGrading = wb.Sheets['Grading'] || wb.Sheets['grading'] || wb.Sheets['GRADING'];
    thresholds = wsGrading ? (function parse(ws){ try{ const rows = XLSX.utils.sheet_to_json(ws,{defval:''}); const map = rows.filter(r=> (r.Grade||r.grade) && (r.Score!==undefined && r.Score!=='')) .map(r=>({min:Number(r.Score),grade:String(r.Grade||r.grade).trim()})).filter(r=>!Number.isNaN(r.min)&&['EE','ME','AE','BE'].includes(r.grade)); if(map.length>=4){ map.sort((a,b)=>b.min-a.min); return map; } }catch(e){} return DEFAULT_THRESHOLDS; })(wsGrading) : DEFAULT_THRESHOLDS;

    // Filters
    hydrateGrades(); filtered=[...learners].sort((a,b)=>getIndex(a)-getIndex(b));
    hydrateLearnerDropdown(); if(filtered.length){ $learnerSel.selectedIndex=1; renderSelected(0); }
    showUnsaved(false);
  }));
})();
</script>
</body>
</html>
