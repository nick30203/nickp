<!doctype html>
<html lang="en">
  <head>
    <meta
      name="generator"
      content="HTML Tidy for HTML5 for Linux version 5.9.14"
    />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Grade 7 Mathematics Challenge</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="" />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&amp;display=swap"
      rel="stylesheet"
    />
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [["$", "$"]],
          displayMath: [["$$", "$$"]],
          processEscapes: true,
        },
        options: { renderActions: { addMenu: [] } },
      };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script
      id="MathJax-script"
      async
      src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"
    ></script>
    <style>
      :root {
        --primary-color: #4a90e2;
        --secondary-color: #50e3c2;
        --background-color: #f4f7f6;
        --text-color: #333;
        --card-bg-color: #ffffff;
        --correct-color: #28a745;
        --incorrect-color: #dc3545;
        --warning-color: #f44336;
        --border-color: #e0e0e0;
      }
      body {
        font-family: "Poppins", Arial, sans-serif;
        line-height: 1.6;
        margin: 0;
        padding: 20px;
        color: var(--text-color);
        background-color: var(--background-color);
      }
      .container {
        max-width: 900px;
        margin: 0 auto;
      }
      .header {
        text-align: center;
        margin-bottom: 20px;
        padding: 20px;
        background: var(--card-bg-color);
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
      }
      .header h1 {
        color: var(--primary-color);
        margin: 0;
        font-size: 2.1em;
      }
      .header .credits {
        font-style: italic;
        font-size: 0.9em;
        color: #777;
        margin-top: 10px;
      }
      #timer-container {
        text-align: center;
        font-size: 1.3em;
        font-weight: 600;
        margin-bottom: 20px;
        padding: 10px;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.07);
        color: var(--primary-color);
      }
      .progress-container {
        width: 100%;
        background: var(--border-color);
        border-radius: 10px;
        margin-bottom: 25px;
        height: 15px;
        overflow: hidden;
      }
      #progress-bar {
        height: 100%;
        width: 0%;
        background: linear-gradient(
          90deg,
          var(--secondary-color),
          var(--primary-color)
        );
        border-radius: 10px;
        transition: width 0.4s ease-in-out;
      }
      .section-title {
        background: var(--primary-color);
        color: #fff;
        padding: 12px 20px;
        margin: 40px 0 20px;
        border-radius: 8px;
        font-size: 1.3em;
        box-shadow: 0 4px 10px rgba(74, 144, 226, 0.3);
      }
      .question-list {
        list-style: none;
        padding: 0;
      }
      .question-item {
        background: var(--card-bg-color);
        padding: 20px;
        margin-bottom: 20px;
        border: 1px solid var(--border-color);
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        transition: transform 0.2s;
      }
      .question-item:hover {
        transform: translateY(-3px);
      }
      .question-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 15px;
      }
      .question-number {
        background: var(--primary-color);
        color: #fff;
        font-weight: 700;
        min-width: 30px;
        height: 30px;
        border-radius: 50%;
        display: grid;
        place-items: center;
        font-size: 0.9em;
      }
      .question-text {
        font-weight: 600;
        color: #444;
      }
      .mc-options label {
        display: block;
        margin-bottom: 8px;
        cursor: pointer;
        padding: 10px;
        border-radius: 5px;
        border: 1px solid var(--border-color);
        transition:
          background-color 0.2s,
          border-color 0.2s;
      }
      .mc-options label:hover {
        background: #eef5ff;
        border-color: var(--primary-color);
      }
      .mc-options input[type="radio"] {
        margin-right: 12px;
        accent-color: var(--primary-color);
      }
      .mc-options.locked label {
        cursor: default;
      }
      .mc-options.locked label:hover {
        background: transparent;
        border-color: var(--border-color);
      }
      .mc-options.locked input[type="radio"]:not(:checked) + span {
        color: #aaa;
      }
      .structured-answer-area input[type="text"] {
        padding: 10px;
        width: 100%;
        border: 1px solid #ccc;
        border-radius: 5px;
        box-sizing: border-box;
        margin-top: 5px;
        font-family: "Poppins", sans-serif;
      }
      .structured-answer-area input[type="text"]:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 5px rgba(74, 144, 226, 0.5);
      }
      .structured-answer-area.locked input[type="text"] {
        background: #f0f0f0;
        cursor: not-allowed;
        border-color: #ccc;
      }
      .question-image {
        max-width: 100%;
        height: auto;
        display: block;
        margin: 15px auto;
        border: 1px solid #ddd;
        border-radius: 8px;
      }
      .results {
        margin-top: 40px;
        padding: 30px;
        border-radius: 10px;
        text-align: center;
        display: none;
        animation: fadeIn 0.5s ease-in-out;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .results.excellent {
        background: #d4edda;
        border: 2px solid #155724;
      }
      .excellent h3 {
        color: #155724;
      }
      .results.good {
        background: #cce5ff;
        border: 2px solid #004085;
      }
      .good h3 {
        color: #004085;
      }
      .results.practice {
        background: #fff3cd;
        border: 2px solid #856404;
      }
      .practice h3 {
        color: #856404;
      }
      .results.below {
        background: #f8d7da;
        border: 2px solid #721c24;
      }
      .below h3 {
        color: #721c24;
      }
      .button-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 15px;
        margin-top: 40px;
      }
      .check-button,
      .reset-button {
        display: block;
        width: 100%;
        max-width: 300px;
        padding: 15px;
        font-size: 1.2em;
        font-weight: 600;
        color: #fff;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition:
          transform 0.2s,
          box-shadow 0.2s;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }
      .check-button {
        background: linear-gradient(
          90deg,
          var(--primary-color),
          var(--secondary-color)
        );
      }
      .reset-button {
        background: var(--warning-color);
      }
      .check-button:hover,
      .reset-button:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
      }
      .check-button:disabled {
        background: #aaa;
        cursor: not-allowed;
        transform: none;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }
      .feedback {
        margin-top: 15px;
        padding: 12px;
        border-radius: 5px;
        font-weight: 600;
      }
      .feedback-symbol {
        font-size: 1.2em;
        font-weight: 700;
        margin-right: 5px;
      }
      .correct {
        background: #e9f7ef;
        color: var(--correct-color);
        border-left: 5px solid var(--correct-color);
      }
      .incorrect {
        background: #fdeeee;
        color: var(--incorrect-color);
        border-left: 5px solid var(--incorrect-color);
      }
      .explanation {
        font-weight: 400;
        font-size: 0.95em;
        margin-top: 6px;
        display: block;
      }
      #submission-status {
        font-size: 1em;
        font-style: italic;
        margin-top: 15px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>Grade 7 Mathematics Challenge 🧠</h1>
        <p>
          Test your skills! Answer all the questions below and see how you do.
        </p>
        <div
          style="
            margin-top: 15px;
            text-align: left;
            max-width: 300px;
            margin-left: auto;
            margin-right: auto;
          "
        >
          <label
            for="learner-name"
            style="font-weight: 600; display: block; margin-bottom: 5px"
            >Learner Name:
            <span style="color: var(--warning-color)"
              >*Required for Submission</span
            ></label
          >
          <input
            type="text"
            id="learner-name"
            placeholder="Enter your full name"
            style="
              padding: 8px;
              width: 100%;
              border: 1px solid var(--border-color);
              border-radius: 5px;
              font-family: inherit;
            "
          />
        </div>
        <p class="credits">Prepared by TR. Nickson</p>
      </div>
      <div id="timer-container">
        Time Remaining: <span id="time">55:00</span>
      </div>
      <div class="progress-container">
        <div id="progress-bar"></div>
      </div>
      <form id="assessment-form" name="assessment-form">
        <h2 class="section-title">Multiple Choice Questions</h2>
        <ol class="question-list">
          <li
            class="question-item"
            data-q-id="q1"
            data-answer="C"
            data-explanation="The number $2$ is in the millions place, $045$ is in the thousands place, and $372$ is in the units place, so it reads $\mathbf{Two \\text{ million, } forty-five \\text{ thousand, } three \\text{ hundred } seventy-two}$."
          >
            <div class="question-header">
              <span class="question-number">1</span>
              <div class="question-text">
                A school received KSh 2,045,372 from the national government.
                How is this amount written in words?
              </div>
            </div>
            <div class="mc-options" data-q-id="q1-options">
              <label
                ><input type="radio" name="q1" value="A" />
                <span
                  >A. Two hundred thousand forty-five three hundred
                  seventy-two</span
                ></label
              >
              <label
                ><input type="radio" name="q1" value="B" />
                <span
                  >B. Two million, four hundred five thousand, three hundred
                  seventy-two</span
                ></label
              >
              <label
                ><input type="radio" name="q1" value="C" />
                <span
                  >C. Two million, forty-five thousand, three hundred
                  seventy-two</span
                ></label
              >
              <label
                ><input type="radio" name="q1" value="D" />
                <span
                  >D. Twenty million, four hundred fifty-three thousand, seven
                  hundred twenty</span
                ></label
              >
            </div>
            <div class="feedback" id="feedback-q1"></div>
          </li>
          <li
            class="question-item"
            data-q-id="q2"
            data-answer="B"
            data-explanation="A prime is a whole number $&gt;1$ with only two factors: $1$ and itself. From $2,4,7,8,9,10,11$, primes are $\mathbf{2, 7, 11}$."
          >
            <div class="question-header">
              <span class="question-number">2</span>
              <div class="question-text">
                A lift stops on the 2nd, 4th, 7th, 8th, 9th, 10th, and 11th
                floors. Which of these floor numbers are prime?
              </div>
            </div>
            <div class="mc-options" data-q-id="q2-options">
              <label
                ><input type="radio" name="q2" value="A" />
                <span>A. 2, 4, 7</span></label
              >
              <label
                ><input type="radio" name="q2" value="B" />
                <span>B. 2, 7, 11</span></label
              >
              <label
                ><input type="radio" name="q2" value="C" />
                <span>C. 4, 7, 9</span></label
              >
              <label
                ><input type="radio" name="q2" value="D" />
                <span>D. 7, 9, 11</span></label
              >
            </div>
            <div class="feedback" id="feedback-q2"></div>
          </li>
          <li
            class="question-item"
            data-q-id="q3"
            data-answer="C"
            data-explanation="Multiples of $15$: $15,30,45,60,75,\mathbf{90},\dots$; of $18$: $18,36,54,72,\mathbf{90},\dots$. LCM is $\mathbf{90}$."
          >
            <div class="question-header">
              <span class="question-number">3</span>
              <div class="question-text">
                A farmer packs oranges into cartons that hold either 15 or 18
                oranges each. What is the minimum number of oranges needed to
                fill cartons of either size completely?
              </div>
            </div>
            <div class="mc-options" data-q-id="q3-options">
              <label
                ><input type="radio" name="q3" value="A" />
                <span>A. 270</span></label
              >
              <label
                ><input type="radio" name="q3" value="B" />
                <span>B. 180</span></label
              >
              <label
                ><input type="radio" name="q3" value="C" />
                <span>C. 90</span></label
              >
              <label
                ><input type="radio" name="q3" value="D" />
                <span>D. 45</span></label
              >
            </div>
            <div class="feedback" id="feedback-q3"></div>
          </li>
          <li
            class="question-item"
            data-q-id="q4"
            data-answer="B"
            data-explanation="Equal pages per day: $\tfrac{3}{4}/4 = \tfrac{3}{16}$."
          >
            <div class="question-header">
              <span class="question-number">4</span>
              <div class="question-text">
                A student reads the same number of pages each day. After 4 days,
                they have read $\frac{3}{4}$ of their book. What fraction of the
                book did the student read each day?
              </div>
            </div>
            <div class="mc-options" data-q-id="q4-options">
              <label
                ><input type="radio" name="q4" value="A" />
                <span>A. $\frac{1}{4}$</span></label
              >
              <label
                ><input type="radio" name="q4" value="B" />
                <span>B. $\frac{3}{16}$</span></label
              >
              <label
                ><input type="radio" name="q4" value="C" />
                <span>C. $\frac{1}{8}$</span></label
              >
              <label
                ><input type="radio" name="q4" value="D" />
                <span>D. $\frac{1}{16}$</span></label
              >
            </div>
            <div class="feedback" id="feedback-q4"></div>
          </li>
          <li
            class="question-item"
            data-q-id="q5"
            data-answer="B"
            data-explanation="In 3.408, 4 is 0.4 (tenths); 8 is 0.008 (thousandths). Difference = 0.392."
          >
            <div class="question-header">
              <span class="question-number">5</span>
              <div class="question-text">
                The mass of a substance is recorded as $3.408\,\text{g}$. What
                is the difference between the value of the digit 4 and the value
                of the digit 8?
              </div>
            </div>
            <div class="mc-options" data-q-id="q5-options">
              <label
                ><input type="radio" name="q5" value="A" />
                <span>A. 0.32</span></label
              >
              <label
                ><input type="radio" name="q5" value="B" />
                <span>B. 0.392</span></label
              >
              <label
                ><input type="radio" name="q5" value="C" />
                <span>C. 0.408</span></label
              >
              <label
                ><input type="radio" name="q5" value="D" />
                <span>D. 0.48</span></label
              >
            </div>
            <div class="feedback" id="feedback-q5"></div>
          </li>
          <li
            class="question-item"
            data-q-id="q6"
            data-answer="C"
            data-explanation="$\sqrt{324}=18$."
          >
            <div class="question-header">
              <span class="question-number">6</span>
              <div class="question-text">
                An event organiser arranged 324 chairs into a square formation.
                How many chairs were in each row?
              </div>
            </div>
            <div class="mc-options" data-q-id="q6-options">
              <label
                ><input type="radio" name="q6" value="A" />
                <span>A. 12</span></label
              >
              <label
                ><input type="radio" name="q6" value="B" />
                <span>B. 16</span></label
              >
              <label
                ><input type="radio" name="q6" value="C" />
                <span>C. 18</span></label
              >
              <label
                ><input type="radio" name="q6" value="D" />
                <span>D. 20</span></label
              >
            </div>
            <div class="feedback" id="feedback-q6"></div>
          </li>
          <li
            class="question-item"
            data-q-id="q7"
            data-answer="C"
            data-explanation="New total: $(c+2c)+(p+\tfrac12 p)=3c+\tfrac32 p$."
          >
            <div class="question-header">
              <span class="question-number">7</span>
              <div class="question-text">
                A forest has $c$ cypress trees and $p$ pine trees. If an
                additional $2c$ cypress trees and $\frac{1}{2}p$ pine trees are
                planted, which expression represents the new total number of
                trees?
              </div>
            </div>
            <div class="mc-options" data-q-id="q7-options">
              <label
                ><input type="radio" name="q7" value="A" />
                <span>A. $2c + \frac{1}{2}p$</span></label
              >
              <label
                ><input type="radio" name="q7" value="B" />
                <span>B. $3c + \frac{1}{2}p$</span></label
              >
              <label
                ><input type="radio" name="q7" value="C" />
                <span>C. $3c + \frac{3}{2}p$</span></label
              >
              <label
                ><input type="radio" name="q7" value="D" />
                <span>D. $c + 2p$</span></label
              >
            </div>
            <div class="feedback" id="feedback-q7"></div>
          </li>
          <li
            class="question-item"
            data-q-id="q8"
            data-answer="B"
            data-explanation="$x+(x+6)=24 \Rightarrow x=9$."
          >
            <div class="question-header">
              <span class="question-number">8</span>
              <div class="question-text">
                Amina and Ali bought 24 books altogether. If Ali bought 6 more
                books than Amina, how many books did Amina buy?
              </div>
            </div>
            <div class="mc-options" data-q-id="q8-options">
              <label
                ><input type="radio" name="q8" value="A" />
                <span>A. 12</span></label
              >
              <label
                ><input type="radio" name="q8" value="B" />
                <span>B. 9</span></label
              >
              <label
                ><input type="radio" name="q8" value="C" />
                <span>C. 15</span></label
              >
              <label
                ><input type="radio" name="q8" value="D" />
                <span>D. 18</span></label
              >
            </div>
            <div class="feedback" id="feedback-q8"></div>
          </li>
          <li
            class="question-item"
            data-q-id="q9"
            data-answer="C"
            data-explanation="Akinyi: $h&gt;1.2$. Nzomo: $h\le 1.5$."
          >
            <div class="question-header">
              <span class="question-number">9</span>
              <div class="question-text">
                Akinyi’s height ($h$) is greater than $1.2\,\text{m}$, while
                Nzomo’s height ($h$) is less than or equal to $1.5\,\text{m}$.
                Which pair of inequalities correctly represents this
                information?
              </div>
            </div>
            <div class="mc-options" data-q-id="q9-options">
              <label
                ><input type="radio" name="q9" value="A" />
                <span>A. Akinyi $h &lt; 1.2$, Nzomo $h \ge 1.5$</span></label
              >
              <label
                ><input type="radio" name="q9" value="B" />
                <span>B. Akinyi $h \ge 1.2$, Nzomo $h &lt; 1.5$</span></label
              >
              <label
                ><input type="radio" name="q9" value="C" />
                <span>C. Akinyi $h &gt; 1.2$, Nzomo $h \le 1.5$</span></label
              >
              <label
                ><input type="radio" name="q9" value="D" />
                <span>D. Akinyi $h &lt; 1.2$, Nzomo $h \le 1.5$</span></label
              >
            </div>
            <div class="feedback" id="feedback-q9"></div>
          </li>
          <li
            class="question-item"
            data-q-id="q10"
            data-answer="C"
            data-explanation="$a=150, b=200\Rightarrow c=250\,\text{m}$."
          >
            <div class="question-header">
              <span class="question-number">10</span>
              <div class="question-text">
                A right-angled triangular piece of land has shorter sides
                measuring $150\,\text{m}$ and $200\,\text{m}$. What is the
                length of its longest side (the hypotenuse)?
              </div>
            </div>
            <div class="mc-options" data-q-id="q10-options">
              <label
                ><input type="radio" name="q10" value="A" />
                <span>A. $150\,\text{m}$</span></label
              >
              <label
                ><input type="radio" name="q10" value="B" />
                <span>B. $200\,\text{m}$</span></label
              >
              <label
                ><input type="radio" name="q10" value="C" />
                <span>C. $250\,\text{m}$</span></label
              >
              <label
                ><input type="radio" name="q10" value="D" />
                <span>D. $350\,\text{m}$</span></label
              >
            </div>
            <div class="feedback" id="feedback-q10"></div>
          </li>
          <li
            class="question-item"
            data-q-id="q11"
            data-answer="B"
            data-explanation="$C=2\pi r=176\,\text{cm}$; 100 revs $=176\,\text{m}$."
          >
            <div class="question-header">
              <span class="question-number">11</span>
              <div class="question-text">
                A bicycle wheel has a radius of $28\,\text{cm}$. What total
                distance, in metres, does the wheel cover after 100 complete
                revolutions? (Use $\pi=\frac{22}{7}$)
              </div>
            </div>
            <div class="mc-options" data-q-id="q11-options">
              <label
                ><input type="radio" name="q11" value="A" />
                <span>A. $88\,\text{m}$</span></label
              >
              <label
                ><input type="radio" name="q11" value="B" />
                <span>B. $176\,\text{m}$</span></label
              >
              <label
                ><input type="radio" name="q11" value="C" />
                <span>C. $220\,\text{m}$</span></label
              >
              <label
                ><input type="radio" name="q11" value="D" />
                <span>D. $280\,\text{m}$</span></label
              >
            </div>
            <div class="feedback" id="feedback-q11"></div>
          </li>
          <li
            class="question-item"
            data-q-id="q12"
            data-answer="C"
            data-explanation="$\tfrac{420}{120}=3.5\,\text{m/s}$."
          >
            <div class="question-header">
              <span class="question-number">12</span>
              <div class="question-text">
                Kiptoo completed a lap of a $420\,\text{m}$ track in 2 minutes.
                What was his average speed in metres per second ($\text{m/s}$)?
              </div>
            </div>
            <div class="mc-options" data-q-id="q12-options">
              <label
                ><input type="radio" name="q12" value="A" />
                <span>A. $2.5\,\text{m/s}$</span></label
              >
              <label
                ><input type="radio" name="q12" value="B" />
                <span>B. $3.0\,\text{m/s}$</span></label
              >
              <label
                ><input type="radio" name="q12" value="C" />
                <span>C. $3.5\,\text{m/s}$</span></label
              >
              <label
                ><input type="radio" name="q12" value="D" />
                <span>D. $4.0\,\text{m/s}$</span></label
              >
            </div>
            <div class="feedback" id="feedback-q12"></div>
          </li>
        </ol>
        <h2 class="section-title">
          Structured Questions (Enter Numerical Value Only)
        </h2>
        <ol class="question-list" start="13">
          <li
            class="question-item"
            data-q-id="q13"
            data-answer="82"
            data-explanation="$355-273=82$."
          >
            <div class="question-header">
              <span class="question-number">13</span>
              <div class="question-text">
                A temperature is recorded as $355\,\text{K}$. What is this
                temperature in degrees Celsius ($^\circ\text{C}$)?
              </div>
            </div>
            <div class="structured-answer-area" data-q-id="q13-area">
              <input
                type="text"
                name="q13"
                id="input-q13"
                placeholder="e.g., 25"
              />
            </div>
            <div class="feedback" id="feedback-q13"></div>
          </li>
          <li
            class="question-item"
            data-q-id="q14"
            data-answer="15"
            data-explanation="Loss% $=345000/2300000\times100=15$."
          >
            <div class="question-header">
              <span class="question-number">14</span>
              <div class="question-text">
                Wamalwa bought a car for KSh 2,300,000 and later sold it for KSh
                1,955,000. What was his percentage loss?
              </div>
            </div>
            <div class="structured-answer-area" data-q-id="q14-area">
              <input
                type="text"
                name="q14"
                id="input-q14"
                placeholder="e.g., 10"
              />
            </div>
            <div class="feedback" id="feedback-q14"></div>
          </li>
          <li
            class="question-item"
            data-q-id="q15"
            data-answer="6"
            data-explanation="Exterior angle $=60^\circ$; sides $=360/60=6$."
          >
            <div class="question-header">
              <span class="question-number">15</span>
              <div class="question-text">
                Each interior angle of a regular polygon measures $120^\circ$.
                How many sides does the polygon have?
              </div>
            </div>
            <div class="structured-answer-area" data-q-id="q15-area">
              <input
                type="text"
                name="q15"
                id="input-q15"
                placeholder="e.g., 5"
              />
            </div>
            <div class="feedback" id="feedback-q15"></div>
          </li>
          <li
            class="question-item"
            data-q-id="q16"
            data-answer="4"
            data-explanation="Four towns → 4 bars."
          >
            <div class="question-header">
              <span class="question-number">16</span>
              <div class="question-text">
                A bar graph is created to show the number of tourists visiting 4
                different towns. How many bars will the graph have?
              </div>
            </div>
            <div class="structured-answer-area" data-q-id="q16-area">
              <input
                type="text"
                name="q16"
                id="input-q16"
                placeholder="e.g., 3"
              />
            </div>
            <div class="feedback" id="feedback-q16"></div>
          </li>
          <li
            class="question-item"
            data-q-id="q17"
            data-answer="2600"
            data-explanation="CP $=3200-600=2600$."
          >
            <div class="question-header">
              <span class="question-number">17</span>
              <div class="question-text">
                An item was sold for KSh 3,200, which resulted in a profit of
                KSh 600. What was the original cost price of the item?
              </div>
            </div>
            <div class="structured-answer-area" data-q-id="q17-area">
              <input
                type="text"
                name="q17"
                id="input-q17"
                placeholder="e.g., 2000"
              />
            </div>
            <div class="feedback" id="feedback-q17"></div>
          </li>
          <li
            class="question-item"
            data-q-id="q18"
            data-answer="76"
            data-explanation="Largest angle $\approx 76^\circ$ (accept 74–78)."
          >
            <div class="question-header">
              <span class="question-number">18</span>
              <div class="question-text">
                After constructing a triangle with sides measuring 6 cm, 7 cm,
                and 8 cm, what is the size of the largest angle in degrees?
              </div>
            </div>
            <div class="structured-answer-area" data-q-id="q18-area">
              <input
                type="text"
                name="q18"
                id="input-q18"
                placeholder="e.g., 90"
              />
            </div>
            <div class="feedback" id="feedback-q18"></div>
          </li>
          <li
            class="question-item"
            data-q-id="q19"
            data-answer="60"
            data-explanation="$45 \div \tfrac{3}{4} = 60$."
          >
            <div class="question-header">
              <span class="question-number">19</span>
              <div class="question-text">
                How many $\tfrac{3}{4}$ kg packets of flour can be filled from a
                45 kg sack?
              </div>
            </div>
            <div class="structured-answer-area" data-q-id="q19-area">
              <input
                type="text"
                name="q19"
                id="input-q19"
                placeholder="e.g., 50"
              />
            </div>
            <div class="feedback" id="feedback-q19"></div>
          </li>
          <li
            class="question-item"
            data-q-id="q20"
            data-answer="10000"
            data-explanation="$25\%$ of 40,000 = 10,000."
          >
            <div class="question-header">
              <span class="question-number">20</span>
              <div class="question-text">
                A person with an income of KSh 40,000 spends 75% of it. How much
                money, in KSh, do they save?
              </div>
            </div>
            <div class="structured-answer-area" data-q-id="q20-area">
              <input
                type="text"
                name="q20"
                id="input-q20"
                placeholder="e.g., 5000"
              />
            </div>
            <div class="feedback" id="feedback-q20"></div>
          </li>
          <li
            class="question-item"
            data-q-id="q21"
            data-answer="144"
            data-explanation="Rent fraction $=\tfrac{2}{5}\Rightarrow 144^\circ$."
          >
            <div class="question-header">
              <span class="question-number">21</span>
              <div class="question-text">
                In a family's budget, rent accounts for $\frac{2}{5}$ of the
                total income. If this budget is shown on a pie chart, what is
                the angle for the rent sector in degrees?
              </div>
            </div>
            <div class="structured-answer-area" data-q-id="q21-area">
              <input
                type="text"
                name="q21"
                id="input-q21"
                placeholder="e.g., 100"
              />
            </div>
            <div class="feedback" id="feedback-q21"></div>
          </li>
          <li
            class="question-item"
            data-q-id="q22"
            data-answer="16"
            data-explanation="$72=2(20+W)\Rightarrow W=16$."
          >
            <div class="question-header">
              <span class="question-number">22</span>
              <div class="question-text">
                The perimeter of a rectangle is 72 m. If its length is 20 m,
                what is its width in metres?
              </div>
            </div>
            <div class="structured-answer-area" data-q-id="q22-area">
              <input
                type="text"
                name="q22"
                id="input-q22"
                placeholder="e.g., 10"
              />
            </div>
            <div class="feedback" id="feedback-q22"></div>
          </li>
          <li
            class="question-item"
            data-q-id="q23"
            data-answer="19200"
            data-explanation="20% of 24,000 = 4,800; SP = 19,200."
          >
            <div class="question-header">
              <span class="question-number">23</span>
              <div class="question-text">
                A trader bought an item for KSh 24,000 and sold it at a 20%
                loss. What was the selling price in KSh?
              </div>
            </div>
            <div class="structured-answer-area" data-q-id="q23-area">
              <input
                type="text"
                name="q23"
                id="input-q23"
                placeholder="e.g., 15000"
              />
            </div>
            <div class="feedback" id="feedback-q23"></div>
          </li>
          <li
            class="question-item"
            data-q-id="q24"
            data-answer="208"
            data-explanation="$2(lw+lh+wh)=208\,\text{cm}^2$."
          >
            <div class="question-header">
              <span class="question-number">24</span>
              <div class="question-text">
                Calculate the total surface area, in $\text{cm}^2$, of a cuboid
                with a length of 8 cm, a width of 4 cm, and a height of 6 cm.
              </div>
            </div>
            <img
              src="cuboid.png"
              alt="Cuboid with length 8cm, width 4cm, height 6cm"
              class="question-image"
            />
            <div class="structured-answer-area" data-q-id="q24-area">
              <input
                type="text"
                name="q24"
                id="input-q24"
                placeholder="e.g., 150"
              />
            </div>
            <div class="feedback" id="feedback-q24"></div>
          </li>
          <li
            class="question-item"
            data-q-id="q25"
            data-answer="13860"
            data-explanation="$V=\pi r^2 h=13860\,\text{cm}^3$ with $r=21$, $h=10$, $\pi=22/7$."
          >
            <div class="question-header">
              <span class="question-number">25</span>
              <div class="question-text">
                Calculate the volume, in $\text{cm}^3$, of a cylinder with a
                radius of 21 cm and a height of 10 cm. (Use
                $\pi=\tfrac{22}{7}$).
              </div>
            </div>
            <img
              src="cylinder.png"
              alt="Cylinder with radius 21cm and height 10cm"
              class="question-image"
            />
            <div class="structured-answer-area" data-q-id="q25-area">
              <input
                type="text"
                name="q25"
                id="input-q25"
                placeholder="e.g., 1000"
              />
            </div>
            <div class="feedback" id="feedback-q25"></div>
          </li>
          <li
            class="question-item"
            data-q-id="q26"
            data-answer="1500"
            data-explanation="Value of 3 is 300,000 (Hundred Thousands). Value of 2 is 200 (Hundreds). $300,000 \div 200 = 1500$."
          >
            <div class="question-header">
              <span class="question-number">26</span>
              <div class="question-text">
                A cooperative society received 18357248 cartons of avocados. How
                many times is the total value of digit **3** greater than the
                total value of digit **2** in the number?
              </div>
            </div>
            <div class="structured-answer-area" data-q-id="q26-area">
              <input
                type="text"
                name="q26"
                id="input-q26"
                placeholder="e.g., 1000"
              />
            </div>
            <div class="feedback" id="feedback-q26"></div>
          </li>
          <li
            class="question-item"
            data-q-id="q27"
            data-answer="3.5"
            data-explanation="Distance $21\text{ km} = 21000\text{ m}$. Time $1\text{ hr } 40\text{ min} = 6000\text{ s}$. Speed $21000/6000 = 3.5\text{ m/s}$."
          >
            <div class="question-header">
              <span class="question-number">27</span>
              <div class="question-text">
                A half marathon race is $21\,\text{km}$ long. Peter ran the race
                in 1 hour 40 minutes. Determine Peter's speed in $\text{m/s}$.
                (Give your answer to one decimal place)
              </div>
            </div>
            <div class="structured-answer-area" data-q-id="q27-area">
              <input
                type="text"
                name="q27"
                id="input-q27"
                placeholder="e.g., 5.0"
              />
            </div>
            <div class="feedback" id="feedback-q27"></div>
          </li>
          <li
            class="question-item"
            data-q-id="q28"
            data-answer="110"
            data-explanation="In a parallelogram, consecutive angles are supplementary (add up to $180^\circ$). The adjacent angle is $180^\circ - 70^\circ = 110^\circ$."
          >
            <div class="question-header">
              <span class="question-number">28</span>
              <div class="question-text">
                A parallelogram has one interior angle of $70^\circ$. Find the
                size, in degrees, of the adjacent (consecutive) interior angle.
              </div>
            </div>
            <div class="structured-answer-area" data-q-id="q28-area">
              <input
                type="text"
                name="q28"
                id="input-q28"
                placeholder="e.g., 90"
              />
            </div>
            <div class="feedback" id="feedback-q28"></div>
          </li>
          <h3
            class="section-title"
            style="font-size: 1.1em; background: #6b9dc1"
          >
            Questions 29-33: Pie Chart Data Analysis
          </h3>
          <div
            class="question-item"
            style="border-left: 5px solid #6b9dc1; margin-bottom: 10px"
          >
            <div class="question-text" style="font-weight: normal">
              The table below shows the number of learners selected to represent
              their school in various ball games. Use this data to calculate the
              sector angle for each game when represented on a **pie chart**.
              (Total learners = **60**)
            </div>
            <table
              style="
                width: 100%;
                border-collapse: collapse;
                margin-top: 10px;
                font-size: 0.95em;
              "
            >
              <thead>
                <tr style="background: #f0f0f0">
                  <th
                    style="
                      padding: 8px;
                      border: 1px solid #ccc;
                      text-align: left;
                    "
                  >
                    Game
                  </th>
                  <th style="padding: 8px; border: 1px solid #ccc">Football</th>
                  <th style="padding: 8px; border: 1px solid #ccc">Netball</th>
                  <th style="padding: 8px; border: 1px solid #ccc">
                    Volleyball
                  </th>
                  <th style="padding: 8px; border: 1px solid #ccc">Handball</th>
                  <th style="padding: 8px; border: 1px solid #ccc">
                    Basketball
                  </th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td
                    style="
                      padding: 8px;
                      border: 1px solid #ccc;
                      font-weight: 600;
                    "
                  >
                    Number of learners
                  </td>
                  <td style="padding: 8px; border: 1px solid #ccc">18</td>
                  <td style="padding: 8px; border: 1px solid #ccc">12</td>
                  <td style="padding: 8px; border: 1px solid #ccc">10</td>
                  <td style="padding: 8px; border: 1px solid #ccc">9</td>
                  <td style="padding: 8px; border: 1px solid #ccc">11</td>
                </tr>
              </tbody>
            </table>
          </div>
          <li
            class="question-item"
            data-q-id="q29"
            data-answer="108"
            data-explanation="Football: $(18/60) \times 360^\circ = 108^\circ$."
          >
            <div class="question-header">
              <span class="question-number">29</span>
              <div class="question-text">
                What is the sector angle, in degrees, for **Football**?
              </div>
            </div>
            <div class="structured-answer-area" data-q-id="q29-area">
              <input
                type="text"
                name="q29"
                id="input-q29"
                placeholder="e.g., 120"
              />
            </div>
            <div class="feedback" id="feedback-q29"></div>
          </li>
          <li
            class="question-item"
            data-q-id="q30"
            data-answer="72"
            data-explanation="Netball: $(12/60) \times 360^\circ = 72^\circ$."
          >
            <div class="question-header">
              <span class="question-number">30</span>
              <div class="question-text">
                What is the sector angle, in degrees, for **Netball**?
              </div>
            </div>
            <div class="structured-answer-area" data-q-id="q30-area">
              <input
                type="text"
                name="q30"
                id="input-q30"
                placeholder="e.g., 80"
              />
            </div>
            <div class="feedback" id="feedback-q30"></div>
          </li>
          <li
            class="question-item"
            data-q-id="q31"
            data-answer="60"
            data-explanation="Volleyball: $(10/60) \times 360^\circ = 60^\circ$."
          >
            <div class="question-header">
              <span class="question-number">31</span>
              <div class="question-text">
                What is the sector angle, in degrees, for **Volleyball**?
              </div>
            </div>
            <div class="structured-answer-area" data-q-id="q31-area">
              <input
                type="text"
                name="q31"
                id="input-q31"
                placeholder="e.g., 50"
              />
            </div>
            <div class="feedback" id="feedback-q31"></div>
          </li>
          <li
            class="question-item"
            data-q-id="q32"
            data-answer="54"
            data-explanation="Handball: $(9/60) \times 360^\circ = 54^\circ$."
          >
            <div class="question-header">
              <span class="question-number">32</span>
              <div class="question-text">
                What is the sector angle, in degrees, for **Handball**?
              </div>
            </div>
            <div class="structured-answer-area" data-q-id="q32-area">
              <input
                type="text"
                name="q32"
                id="input-q32"
                placeholder="e.g., 40"
              />
            </div>
            <div class="feedback" id="feedback-q32"></div>
          </li>
          <li
            class="question-item"
            data-q-id="q33"
            data-answer="66"
            data-explanation="Basketball: $(11/60) \times 360^\circ = 66^\circ$. (Check: $108+72+60+54+66 = 360$)."
          >
            <div class="question-header">
              <span class="question-number">33</span>
              <div class="question-text">
                What is the sector angle, in degrees, for **Basketball**?
              </div>
            </div>
            <div class="structured-answer-area" data-q-id="q33-area">
              <input
                type="text"
                name="q33"
                id="input-q33"
                placeholder="e.g., 70"
              />
            </div>
            <div class="feedback" id="feedback-q33"></div>
          </li>
        </ol>
        <div class="button-container">
          <button
            type="button"
            class="check-button"
            id="check-btn"
            onclick="checkAnswers()"
          >
            Check My Answers! 🚀
          </button>
          <button type="button" class="reset-button" onclick="promptForReset()">
            Reset Quiz 🔒
          </button>
        </div>
      </form>
      <div class="results" id="results">
        <h3 id="results-title"></h3>
        <p id="score-text"></p>
        <p id="results-message"></p>
        <p>Review the questions above for detailed feedback on each answer.</p>
        <p
          id="submission-status"
          style="margin-top: 20px; font-weight: 600"
        ></p>
      </div>
    </div>
    <script>
      // === Your Web App URL ===
      const SCRIPT_URL =
        "https://script.google.com/macros/s/AKfycbzwDHNUCzE6SjAUyXG7QykAW1pB0KmcVI-3IEX8XWt_RIxyFnlfL2CxtT_2TgwZlJ-UMA/exec";

      const mcAnswers = {
        q1: "C",
        q2: "B",
        q3: "C",
        q4: "B",
        q5: "B",
        q6: "C",
        q7: "C",
        q8: "B",
        q9: "C",
        q10: "C",
        q11: "B",
        q12: "C",
      };
      const structuredAnswers = {
        q13: "82",
        q14: "15",
        q15: "6",
        q16: "4",
        q17: "2600",
        q18: "76",
        q19: "60",
        q20: "10000",
        q21: "144",
        q22: "16",
        q23: "19200",
        q24: "208",
        q25: "13860",
        q26: "1500",
        q27: "3.5",
        q28: "110",
        q29: "108",
        q30: "72",
        q31: "60",
        q32: "54",
        q33: "66",
      };
      const allQuestionIds = Object.keys(mcAnswers).concat(
        Object.keys(structuredAnswers),
      );
      const totalQuestions = allQuestionIds.length;
      let timerInterval;
      let quizChecked = false; // True only after a successful check AND submission

      // Stores results after scoring but before submission
      let quizScoringData = null;

      function startTimer(durationInSeconds, displayElement) {
        let timer = durationInSeconds;
        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
          const minutes = String(Math.floor(timer / 60)).padStart(2, "0");
          const seconds = String(timer % 60).padStart(2, "0");
          displayElement.textContent = minutes + ":" + seconds;
          if (--timer < 0) {
            clearInterval(timerInterval);
            if (!quizChecked) {
              // isAutoCheck = true to bypass completion check
              alert(
                "Time's up! Your answers will be checked and submitted automatically.",
              );
              checkAnswers(true);
            }
          }
        }, 1000);
      }
      window.onload = function () {
        startTimer(60 * 55, document.querySelector("#time"));
      };

      /**
       * Locks the answer elements. Used for MC instant lock and for the final lock on all Qs.
       */
      function lockAnswer(qId, type) {
        if (type === "mc") {
          const optionsDiv = document.querySelector(
            `.mc-options[data-q-id="${qId}-options"]`,
          );
          if (optionsDiv) {
            optionsDiv.classList.add("locked");
            optionsDiv
              .querySelectorAll('input[type="radio"]')
              .forEach((r) => (r.disabled = true));
          }
        } else {
          // This part is only used for the final lock after checkAnswers().
          const areaDiv = document.querySelector(
            `.structured-answer-area[data-q-id="${qId}-area"]`,
          );
          const input = document.getElementById(`input-${qId}`);
          if (areaDiv && input) {
            areaDiv.classList.add("locked");
            input.readOnly = true;
          }
        }
      }

      function updateProgressBar() {
        let answered = 0;
        allQuestionIds.forEach((qId) => {
          const mcChecked = document.querySelector(
            `input[name="${qId}"]:checked`,
          );
          const si = document.getElementById(`input-${qId}`);
          if (mcChecked || (si && si.value.trim() !== "")) answered++;
        });
        document.getElementById("progress-bar").style.width =
          (answered / totalQuestions) * 100 + "%";
      }

      function normalizeNumericalInput(input) {
        if (typeof input !== "string") return NaN;
        const clean = input.trim().replace(/[^0-9.-]/g, "");
        const m = clean.match(/^-?(\d*\.?\d+)/);
        return m ? parseFloat(m[0]) : NaN;
      }

      function handleQuestionInteraction(event) {
        if (quizChecked) return;

        const qId = event.target.name || event.target.id.replace("input-", "");
        const item = document.querySelector(
          `.question-item[data-q-id="${qId}"]`,
        );
        const fb = document.getElementById(`feedback-${qId}`);
        const correctAns = item.getAttribute("data-answer");

        let isCorrect = false;
        let isAnswered = false;

        if (mcAnswers[qId]) {
          // --- MULTIPLE CHOICE LOGIC: Keep Instant Feedback & Lock ---
          const selected = document.querySelector(
            `input[name="${qId}"]:checked`,
          );
          if (selected) {
            isAnswered = true;
            if (selected.value === correctAns) isCorrect = true;
            // MC Lock: Lock immediately after selection
            lockAnswer(qId, "mc");
          }

          // MC Instant Feedback: Display feedback immediately
          if (isAnswered) {
            if (isCorrect) {
              fb.className = "feedback correct";
              fb.innerHTML =
                '<span class="feedback-symbol">[✓]</span> Correct.';
            } else {
              fb.className = "feedback incorrect";
              fb.innerHTML =
                '<span class="feedback-symbol">[✗]</span> Incorrect.';
            }
          } else {
            fb.innerHTML = "";
            fb.className = "feedback";
          }
        } else {
          // --- STRUCTURED INPUT LOGIC: NO Instant Feedback, NO Lock/Unlock ---
          const input = document.getElementById(`input-${qId}`);
          if (input && input.value.trim() !== "") {
            isAnswered = true; // Still track 'answered' state for progress bar
          }

          // Ensure feedback area is cleared/empty for structured questions during interaction
          fb.innerHTML = "";
          fb.className = "feedback";
        }

        updateProgressBar();

        // REMOVED: If (window.MathJax) { window.MathJax.typeset(); }
        // This removes the typesetting delay from every interaction (MC feedback and Structured input).
      }

      allQuestionIds.forEach((qId) => {
        if (mcAnswers[qId]) {
          document
            .getElementsByName(qId)
            .forEach((r) =>
              r.addEventListener("change", handleQuestionInteraction),
            );
        } else {
          const input = document.getElementById(`input-${qId}`);
          if (input) {
            // Using 'input' event to track changes and update progress bar
            input.addEventListener("input", handleQuestionInteraction);
          }
        }
      });

      // Function to calculate scores, but NOT display full feedback
      function scoreQuiz() {
        let correct = 0;
        const form = document.getElementById("assessment-form");
        const failed = [];
        const unanswered = [];

        allQuestionIds.forEach((qId) => {
          const item = document.querySelector(
            `.question-item[data-q-id="${qId}"]`,
          );
          const correctAns = item.getAttribute("data-answer");
          let isCorrect = false;
          let isAnswered = false;

          if (mcAnswers[qId]) {
            const selected = form.querySelector(`input[name="${qId}"]:checked`);
            if (selected) {
              isAnswered = true;
              if (selected.value === correctAns) isCorrect = true;
            }
          } else {
            const input = document.getElementById(`input-${qId}`);
            if (input && input.value.trim() !== "") {
              isAnswered = true;
              const student = normalizeNumericalInput(input.value);
              const correctNum = normalizeNumericalInput(correctAns);
              // Allow small tolerance for angle estimation (q18, q21)
              const tol = qId === "q18" || qId === "q21" ? 2 : 0.001;

              if (!isNaN(student) && !isNaN(correctNum)) {
                if (qId === "q27") {
                  // Specific tolerance for the 1 decimal place speed question
                  if (Math.abs(student - correctNum) <= 0.05) isCorrect = true;
                } else if (Math.abs(student - correctNum) <= tol) {
                  isCorrect = true;
                }
              }
            }
          }

          if (isAnswered) {
            if (!isCorrect) failed.push(qId.slice(1));
            else correct++;
          } else {
            unanswered.push(qId.slice(1));
          }
        });

        return { correct, failed, unanswered };
      }

      async function submitResultsToSheet(submissionData) {
        const status = document.getElementById("submission-status");
        status.textContent = "Submitting results...";
        status.style.color = "var(--primary-color)";
        let submissionSuccess = false;

        try {
          const payload = new URLSearchParams();
          Object.entries(submissionData).forEach(([k, v]) =>
            payload.append(k, v),
          );
          const response = await fetch(SCRIPT_URL, {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: payload.toString(),
            redirect: "follow",
          });
          const text = await response.text();
          let result = null;
          try {
            result = JSON.parse(text);
          } catch (_) {}

          if (response.ok && result && result.status === "ok") {
            status.textContent = "Submission successful! Score recorded.";
            status.style.color = "var(--correct-color)";
            submissionSuccess = true;
          } else {
            const err =
              (result && (result.message || result.error)) ||
              "HTTP " + response.status;
            console.error("Submission Error:", err, text);
            // Do not show results, but allow user to retry
            status.textContent =
              "Submission failed: " +
              err +
              '. Please click "Check My Answers!" to retry.';
            submissionSuccess = false;
          }
        } catch (err) {
          console.error("Fetch Error:", err);
          // Do not show results, but allow user to retry
          status.textContent =
            'Submission failed: Network error or script URL incorrect. Please click "Check My Answers!" to retry.';
          submissionSuccess = false;
        }

        return submissionSuccess;
      }

      function processAndShowResults(resultsData) {
        // Lock down the entire quiz (final lock)
        allQuestionIds.forEach((qId) => {
          if (mcAnswers[qId]) lockAnswer(qId, "mc");
          else lockAnswer(qId, "structured"); // Applies the final lock to structured Qs
        });

        // Display Full Feedback (including explanations)
        allQuestionIds.forEach((qId) => {
          const item = document.querySelector(
            `.question-item[data-q-id="${qId}"]`,
          );
          const fb = document.getElementById(`feedback-${qId}`);
          const correctAns = item.getAttribute("data-answer");
          const explanation = item.getAttribute("data-explanation");

          // Determine status based on the previously calculated resultsData
          const isCorrect =
            !resultsData.failed.includes(qId.slice(1)) &&
            !resultsData.unanswered.includes(qId.slice(1));
          const isAnswered = !resultsData.unanswered.includes(qId.slice(1));

          let feedbackHTML = "";
          if (isCorrect) {
            fb.className = "feedback correct";
            feedbackHTML =
              '✅ Correct! <span class="explanation">Well done.</span>';
          } else if (!isAnswered) {
            const display = mcAnswers[qId]
              ? item.querySelector(`input[value="${correctAns}"] + span`)
                  .innerHTML
              : `$\\text{${correctAns}}$`;
            fb.className = "feedback incorrect";
            feedbackHTML = `⚠️ Unanswered. The correct answer is <strong>${display}</strong>. <span class="explanation">${explanation}</span>`;
          } else {
            // Incorrect
            const display = mcAnswers[qId]
              ? item.querySelector(`input[value="${correctAns}"] + span`)
                  .innerHTML
              : `$\\text{${correctAns}}$`;
            fb.className = "feedback incorrect";
            feedbackHTML = `❌ Incorrect. The correct answer is: <strong>${display}</strong>. <span class="explanation">${explanation}</span>`;
          }
          fb.innerHTML = feedbackHTML;
        });

        // Display Final Score Card
        const results = document.getElementById("results");
        const score = (resultsData.correct / totalQuestions) * 100;

        document.getElementById("score-text").innerHTML =
          `You scored <strong>${resultsData.correct} out of ${totalQuestions}</strong>. (${score.toFixed(1)}%)`;
        if (score >= 76) {
          results.className = "results excellent";
          document.getElementById("results-title").textContent =
            "Exceeding Expectations! 🌟";
          document.getElementById("results-message").textContent =
            "Fantastic work! Keep challenging yourself!";
        } else if (score >= 50) {
          results.className = "results good";
          document.getElementById("results-title").textContent =
            "Meeting Expectations! ✅";
          document.getElementById("results-message").textContent =
            "Great job! Review the ones you missed to level up.";
        } else if (score >= 21) {
          results.className = "results practice";
          document.getElementById("results-title").textContent =
            "Approaching Expectations! 📈";
          document.getElementById("results-message").textContent =
            "You're on the right track. Study the explanations and try again.";
        } else {
          results.className = "results below";
          document.getElementById("results-title").textContent =
            "Below Expectations";
          document.getElementById("results-message").textContent =
            "Don't be discouraged. Go through the explanations step by step.";
        }

        results.style.display = "block";
        results.scrollIntoView({ behavior: "smooth" });

        // TYPESETTING: Do the MathJax rendering once here for all final feedback.
        if (window.MathJax) {
          window.MathJax.typeset();
        }
      }

      async function checkAnswers(isAutoCheck = false) {
        const checkBtn = document.getElementById("check-btn");
        checkBtn.disabled = true;

        // 1. Name Validation & Jump
        const studentName = document
          .getElementById("learner-name")
          .value.trim();
        const nameInput = document.getElementById("learner-name");
        if (studentName === "") {
          alert(
            'Please enter your full name in the "Learner Name" field before checking answers and submitting the results.',
          );
          nameInput.scrollIntoView({ behavior: "smooth", block: "center" });
          nameInput.focus();
          checkBtn.disabled = false;
          return;
        }

        // 2. Completion Check & Jump (Bypassed if isAutoCheck is true/time lapsed)
        if (!isAutoCheck) {
          let firstUnansweredId = null;
          let answeredCount = 0;

          allQuestionIds.some((qId) => {
            const mcChecked = document.querySelector(
              `input[name="${qId}"]:checked`,
            );
            const si = document.getElementById(`input-${qId}`);
            if (mcChecked || (si && si.value.trim() !== "")) {
              answeredCount++;
              return false;
            } else {
              firstUnansweredId = qId;
              return true;
            }
          });

          if (answeredCount < totalQuestions) {
            const firstUnansweredElement = document.querySelector(
              `.question-item[data-q-id="${firstUnansweredId}"]`,
            );
            if (firstUnansweredElement) {
              firstUnansweredElement.scrollIntoView({
                behavior: "smooth",
                block: "center",
              });
            }
            alert(
              `You must answer all ${totalQuestions} questions before submitting. Please complete question ${firstUnansweredId.slice(1)}.`,
            );
            checkBtn.disabled = false;
            return;
          }
        }

        // 3. Score Quiz and Prepare Data (Done before submission attempt)
        quizScoringData = scoreQuiz();
        const score = (quizScoringData.correct / totalQuestions) * 100;

        // Prevent double submission if already checked successfully
        if (quizChecked) return;

        // Stop timer regardless of success, as the quiz attempt is over
        clearInterval(timerInterval);

        const submissionData = {
          name: studentName,
          percentage: score.toFixed(1) + "%",
          failedQuestions: quizScoringData.failed.join(","),
          unansweredQuestions: quizScoringData.unanswered.join(","),
        };

        // 4. Submission Attempt
        const submissionSuccessful = await submitResultsToSheet(submissionData);

        if (submissionSuccessful) {
          // 5. Successful submission: Lock quiz, show score, and reveal answers
          quizChecked = true;
          processAndShowResults(quizScoringData);
        } else {
          // 6. Submission failed: Keep quiz editable, and re-enable button for retry
          quizChecked = false; // Remains false until successful submission
          checkBtn.disabled = false;
        }
      }

      function promptForReset() {
        const p = prompt("Please enter the password to reset the quiz:");
        if (p === "Nick") {
          resetQuiz();
        } else if (p !== null) {
          alert("Incorrect password!");
        }
      }

      function resetQuiz() {
        document.getElementById("assessment-form").reset();
        document.querySelectorAll(".feedback").forEach((d) => {
          d.innerHTML = "";
          d.className = "feedback";
        });
        const r = document.getElementById("results");
        r.style.display = "none";
        r.className = "results";
        document.getElementById("submission-status").textContent = "";

        // Reset all locks and readOnly states
        document
          .querySelectorAll(".mc-options.locked")
          .forEach((el) => el.classList.remove("locked"));
        document
          .querySelectorAll('input[type="radio"]')
          .forEach((r) => (r.disabled = false));
        document
          .querySelectorAll(".structured-answer-area.locked")
          .forEach((el) => el.classList.remove("locked"));
        document
          .querySelectorAll('input[type="text"]')
          .forEach((i) => (i.readOnly = false));

        document.getElementById("progress-bar").style.width = "0%";
        document.getElementById("check-btn").disabled = false;

        quizChecked = false;
        quizScoringData = null; // Clear old scoring data

        startTimer(60 * 55, document.querySelector("#time"));
        window.scrollTo({ top: 0, behavior: "smooth" });
        alert("Quiz has been reset!");
      }
    </script>
  </body>
</html>
