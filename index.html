<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#1e40af" />
  <title>CBC Report Form – Professional UI (Marks Editor • One‑Page Print • Save to Excel)</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js" defer></script>

  <style>
    :root {
      /* Professional Color Palette */
      --accent: #1e40af; /* Deep Blue (for highlights) */
      --accent-hover: #1d4ed8;
      --primary-text: #1f2937; /* Dark Slate/Charcoal */
      --muted-text: #6b7280; /* Gray for subtle text */
      --border-color: #d1d5db; /* Light subtle border */
      --bg: #f9fafb; /* Very light gray background */
      --card-bg: #ffffff;
      --success: #059669;
      --warn: #f59e0b;
      --danger: #dc2626;
      --header-bg: #eff6ff; /* Very light blue for table headers */
      --font-sans: 'Inter', 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      --page-w: 210mm;
      --page-h: 297mm;
    }

    /* Keyframe animations for a fluid feel */
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideUpIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes toastIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes toastOut { to { opacity: 0; transform: translateY(15px); } }

    /* --- Base & Reset --- */
    html, body {
      height: 100%; margin: 0; background-color: var(--bg);
      font-family: var(--font-sans); color: var(--primary-text); font-size: 14px; line-height: 1.4;
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
    }
    .app { max-width: 1280px; margin: 24px auto; padding: 0 24px; animation: fadeIn 0.5s ease-out; }
    * { box-sizing: border-box; }

    /* --- Toolbar & Controls --- */
    .bar {
      display: flex; flex-wrap: wrap; gap: 12px; align-items: center;
      background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(8px);
      padding: 12px 16px; border-radius: 12px;
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05), 0 2px 4px -2px rgba(0,0,0,0.05);
      border: 1px solid var(--border-color);
      position: sticky; top: 16px; z-index: 100;
    }
    .group { display: flex; gap: 10px; align-items: center; }
    .group label { font-size: 13px; color: var(--muted-text); font-weight: 500; }
    select, input[type=text], input[type=number] {
      padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 8px;
      min-width: 160px; background: var(--card-bg); font-family: var(--font-sans);
      font-size: 14px; transition: border-color 0.2s, box-shadow 0.2s;
    }
    select:focus, input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1); }
    button, a.btn {
      padding: 9px 16px; background-color: var(--accent); color: white;
      border: none; border-radius: 8px; cursor: pointer; text-decoration: none;
      display: inline-flex; align-items: center; gap: 6px; font-weight: 600; font-size: 13px;
      transition: background-color 0.2s, box-shadow 0.2s, transform 0.1s;
    }
    button:hover, a.btn:hover { background-color: var(--accent-hover); box-shadow: 0 4px 12px rgba(30, 64, 175, 0.15); }
    button:active, a.btn:active { transform: translateY(1px); }
    button.secondary, a.btn.secondary { background-color: #f3f4f6; color: #374151; border: 1px solid var(--border-color); }
    button.secondary:hover, a.btn.secondary:hover { background-color: #e5e7eb; }
    button.ghost { background: transparent; color: var(--accent); border: 1px solid #bfd5ff; }
    button.ghost:hover { background: #e0f2fe; }
    button:disabled, a.btn[aria-disabled="true"] { background-color: #e5e7eb; color: #9ca3af; cursor: not-allowed; box-shadow: none; transform: none; }
    button .spinner { width: 14px; height: 14px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .chip { display: inline-flex; align-items: center; gap: 6px; background: #e0f2fe; color: var(--accent); border-radius: 999px; padding: 4px 10px; font-size: 12px; font-weight: 600; border: 1px solid rgba(30, 64, 175, 0.1); }

    /* File Drop Zone */
    #drop_zone { border: 2px dashed var(--border-color); border-radius: 12px; padding: 20px; text-align: center; cursor: pointer; transition: background-color 0.2s, border-color 0.2s; }
    #drop_zone.dragover { background-color: #e0f2fe; border-color: var(--accent); }
    #drop_zone p { margin: 0; color: var(--muted-text); font-weight: 500; }
    #drop_zone p small { display: block; font-size: 12px; margin-top: 4px; }
    #filename { font-weight: 600; color: var(--accent); margin-top: 8px; font-size: 13px; }

    /* --- Panels & Layout --- */
    .panel {
      background: var(--card-bg); border-radius: 12px; padding: 20px; margin-top: 20px;
      border: 1px solid var(--border-color);
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.03), 0 2px 4px -2px rgba(0,0,0,0.03);
      animation: slideUpIn 0.5s ease-out forwards;
    }
    .panel h3 { margin: 0 0 16px 0; font-size: 16px; color: var(--primary-text); }
    .two-col { display: grid; grid-template-columns: 1fr 380px; gap: 20px; }
    .editor-grid { width: 100%; border-collapse: collapse; font-size: 14px; border-radius: 8px; overflow: hidden; border: 1px solid #e5e7eb; }
    .editor-grid th, .editor-grid td { border-bottom: 1px solid #e5e7eb; padding: 10px 12px; text-align: left; }
    .editor-grid th { background: #f9fafb; font-weight: 600; color: var(--primary-text); }
    .editor-grid tr:hover td { background-color: #f9fafb; }

    /* --- Status Bar --- */
    .statusbar {
      position: sticky; top: 92px; z-index: 50; background: var(--card-bg); border-radius: 10px;
      padding: 8px 16px; border: 1px solid var(--border-color); font-size: 13px; margin: 16px 0;
      display: flex; justify-content: space-between; align-items: center; animation: slideUpIn 0.4s ease-out forwards;
    }
    .statusbar .left { color: var(--accent); font-weight: 600; }
    .statusbar.ok { background: #ecfdf5; border-color: #a7f3d0; color: #065f46; }
    .statusbar.warn { background: #fffbeb; border-color: #fde68a; color: #854d0e; }
    .statusbar.err { background: #fef2f2; border-color: #fecaca; color: #991b1b; }

    /* --- Report Form Preview (The Core) --- */
    #singleView .sheet {
      width: 100%; min-height: 420px; background: #fff; padding: 20px; border-radius: 10px;
      border: 1px solid var(--border-color);
      box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05), 0 4px 6px -4px rgba(0,0,0,0.05);
      overflow: hidden;
    }
    
    /* School Header */
    .school-head { text-align: center; line-height: 1; margin-bottom: 10px; padding: 10px 0; border-bottom: 2px solid #e5e7eb; }
    .school-head h1 { margin: 0; font-size: 24px; font-weight: 800; color: var(--primary-text); letter-spacing: -0.5px; }
    .school-head .addr { font-size: 12px; color: var(--muted-text); margin-top: 2px; }
    .school-head .motto { margin-top: 4px; font-weight: 700; color: var(--accent); font-size: 14px; }
    
    /* Key and Title */
    .key { font-size: 11px; color: var(--muted-text); text-align: center; margin: 8px 0; padding: 4px 8px; background: #f9fafb; border-radius: 4px; }
    .title { text-align: center; font-weight: 700; margin: 10px 0 16px; font-size: 16px; text-transform: uppercase; color: var(--primary-text); }
    
    /* Metadata Box */
    .meta { display: grid; grid-template-columns: 1fr 1fr; gap: 8px 16px; border: 1px solid var(--border-color); padding: 12px; border-radius: 8px; font-size: 13px; margin-bottom: 16px; background: #fcfcfc; }
    .meta div { display: flex; gap: 8px; align-items: center; }
    .meta label { font-weight: 700; min-width: 110px; color: var(--primary-text); }

    /* --- Report Table (Compact & Print-Friendly) --- */
    table.report { width: 100%; border-collapse: collapse; font-size: 11.5px; table-layout: fixed; margin-bottom: 12px; }
    table.report th, table.report td { border: 1px solid #d1d5db; padding: 7px 4px; text-align: center; word-break: break-word; }
    table.report th { background-color: var(--header-bg); font-weight: 700; color: var(--primary-text); }
    
    /* V5 Fixed Width for Learning Area */
    table.report thead th:first-child { 
        width: 18%; /* Set Learning Area to 18% width */
        min-width: 18%; /* Ensure it holds the width */
    } 
    /* V7: Increased row padding for better readability */
    table.report tbody td { padding: 9px 4px; } 

    table.report tbody tr:nth-child(even) { background-color: #f9fafb; }
    table.report td.label { text-align: left; padding-left: 10px; font-weight: 600; color: #374151; }

    /* --- Mini Chart & Label (V13 - Professional Bar Graph) --- */
    .performance-section {
        display: flex; 
        align-items: flex-start;
        gap: 15px; 
        margin: 16px 0 0; 
    }
    /* V11/V13: Styled header for the chart area */
    .performance-label {
        font-weight: 800;
        color: var(--primary-text);
        font-size: 12px; 
        flex-shrink: 0; 
        width: 35%; 
        line-height: 1.3;
        padding-top: 5px; 
    }
    .label-style-1 { color: #8433FF; } /* Purple */
    .label-style-2 { color: #007bff; } /* Blue */
    .label-style-3 { color: #28a745; } /* Green */

    .mini-chart-wrap {
        margin: 0; 
        flex-grow: 1; 
        border-left: 1px solid var(--border-color); 
        padding-left: 15px;
        position: relative;
        height: 100px; /* Increased height for bar chart and labels */
    }

    /* V13: Bar Chart Container (Flexbox) */
    .mini-chart { 
        display: flex;
        justify-content: space-around;
        align-items: flex-end; /* Bars start at the bottom */
        position: relative;
        height: 75px; /* Height of the actual plotting area */
        width: 100%;
        border-bottom: 1px solid #ccc; /* X-axis baseline */
        margin-top: 5px; 
        padding-bottom: 10px; /* Space for the bottom labels */
        box-sizing: content-box;
    }

    /* V13: Individual Bar Item */
    .bar-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-end; 
        position: relative;
        height: 100%; /* Allows flexbox to manage alignment */
        width: 25%; /* Space out the three bars */
        margin: 0 5%;
        text-align: center;
    }

    /* V13: The Actual Bar Fill */
    .chart-bar {
        /* --bar-height is set dynamically in JS */
        height: var(--bar-height); 
        width: 100%;
        min-height: 3px; /* Ensure even a zero score is visible as a dot */
        background: linear-gradient(to top, #1e40af, #3b82f6); /* Professional Gradient */
        border-radius: 4px 4px 0 0; /* Rounded top corners */
        box-shadow: 0 -2px 4px rgba(30, 64, 175, 0.2); /* Subtle shadow for depth */
        transition: height 0.5s ease-out;
    }

    /* V13: Score Value Label (Above the bar) */
    .bar-value {
        font-size: 10px;
        font-weight: 700;
        color: var(--primary-text);
        margin-bottom: 2px;
        white-space: nowrap;
        text-shadow: 0 0 2px white;
    }
    
    /* V13: Phase Label (Below the chart) */
    .chart-labels { 
        display: flex;
        justify-content: space-around;
        width: 100%;
        position: absolute;
        bottom: 0;
        left: 0;
        padding-left: 15px; /* Aligns with the bar chart area */
    }
    .chart-label {
        width: 30%; /* Gives enough space for text */
        text-align: center;
        font-weight: 600;
        line-height: 1.1;
        font-size: 10px;
        white-space: nowrap;
    }
    .chart-label.opener { color: #2563eb; }
    .chart-label.mid { color: #059669; }
    .chart-label.end { color: #dc2626; }


    /* --- Comments & Footer (V7/V8/V9 - Minimized Space) --- */
    .teacher-comments-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-top: 20px;
        font-size: 12px;
    }
    .comments-block {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }
    .comments-block > div:first-child {
        font-weight: 700;
        margin-bottom: 2px;
        color: var(--accent);
        border-bottom: 1px dashed #e5e7eb;
        padding-bottom: 4px;
        font-size: 13px;
    }
    .comments-block > div:nth-child(2) { /* The actual comment text */
        min-height: 25px;
        line-height: 1.3;
        color: var(--primary-text);
    }

    .sign-row {
        display: grid;
        /* V9: Adjusted column count for Head Teacher block */
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-top: 4px;
    }
    /* Specific adjustment for HT block which now only has a signature */
    #ht-block .sign-row {
        grid-template-columns: 1fr; /* Only one column for signature */
    }
    /* Specific adjustment for CT block which has name and signature */
    #ct-block .sign-row {
        grid-template-columns: 1fr 1fr;
    }

    .sign {
        border: none;
        border-bottom: 1px solid #9ca3af; /* A line for signature */
        padding: 0;
        border-radius: 0;
        min-height: 25px;
        background: transparent;
        line-height: 1.2;
        font-size: 11px;
        display: flex;
        align-items: flex-end;
        padding-bottom: 2px;
    }
    .sign b {
        color: #374151;
        font-weight: 600;
        margin-right: 4px;
    }

    /* Parent Comments (V9 - Minimized Space) */
    .parent-comments {
        margin-top: 15px;
        font-size: 12px;
    }
    .parent-comments .block {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }
    .parent-comments .block > div:first-child {
        font-weight: 700;
        margin-bottom: 2px;
        color: #9d5a0d;
        border-bottom: 1px dashed #fcd34d;
        padding-bottom: 4px;
        font-size: 13px;
    }
    .parent-comments .sign-row {
        grid-template-columns: 1.2fr 1.8fr 1fr;
        gap: 10px;
        margin-top: 4px;
    }
    /* Specific styling for parent comment block to ensure proper alignment */
    .parent-comments .sign-row .sign:nth-child(2) { /* The parent comment field */
      grid-column: span 1;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      border-bottom: 1px solid #9ca3af;
    }
    .parent-comments .sign-row .sign:nth-child(2) b {
        white-space: nowrap;
        margin-bottom: 2px;
    }


    /* Foot Dates (V9 - Minimized Space) */
    .foot-dates {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-top: 15px;
        font-size: 12px;
    }
    .foot-dates .sign {
        background: transparent;
        border: none;
        border-bottom: 1px solid #9ca3af;
        min-height: 25px;
    }
    
    .small { color: var(--muted-text); font-size: 10px; text-align: center; margin-top: 16px; }

    /* --- Toasts & Dialogs --- (Unchanged) */
    .toasts { position: fixed; right: 20px; bottom: 20px; display: flex; flex-direction: column; gap: 12px; z-index: 9999; }
    .toast {
      background: #27272a; color: white; padding: 12px 16px; border-radius: 8px;
      box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.1);
      font-size: 14px; display: flex; align-items: center; gap: 8px; font-weight: 500;
      animation: toastIn 0.4s ease-out;
    }
    .toast.exiting { animation: toastOut 0.4s ease-in forwards; }
    .toast.success { background-color: var(--success); }
    .toast.error { background-color: var(--danger); }
    .toast.warn { background-color: var(--warn); color: #1e293b; }

    dialog { border-radius: 12px; padding: 0; border: 1px solid var(--border-color); box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); max-width: 740px; width: 90%; }
    dialog::backdrop { background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); }
    dialog[open] { animation: slideUpIn 0.4s ease-out; }
    .dlg-hd { padding: 16px 20px; font-weight: 700; font-size: 16px; border-bottom: 1px solid var(--border-color); }
    .dlg-bd { padding: 20px; line-height: 1.6; }
    .dlg-ft { padding: 12px 20px; display: flex; gap: 10px; justify-content: flex-end; border-top: 1px solid #f9fafb; background: #f9fafb; }
    #errorDlg .dlg-hd { background: #fef2f2; color: var(--danger); }
    #confirmDlg .dlg-hd { background: #fffbeb; color: #854d0e; }
    pre.err { background: #f9fafb; border: 1px solid var(--border-color); padding: 12px; max-height: 240px; overflow: auto; border-radius: 6px; font-size: 13px; }

    /* --- Responsive & Print --- */
    @media (max-width: 960px) {
      .app { padding: 0 16px; margin: 16px auto; }
      .two-col { grid-template-columns: 1fr; }
      .bar { flex-direction: column; align-items: stretch; top: 0; border-radius: 0; }
      .statusbar { top: 180px; }
      #singleView .sheet { padding: 12px; }
    }
    @media print {
      @page { size: A4 portrait; margin: 8mm; } 
      html, body { height: auto !important; background: #fff; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      .bar, .panel, .statusbar, .toasts, #singleView { display: none !important; }
      #batchContainer { display: block !important; }
      .sheet {
        width: 100%; margin: 0; padding: 6mm; border: none; border-radius: 0; box-shadow: none;
        page-break-after: always; box-sizing: border-box; overflow: visible;
      }
      .school-head h1 { font-size: 20px; }
      .title { font-size: 14px; }
      table.report { font-size: 10.5px; }
      table.report th, table.report td { padding: 5px 2px; border-color: #000; } /* Adjusted padding for print */
      .meta { font-size: 11px; padding: 6px; }
      .comments-block, .parent-comments .block { min-height: auto; padding: 0; } /* No min-height or padding in print */
      .mini-chart-wrap { height: 75px; } /* Adjusted height for print */
      .mini-chart { height: 60px; padding-bottom: 8px;}
      .chart-bar { min-height: 2px; }
      .bar-value { font-size: 9px; margin-bottom: 1px;}
      .chart-labels { font-size: 9px; padding-left: 15px; }
      .chart-label { font-size: 9px; }
      .small { font-size: 9px; margin-top: 10px; }
      .report { table-layout: fixed; word-wrap: break-word; }
      /* Adjust print width to match screen ratio */
      table.report thead th:first-child { width: 18%; }
      .sign-row { gap: 8px; margin-top: 6px; }
      .sign { padding: 0; min-height: 20px; border-bottom: 1px solid #000; font-size: 10px; } /* Print signature line */
      .sign b { margin-right: 2px; }
      .performance-section { gap: 10px; margin: 10px 0 0;}
      .performance-label { font-size: 11px; width: 30%; } /* Adjusted for print */
      .comments-block > div:first-child { font-size: 12px; margin-bottom: 0px; padding-bottom: 2px; }
      .comments-block > div:nth-child(2) { min-height: 20px; } /* Min height for comment text in print */
    }
  </style>
</head>
<body>
<div class="app">
  <div class="bar" role="toolbar" aria-label="Main toolbar">
    <div class="group" style="flex: 1;">
      <div id="drop_zone">
        <input type="file" id="file" accept=".xlsx,.xls" hidden />
        <p>Drag & Drop Workbook (.xlsx) here, or click to select</p>
        <p><small>All processing is done locally in your browser. No data is uploaded.</small></p>
        <div id="filename"></div>
      </div>
    </div>
    <div class="group">
      <button id="printSelectedBtn" disabled class="ghost">Print Selected</button>
      <button id="printFilteredBtn" disabled class="ghost">Batch Print</button>
    </div>
    <div class="group">
      <a id="downloadExcelLink" class="btn secondary" aria-disabled="true">Download Updated Excel</a>
      <span class="chip" id="unsavedChip" style="display:none">Unsaved</span>
    </div>
  </div>

  <div id="statusBar" class="statusbar" aria-live="polite" style="display:none;">
    <div class="left">Ready</div>
    <div class="right muted" id="statusDetails">Load a workbook to begin.</div>
  </div>

  <div id="mainContent" style="display:none;">
    <div class="panel" id="filtersPanel">
      <h3>Filters</h3>
      <div style="display:flex; gap:16px; flex-wrap:wrap; align-items:center;">
        <div class="group"><label for="learnerSel">Learner:</label><select id="learnerSel"></select></div>
        <div class="group"><label for="fGender">Gender:</label><select id="fGender"><option value="">All</option><option>M</option><option>F</option></select></div>
        <div class="group"><label for="fGrade">Grade:</label><select id="fGrade"><option value="">All</option></select></div>
        <div class="group">
          <button id="applyFiltersBtn" class="secondary">Apply</button>
          <button id="clearFiltersBtn" class="secondary">Clear</button>
          <span class="muted" id="matchCountChip">0 selected</span>
        </div>
      </div>
    </div>

    <div class="panel" id="editorPanel">
      <h3>Edit Marks <small class="muted">(writes back to Learners sheet)</small></h3>
      <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:16px;">
        <div class="group"><label for="phaseSel">Phase:</label>
          <select id="phaseSel"><option value="Opener">Opener</option><option value="Mid">Midterm</option><option value="End">End term</option></select>
        </div>
        <div class="group">
          <button id="savePhaseBtn">Save to Learner</button>
          <button id="applyOutOfAllBtn" class="secondary">Apply 'Out Of' to ALL</button>
        </div>
      </div>

      <div class="two-col">
        <div>
          <table class="editor-grid" id="marksGrid" aria-label="Marks editor">
            <thead><tr><th>Learning Area</th><th style="width:140px">Score</th><th style="width:140px">Out Of</th></tr></thead>
            <tbody id="marksBody"></tbody>
          </table>
        </div>
        <div>
          <h4 style="margin:0 0 8px; font-size:15px;">Live Preview</h4>
          <div id="singleView"><div class="sheet" id="singleSheet" aria-label="Report Form Preview"></div></div>
        </div>
      </div>
    </div>
  </div>

  <div id="batchContainer" aria-hidden="true" style="display:none"></div>
</div>

<div class="toasts" id="toasts" aria-live="polite" aria-atomic="true"></div>

<dialog id="errorDlg">
  <div class="dlg-hd">An Error Occurred</div>
  <div class="dlg-bd">
    <p>We encountered a problem while processing your request. Please see the details below.</p>
    <pre class="err" id="errDetails"></pre>
  </div>
  <div class="dlg-ft">
    <button id="copyErrBtn" class="secondary">Copy Details</button>
    <button id="closeErrBtn">Close</button>
  </div>
</dialog>

<dialog id="confirmDlg">
  <div class="dlg-hd">Confirm Action</div>
  <div class="dlg-bd" id="confirmMsg"></div>
  <div class="dlg-ft">
    <button id="confirmCancelBtn" class="secondary">Cancel</button>
    <button id="confirmOkBtn" class="warn">Confirm</button>
  </div>
</dialog>

<script>
(function() {
  "use strict";

  // --- Configuration ---
  const SUBJECTS = [
    { key:'ENG',     label:'ENGLISH' },
    { key:'COMP',    label:'COMPOSITION' },
    { key:'KISW',    label:'KISWAHILI' },
    { key:'INSHA',   label:'INSHA' },
    { key:'MATH',    label:'MATHEMATICS' },
    { key:'SCIE',    label:'INTER/SCIE' },
    { key:'SST',     label:'S/S' },
    { key:'CRE',     label:'CRE' },
    { key:'AGRI',    label:'AGRI/NUT' },
    { key:'CA',      label:'C/ART' },
    { key:'PRETECH', label:'PRE-TECH' },
  ];
  const MARK_KEYS = SUBJECTS.flatMap(s => [
    `${s.key}_Opener`, `${s.key}_Opener_OutOf`,
    `${s.key}_Mid`,    `${s.key}_Mid_OutOf`,
    `${s.key}_End`,    `${s.key}_End_OutOf`
  ]);
  const DEFAULT_THRESHOLDS = [{min:81,grade:'EE'},{min:50,grade:'ME'},{min:26,grade:'AE'},{min:0,grade:'BE'}];

  // --- DOM References ---
  const $ = sel => document.querySelector(sel);
  const $$ = sel => document.querySelectorAll(sel);
  
  // Toolbar & File
  const $dropZone = $('#drop_zone');
  const $fileInput = $('#file');
  const $filename = $('#filename');
  const $printSelectedBtn = $('#printSelectedBtn');
  const $printFilteredBtn = $('#printFilteredBtn');
  const $downloadExcelLink = $('#downloadExcelLink');
  const $unsavedChip = $('#unsavedChip');

  // Main UI
  const $statusBar = $('#statusBar');
  const $statusLeft = $('#statusBar .left');
  const $statusDetails = $('#statusBar .right');
  const $mainContent = $('#mainContent');

  // Filters
  const $learnerSel = $('#learnerSel');
  const $fGender = $('#fGender');
  const $fGrade = $('#fGrade');
  const $applyFiltersBtn = $('#applyFiltersBtn');
  const $clearFiltersBtn = $('#clearFiltersBtn');
  const $matchCountChip = $('#matchCountChip');

  // Editor
  const $phaseSel = $('#phaseSel');
  const $marksBody = $('#marksBody');
  const $savePhaseBtn = $('#savePhaseBtn');
  const $applyOutOfAllBtn = $('#applyOutOfAllBtn');
  const $singleSheet = $('#singleSheet');
  const $batchContainer = $('#batchContainer');

  // Dialogs & Toasts
  const $toasts = $('#toasts');
  const $errorDlg = $('#errorDlg');
  const $errDetails = $('#errDetails');
  const $confirmDlg = $('#confirmDlg');
  const $confirmMsg = $('#confirmMsg');

  // --- Application State ---
  let learners = [];
  let originalLearnersSnapshot = [];
  let thresholds = DEFAULT_THRESHOLDS;
  let filteredLearners = [];
  let originalWb = null;
  let headerIndexMap = {};
  let unsavedChanges = false;

  // Persisted sheet visual properties for high-fidelity saving
  let learnersSheetName = null;
  let learnersSheetCols = null;
  let learnersSheetRows = null;
  let learnersSheetMerges = null;
  let originalWorkbookViews = null;
  let originalWorkbookProps = null;
  let sheetSavedViews = null;

  // --- UI & Utility Helpers ---
  
  /** Shows a status message in the status bar */
  function setStatus(msg, type = 'ok', details = '') {
    $statusBar.style.display = 'flex';
    $statusBar.className = `statusbar ${type}`;
    $statusLeft.textContent = msg;
    $statusDetails.textContent = details;
  }
  
  /** Displays a toast notification */
  function toast(msg, type = 'success', timeout = 2500) {
    const el = document.createElement('div');
    el.className = `toast ${type}`;
    el.textContent = msg;
    $toasts.appendChild(el);
    setTimeout(() => {
      el.classList.add('exiting');
      el.addEventListener('animationend', () => el.remove());
    }, timeout);
  }

  /** Wraps a function in robust error handling UI */
  function withErrorUI(fn) {
    return async (...args) => {
      try {
        return await fn(...args);
      } catch (err) {
        console.error(err);
        const details = `Message: ${err?.message || err}\n\nStack:\n${err?.stack || '(no stack)'}`;
        $errDetails.textContent = details;
        $errorDlg.showModal();
        setStatus('Action failed', 'err', err.message);
        toast('Something went wrong', 'error');
      }
    };
  }
  
  /** Shows a confirmation dialog */
  function confirmAction(message) {
    return new Promise(resolve => {
      $confirmMsg.textContent = message;
      $confirmDlg.showModal();
      const onConfirm = () => { cleanup(); resolve(true); };
      const onCancel = () => { cleanup(); resolve(false); };
      const cleanup = () => {
        $('#confirmOkBtn').removeEventListener('click', onConfirm);
        $('#confirmCancelBtn').removeEventListener('click', onCancel);
        $confirmDlg.close();
      };
      $('#confirmOkBtn').addEventListener('click', onConfirm, { once: true });
      $('#confirmCancelBtn').addEventListener('click', onCancel, { once: true });
      // Dialog close with Escape key or backdrop click also cancels
      $confirmDlg.onclose = onCancel;
    });
  }

  /** Toggles the loading state of a button */
  function setButtonLoading(button, isLoading) {
    if (isLoading) {
      button.disabled = true;
      button.dataset.originalText = button.innerHTML;
      button.innerHTML = `<span class="spinner"></span> Loading...`;
    } else {
      button.disabled = false;
      button.innerHTML = button.dataset.originalText || 'Action';
    }
  }

  /** Updates the unsaved changes indicator */
  function showUnsaved(flag) {
    unsavedChanges = flag;
    $unsavedChip.style.display = flag ? 'inline-flex' : 'none';
    $downloadExcelLink.setAttribute('aria-disabled', !flag);
  }
  
  // --- Core Logic Helpers ---
  const getIndex = (row) => Number(row.Index ?? row.index ?? row.INDEX);
  const pctGrade = (score, outOf) => {
    if (outOf <= 0 || score === null || score === '') return { pct: 0, grade: 'BE' };
    const pct = Math.max(0, Math.round((Number(score) / Number(outOf)) * 100));
    const t = thresholds.find(t => pct >= t.min) || { grade: 'BE' };
    return { pct, grade: t.grade };
  };
  const escapeHTML = (s) => String(s ?? '').replace(/[&<>"']/g, (c) => ({ "&": "&amp;", "<": "&lt;", ">": "&quot;", "'": "&#39;" }[c]));
  const termWord = (n) => ({ 1: 'ONE', 2: 'TWO', 3: 'THREE' }[n] || String(n));

  /** Calculates the height for a bar graph point (V13) */
  function calcGraphHeight(score, maxVal) {
    if (maxVal === 0 || score === 0) return 0; 
    // Calculate percentage height of the score relative to the max score
    const percent = Math.min(100, (score / maxVal) * 100);
    return percent; 
  }

  /** Generates the performance bar chart HTML (V13) */
  function htmlChartTotals(oSc, mSc, eSc) {
    const totalMax = Math.max(oSc, mSc, eSc, 10); // Use a baseline max of 10 for very low scores
    
    // Calculate heights as a percentage of the total max score
    const hOpener = calcGraphHeight(oSc, totalMax);
    const hMid = calcGraphHeight(mSc, totalMax);
    const hEnd = calcGraphHeight(eSc, totalMax);

    return `<div class="mini-chart-wrap" aria-hidden="true">
        <div class="mini-chart" role="img" aria-label="Performance bar chart">
            <div class="bar-item">
                <span class="bar-value">${oSc}</span>
                <div class="chart-bar" style="--bar-height: ${hOpener}%" title="Opener Total: ${oSc}"></div>
            </div>
            <div class="bar-item">
                <span class="bar-value">${mSc}</span>
                <div class="chart-bar" style="--bar-height: ${hMid}%" title="Midterm Total: ${mSc}"></div>
            </div>
            <div class="bar-item">
                <span class="bar-value">${eSc}</span>
                <div class="chart-bar" style="--bar-height: ${hEnd}%" title="End term Total: ${eSc}"></div>
            </div>
        </div>
        <div class="chart-labels">
            <span class="chart-label opener">Opener</span>
            <span class="chart-label mid">Midterm</span>
            <span class="chart-label end">Endterm</span>
        </div>
    </div>`;
  }

  /** Generates the full HTML for a single report form (V13) */
  function htmlReport(row) {
    const school = { name: 'ITIATI JUNIOR SCHOOL', address1: 'P.O. BOX 160-10101', town: 'KARATINA', motto: 'HARDWORK FOR EXCELLENCE' };
    const pupilName = row["Pupil's Name"] || row["Pupil Name"] || ''; const grade = row["Grade"] ?? ''; const term = row["Term"] ?? ''; const year = row["Year"] ?? '';
    
    // Teacher/Headteacher fields for the two-column comments section
    const ctComment = row["Class_Teacher_Comment"] || ''; const ctName = row["Class_Teacher_Name"] || ''; const ctSign = row["Class_Teacher_Signature"] || row["Class_Teacher_Sign"] || ''; 
    const htComment = row["Head_Teacher_Comment"] || ''; const htName = row["Head_Teacher_Name"] || ''; const htSign = row["Head_Teacher_Signature"] || row["Head_Teacher_Sign"] || ''; 
    
    // New fields for Parent/Guardian
    const parentComment = row["Parent_Comment"] || ''; const parentName = row["Parent_Name"] || ''; const parentSign = row["Parent_Signature"] || row["Parent_Sign"] || '';
    
    const closingDate = row["Closing_Date"] || row["Closing Date"] || ''; const openingDate = row["Opening_Date"] || row["Opening Date"] || '';
    
    const subRows = SUBJECTS.map(s => {
      const oSc = Number(row[`${s.key}_Opener`]) || 0, oMax = Number(row[`${s.key}_Opener_OutOf`]) || 0;
      const mSc = Number(row[`${s.key}_Mid`]) || 0, mMax = Number(row[`${s.key}_Mid_OutOf`]) || 0;
      const eSc = Number(row[`${s.key}_End`]) || 0, eMax = Number(row[`${s.key}_End_OutOf`]) || 0;
      const oG = pctGrade(oSc, oMax).grade, mG = pctGrade(mSc, mMax).grade, eG = pctGrade(eSc, eMax).grade;
      return { label: s.label, oSc, oMax, oG, mSc, mMax, mG, eSc, eMax, eG };
    });
    // Calculate totals for the chart
    const total = subRows.reduce((a, r) => { a.oSc += r.oSc; a.oMax += r.oMax; a.mSc += r.mSc; a.mMax += r.mMax; a.eSc += r.eSc; a.eMax += r.eMax; return a; }, { oSc: 0, oMax: 0, mSc: 0, mMax: 0, eSc: 0, eMax: 0 });
    const title = `END TERM ${termWord(Number(term))} ASSESSMENT - YEAR ${year}`;

    return `<div class="school-head">
        <h1>${escapeHTML(school.name)}</h1>
        <div class="addr">${escapeHTML(school.address1)} • ${escapeHTML(school.town)}</div>
        <div class="motto">${escapeHTML(school.motto)}</div>
      </div>
      <div class="key">KEY: <b>EE</b>–Exceeding Expectations, <b>ME</b>–Meeting Expectations, <b>AE</b>–Approaching Expectations, <b>BE</b>–Below Expectations</div>
      <div class="title">${escapeHTML(title)}</div>
      <div class="meta">
        <div><label>PUPIL'S NAME:</label><div>${escapeHTML(pupilName)}</div></div>
        <div><label>GRADE:</label><div>${escapeHTML(String(grade))}</div></div>
      </div>
      <table class="report" role="table" aria-label="Learner report">
        <thead>
          <tr><th rowspan="2">LEARNING AREA</th><th colspan="3">OPENER</th><th colspan="3">MIDTERM</th><th colspan="3">END TERM</th></tr>
          <tr><th>SCORE</th><th>OUTOF</th><th>GRADE</th><th>SCORE</th><th>OUTOF</th><th>GRADE</th><th>SCORE</th><th>OUTOF</th><th>GRADE</th></tr>
        </thead>
        <tbody>
          ${subRows.map(r => `<tr><td class="label">${r.label}</td><td>${r.oSc}</td><td>${r.oMax}</td><td>${r.oG}</td><td>${r.mSc}</td><td>${r.mMax}</td><td>${r.mG}</td><td>${r.eSc}</td><td>${r.eMax}</td><td>${r.eG}</td></tr>`).join('')}
        </tbody>
      </table>
      <div class="performance-section">
        <div class="performance-label">
            <span class="label-style-1">Graphical</span> 
            <span class="label-style-2">representation</span> 
            of <span class="label-style-3">learner performance</span> 
            this term
        </div>
        ${htmlChartTotals(total.oSc, total.mSc, total.eSc)}
      </div>
      
      <div class="teacher-comments-row">
        <div class="comments-block" id="ct-block">
            <div>CLASS TEACHER</div>
            <div>${escapeHTML(ctComment) || 'Comment...'}</div>
            <div class="sign-row">
                <div class="sign"><b>Name:</b> ${escapeHTML(ctName)}</div>
                <div class="sign"><b>Signature:</b> ${escapeHTML(ctSign)}</div>
            </div>
        </div>
        
        <div class="comments-block" id="ht-block">
            <div>HEAD TEACHER</div>
            <div>${escapeHTML(htComment) || 'Comment...'}</div>
            <div class="sign-row">
                <div class="sign"><b>Signature:</b> ${escapeHTML(htSign)}</div>
            </div>
        </div>
      </div>
      
      <div class="parent-comments">
          <div class="block">
              <div>PARENT/GUARDIAN</div>
              <div class="sign-row">
                  <div class="sign"><b>Name:</b> ${escapeHTML(parentName)}</div>
                  <div class="sign"><b>Comment:</b> ${escapeHTML(parentComment)}</div>
                  <div class="sign"><b>Signature:</b> ${escapeHTML(parentSign)}</div>
              </div>
          </div>
      </div>
      
      <div class="foot-dates">
          <div class="sign"><b>CLOSING DATE:</b> ${escapeHTML(closingDate)}</div>
          <div class="sign"><b>OPENING DATE:</b> ${escapeHTML(openingDate)}</div>
      </div>
      <div class="small">This report is designed to fit on a single A4 page when printed at 100% scale.</div>`;
  }

  // --- Data Manipulation & Actions --- (Retained for functionality)
  
  function resetUI() {
    $mainContent.style.display = 'none';
    $statusBar.style.display = 'none';
    $filename.textContent = '';
    learners = [];
    originalLearnersSnapshot = [];
    filteredLearners = [];
    originalWb = null;
    showUnsaved(false);
    $$('button, a.btn, select').forEach(el => el.disabled = true);
    $dropZone.querySelector('p').style.display = 'block';
    $fileInput.value = '';
  }

  function hydrateGrades() {
    const grades = [...new Set(learners.map(r => String(r.Grade || '').trim()).filter(Boolean))].sort();
    $fGrade.innerHTML = '<option value="">All</option>' + grades.map(g => `<option>${g}</option>`).join('');
  }
  
  function applyFilters() {
    const gender = ($fGender.value || '').trim().toUpperCase();
    const grade = ($fGrade.value || '').trim();
    filteredLearners = learners.filter(r => {
      if (gender && String(r.Gender || '').trim().toUpperCase() !== gender) return false;
      if (grade && String(r.Grade || '').trim() !== grade) return false;
      return true;
    }).sort((a, b) => getIndex(a) - getIndex(b));
    hydrateLearnerDropdown();
    if (filteredLearners.length) {
      $learnerSel.selectedIndex = 1; // Select first learner
      renderSelected(0);
    } else {
      $singleSheet.innerHTML = '<p style="text-align:center;padding:2rem;">No learners match the selected filters.</p>';
      $marksBody.innerHTML = '';
    }
  }

  function clearFilters() {
    $fGender.value = '';
    $fGrade.value = '';
    applyFilters();
  }
  
  function hydrateLearnerDropdown() {
    $learnerSel.innerHTML = '<option value="">— Select a learner to view or edit —</option>' + filteredLearners.map((r, i) => {
      const idx = getIndex(r);
      const labelIdx = Number.isNaN(idx) ? `(${i + 1})` : idx;
      const name = r["Pupil's Name"] || `Learner ${i + 1}`;
      return `<option value="${i}">${labelIdx}. ${escapeHTML(name)}</option>`;
    }).join('');
    const hasLearners = learners.length > 0;
    $$('button, a.btn, select').forEach(el => { if(el.id !== 'file') el.disabled = !hasLearners });
    showUnsaved(unsavedChanges); // Re-apply disabled state to download link
    $matchCountChip.textContent = `${filteredLearners.length} selected`;
  }

  function renderSelected(index) {
    const row = filteredLearners[index];
    if (!row) return;
    $singleSheet.innerHTML = `<div class="sheet">${htmlReport(row)}</div>`;
    buildMarksGrid(row);
  }

  function buildMarksGrid(row) {
    const phase = $phaseSel.value;
    $marksBody.innerHTML = SUBJECTS.map(s => {
      const score = row[`${s.key}_${phase}`] ?? '';
      const outOf = row[`${s.key}_${phase}_OutOf`] ?? '';
      return `<tr data-key="${s.key}"><td>${s.label}</td><td><input type="number" step="0.01" class="score" value="${score}"></td><td><input type="number" step="0.01" class="outof" value="${outOf}"></td></tr>`;
    }).join('');
  }
  
  const currentSelectedRow = () => {
    const idx = Number($learnerSel.value);
    return (Number.isInteger(idx) && idx >= 0) ? filteredLearners[idx] : null;
  }
  
  function savePhaseToLearner() {
    const row = currentSelectedRow();
    if (!row) return;
    const phase = $phaseSel.value;
    $marksBody.querySelectorAll('tr').forEach(tr => {
      const key = tr.dataset.key;
      row[`${key}_${phase}`] = Number(tr.querySelector('input.score').value || 0);
      row[`${key}_${phase}_OutOf`] = Number(tr.querySelector('input.outof').value || 0);
    });
    showUnsaved(true);
    renderSelected(Number($learnerSel.value));
    toast(`Saved marks for ${phase} phase ✓`, 'success');
    setStatus('Marks saved', 'ok');
  }

  async function applyOutOfToAllLearners() {
      const confirmed = await confirmAction("This will apply the 'Out Of' values from the currently displayed learner to ALL learners in the workbook for this phase. This action cannot be undone. Are you sure you want to proceed?");
      if (!confirmed) return;

      const phase = $phaseSel.value;
      const template = {};
      $marksBody.querySelectorAll('tr').forEach(tr => {
        const key = tr.dataset.key;
        const outOf = tr.querySelector('input.outof').value;
        if (outOf !== '' && !Number.isNaN(Number(outOf))) template[key] = Number(outOf);
      });
      if (!Object.keys(template).length) return;
      learners.forEach(r => {
        for (const k in template) { r[`${k}_${phase}_OutOf`] = template[k]; }
      });
      showUnsaved(true);
      if (currentSelectedRow()) renderSelected(Number($learnerSel.value));
      toast("'Out Of' values applied to ALL learners ✓", 'success');
      setStatus("Applied 'Out Of' to all", 'ok');
  }

  function printRows(rows) {
    if (!rows || !rows.length) return;
    $batchContainer.innerHTML = rows.map(r => `<div class='sheet'>${htmlReport(r)}</div>`).join('');
    // Use requestAnimationFrame to ensure the DOM is updated before printing
    requestAnimationFrame(() => {
      window.print();
    });
    toast('Opening print dialog…', 'warn', 1800);
    setStatus('Printing…', 'warn');
  }
  
  function updateMarksInPlace() {
    const ws = originalWb.Sheets[learnersSheetName];
    if (!ws) throw new Error(`Could not find the worksheet named '${learnersSheetName}'.`);
    
    const getRowNumByIndex = (index) => {
        const learner = originalLearnersSnapshot.find(l => getIndex(l) == index);
        return learner ? learner._rowNumber : -1;
    }

    learners.forEach(currentLearner => {
      const learnerIndex = getIndex(currentLearner);
      const rowNum = getRowNumByIndex(learnerIndex);
      if (rowNum === -1) return; 

      MARK_KEYS.forEach(key => {
        const c = headerIndexMap[key];
        if (c === undefined) return;

        const originalValue = originalLearnersSnapshot.find(l => getIndex(l) === learnerIndex)?.[key];
        const currentValue = currentLearner[key];

        if (currentValue === originalValue) return;

        const addr = XLSX.utils.encode_cell({ r: rowNum, c });
        const val = currentValue ?? '';

        if (ws[addr]) {
            ws[addr].v = val;
            ws[addr].t = (typeof val === 'number') ? 'n' : 's';
        } else {
            const headerAddr = XLSX.utils.encode_cell({r: 0, c});
            const headerCell = ws[headerAddr];
            ws[addr] = { v: val, t: (typeof val === 'number') ? 'n' : 's' };
            if(headerCell && headerCell.s) {
                ws[addr].s = JSON.parse(JSON.stringify(headerCell.s));
            }
        }
      });
    });
  }

  function downloadUpdatedWorkbook() {
    if (!originalWb) return;
    setStatus('Generating Excel file...', 'warn');

    updateMarksInPlace();

    const ws = originalWb.Sheets[learnersSheetName];
    if (!ws) throw new Error('Learners worksheet missing at write time.');

    // --- FIDELITY PRESERVATION ---
    if (learnersSheetCols) ws['!cols'] = JSON.parse(JSON.stringify(learnersSheetCols));
    if (learnersSheetRows) ws['!rows'] = JSON.parse(JSON.stringify(learnersSheetRows));
    if (learnersSheetMerges) ws['!merges'] = JSON.parse(JSON.stringify(learnersSheetMerges));
    if (sheetSavedViews) ws['!views'] = JSON.parse(JSON.stringify(sheetSavedViews));

    if (originalWorkbookViews) {
      originalWb.Workbook = originalWb.Workbook || {};
      originalWb.Workbook.Views = JSON.parse(JSON.stringify(originalWorkbookViews));
    }
    if (originalWorkbookProps) {
      originalWb.Props = JSON.parse(JSON.stringify(originalWorkbookProps));
    }
    // --- END FIDELITY PRESERVATION ---

    const writeOpts = { bookType: 'xlsx', type: 'array', bookSST: true, cellStyles: true };
    const wbout = XLSX.write(originalWb, writeOpts);
    const blob = new Blob([wbout], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
    const filename = `REPORT_FORM_updated_${new Date().toISOString().slice(0, 10)}.xlsx`;
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = filename;
    document.body.appendChild(a); a.click();
    setTimeout(() => { URL.revokeObjectURL(url); a.remove(); }, 500);

    showUnsaved(false);
    toast('Downloaded updated Excel file', 'success');
    setStatus('Download complete ✓', 'ok');
  }
  
  const processFile = withErrorUI(async (file) => {
    if (!file) return;
    resetUI();
    setStatus('Reading file...', 'warn', file.name);

    const data = await file.arrayBuffer();

    const wb = XLSX.read(data, { type: 'array', cellStyles: true, bookSST: true });
    originalWb = wb;

    // --- CAPTURE VISUAL METADATA FOR FIDELITY ---
    originalWorkbookViews = wb.Workbook?.Views ? JSON.parse(JSON.stringify(wb.Workbook.Views)) : null;
    originalWorkbookProps = wb.Props ? JSON.parse(JSON.stringify(wb.Props)) : null;

    learnersSheetName = wb.SheetNames.find(n => n.toLowerCase() === 'learners') || wb.SheetNames[0];
    const wsLearners = wb.Sheets[learnersSheetName];
    if (!wsLearners) throw new Error("A worksheet named 'Learners' was not found.");

    learnersSheetCols = wsLearners['!cols'] ? JSON.parse(JSON.stringify(wsLearners['!cols'])) : null;
    learnersSheetRows = wsLearners['!rows'] ? JSON.parse(JSON.stringify(wsLearners['!rows'])) : null;
    learnersSheetMerges = wsLearners['!merges'] ? JSON.parse(JSON.stringify(wsLearners['!merges'])) : null;
    sheetSavedViews = wsLearners['!views'] ? JSON.parse(JSON.stringify(wsLearners['!views'])) : null;
    // --- END METADATA CAPTURE ---

    const headerRows = XLSX.utils.sheet_to_json(wsLearners, { header: 1, defval: '' });
    const learnerHeaders = headerRows?.[0] || [];
    headerIndexMap = {};
    learnerHeaders.forEach((h, i) => { headerIndexMap[String(h)] = i; });

    learners = XLSX.utils.sheet_to_json(wsLearners, { defval: '' });
    
    learners.forEach((learner, index) => { learner._rowNumber = index + 1; }); 
    originalLearnersSnapshot = learners.map(o => ({...o}));

    const wsGrading = wb.Sheets['Grading'] || wb.Sheets['grading'];
    if (wsGrading) {
        try {
            const gradingRows = XLSX.utils.sheet_to_json(wsGrading, { defval: '' });
            const mappedThresholds = gradingRows
                .map(r => ({ min: Number(r.Score), grade: String(r.Grade || r.grade || '').trim() }))
                .filter(r => !Number.isNaN(r.min) && r.grade);
            if (mappedThresholds.length >= 2) {
                thresholds = mappedThresholds.sort((a, b) => b.min - a.min);
            }
        } catch (e) {
            console.warn("Could not parse 'Grading' sheet, using defaults.", e);
            thresholds = DEFAULT_THRESHOLDS;
        }
    } else {
        thresholds = DEFAULT_THRESHOLDS;
    }

    $mainContent.style.display = 'block';
    $dropZone.querySelector('p').style.display = 'none';
    $filename.textContent = file.name;

    hydrateGrades();
    clearFilters(); 
    showUnsaved(false);

    toast('Workbook loaded successfully', 'success');
    setStatus(`Loaded ${learners.length} learners ✓`, 'Ready to edit or print.');
  });
  
  // --- Event Wiring ---
  function setupEventListeners() {
    // File Drop Zone
    $dropZone.addEventListener('click', () => $fileInput.click());
    $fileInput.addEventListener('change', (e) => processFile(e.target.files?.[0]));
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      $dropZone.addEventListener(eventName, e => { e.preventDefault(); e.stopPropagation(); });
    });
    $dropZone.addEventListener('dragenter', () => $dropZone.classList.add('dragover'));
    $dropZone.addEventListener('dragover', () => $dropZone.classList.add('dragover'));
    $dropZone.addEventListener('dragleave', () => $dropZone.classList.remove('dragover'));
    $dropZone.addEventListener('drop', (e) => {
      $dropZone.classList.remove('dragover');
      processFile(e.dataTransfer.files?.[0]);
    });

    // Main Actions
    $learnerSel.addEventListener('change', e => renderSelected(Number(e.target.value)));
    $phaseSel.addEventListener('change', () => { if (currentSelectedRow()) buildMarksGrid(currentSelectedRow()); });
    $savePhaseBtn.addEventListener('click', withErrorUI(savePhaseToLearner));
    $applyOutOfAllBtn.addEventListener('click', withErrorUI(applyOutOfToAllLearners));
    
    // Printing & Downloading
    $printSelectedBtn.addEventListener('click', () => { const row = currentSelectedRow(); if (row) printRows([row]); });
    $printFilteredBtn.addEventListener('click', () => printRows(filteredLearners));
    $downloadExcelLink.addEventListener('click', e => {
      if ($downloadExcelLink.getAttribute('aria-disabled') === 'true') {
        e.preventDefault();
        toast('No unsaved changes to download', 'warn');
      } else {
        withErrorUI(downloadUpdatedWorkbook)();
      }
    });

    // Filters
    $applyFiltersBtn.addEventListener('click', withErrorUI(applyFilters));
    $clearFiltersBtn.addEventListener('click', withErrorUI(clearFilters));
    
    // Dialogs
    $('#copyErrBtn').addEventListener('click', async () => {
      try { await navigator.clipboard.writeText($errDetails.textContent || ''); toast('Copied!', 'success', 1000); } catch (e) { alert('Copy failed.'); }
    });
    $('#closeErrBtn').addEventListener('click', () => $errorDlg.close());

    // Window Listeners
    window.addEventListener('afterprint', () => { $batchContainer.innerHTML = ''; setStatus('Ready', 'Idle.'); });
    window.addEventListener('error', (e) => withErrorUI(() => { throw e.error; })());
    window.addEventListener('unhandledrejection', (e) => withErrorUI(() => { throw e.reason; })());
  }

  // Initialize the application
  setupEventListeners();
})();
</script>
</body>
</html>
